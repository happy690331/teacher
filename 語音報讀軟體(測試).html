<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF è€ƒå·ç²¾æº–é»è®€ç³»çµ±</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- PDF.js viewer CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #525659;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #333; }
        ::-webkit-scrollbar-thumb { background: #666; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }

        /* PDF é é¢å®¹å™¨ */
        .pdf-page-wrapper {
            position: relative;
            margin: 20px auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            background-color: white;
        }

        /* Text Layer è¨­å®š */
        .textLayer {
            opacity: 1;
            mix-blend-mode: multiply;
        }

        .textLayer span {
            color: transparent;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        /* æ»‘é¼ ç¶“éå–®å€‹æ–‡å­—æ™‚çš„æç¤º (æ·ºç°) */
        .textLayer span:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* è¢«é¸ä¸­æœ—è®€çš„é¡Œç›® (ç²¾ç¢ºé»ƒè‰²é«˜äº®) */
        .textLayer span.reading-highlight {
            background-color: rgba(255, 240, 0, 0.5) !important; /* é¡¯çœ¼çš„é»ƒè‰² */
            box-shadow: 0 0 2px rgba(255, 200, 0, 0.5);
        }

        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal å‹•ç•« */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 0.2s, transform 0.2s; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- é ‚éƒ¨æµ®å‹•å·¥å…·åˆ— -->
    <header class="bg-gray-800 text-white shadow-md z-50 flex-none px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ“„</span>
            <h1 class="text-lg font-medium tracking-wide hidden md:block">è€ƒå·é»è®€æ¨¡å¼ (é›²ç«¯/æœ¬æ©Ÿç‰ˆ)</h1>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="statusMsg" class="text-sm text-gray-300 hidden flex items-center gap-2"></div>

            <button id="stopBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded shadow transition flex items-center gap-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg>
                åœæ­¢
            </button>

            <!-- é›²ç«¯é¡Œåº«æŒ‰éˆ• -->
            <button id="cloudBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded shadow transition text-sm font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.56 2.518l-.242.634-.679.135c-1.354.27-2.287 1.49-2.287 2.932 0 1.63 1.284 2.91 2.87 2.91h8.917c1.378 0 2.5-1.134 2.5-2.528 0-1.31-1.002-2.39-2.29-2.528l-.68-.073-.207-.638c-.378-1.166-1.427-1.928-2.613-1.928a3.73 3.73 0 0 0-3.323 1.558z"/>
                </svg>
                é›²ç«¯é¡Œåº«
            </button>

            <!-- æœ¬æ©Ÿä¸Šå‚³æŒ‰éˆ• -->
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded shadow transition text-sm font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                æœ¬æ©Ÿ PDF
                <input type="file" id="pdfUpload" accept="application/pdf" class="hidden" />
            </label>
        </div>
    </header>

    <!-- é›²ç«¯æª”æ¡ˆé¸æ“‡ Modal -->
    <div id="cloudModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col overflow-hidden transform transition-all scale-100">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                    <span class="text-indigo-500">â˜ï¸</span> é¸æ“‡é›²ç«¯è©¦å·
                </h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="fileListContainer" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center py-8 text-gray-400">æ­£åœ¨è¼‰å…¥æª”æ¡ˆåˆ—è¡¨...</div>
            </div>

            <div class="p-3 border-t border-gray-100 bg-gray-50 text-xs text-gray-500 text-center">
                è³‡æ–™ä¾†æº: github.com/happy690331
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-1 overflow-y-auto relative text-center py-8" id="mainContainer">
        <div id="pdfViewer" class="inline-block text-left">
            <!-- åˆå§‹ç•«é¢ -->
            <div class="mt-20 text-gray-400 text-center flex flex-col items-center">
                <div class="text-6xl mb-4 opacity-50">ğŸ‘†</div>
                <p class="text-xl">è«‹é¸æ“‡è©¦å·ä¾†æº</p>
                <div class="flex gap-4 mt-6">
                    <button onclick="document.getElementById('cloudBtn').click()" class="px-6 py-2 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 transition font-medium">â˜ï¸ é›²ç«¯é¡Œåº«</button>
                    <button onclick="document.getElementById('pdfUpload').click()" class="px-6 py-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition font-medium">ğŸ’» æœ¬æ©Ÿæª”æ¡ˆ</button>
                </div>
                <p class="text-sm mt-8 opacity-75 max-w-md">ç³»çµ±æœƒè‡ªå‹•åµæ¸¬é¸æ“‡é¡Œï¼Œé‡åˆ°ç©ºç™½æˆ–æ›è¡Œæœƒå¼·åˆ¶åœé “ä¸€ç§’ï¼Œé‡åˆ°â‘ â‘¡â‘¢â‘£æœƒå”¸å‡ºå°æ‡‰æ•¸å­—ã€‚</p>
            </div>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        const upload = document.getElementById("pdfUpload");
        const cloudBtn = document.getElementById("cloudBtn");
        const cloudModal = document.getElementById("cloudModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const fileListContainer = document.getElementById("fileListContainer");
        const pdfViewer = document.getElementById("pdfViewer");
        const stopBtn = document.getElementById("stopBtn");
        const statusMsg = document.getElementById("statusMsg");
        
        let currentUtterance = null;
        let globalSpanMap = [];
        let fullDocumentText = "";
        let parsedQuestions = [];
        let speakingTimeout = null; 
        let currentSequenceId = 0;

        // --- Event Listeners ---
        stopBtn.addEventListener("click", stopSpeaking);
        
        // 1. æœ¬æ©Ÿä¸Šå‚³
        upload.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const arrayBuffer = await file.arrayBuffer();
            loadPdf(arrayBuffer);
        });

        // 2. é›²ç«¯æŒ‰éˆ• & Modal æ§åˆ¶
        cloudBtn.addEventListener("click", () => {
            cloudModal.classList.remove("hidden");
            fetchGitHubFiles();
        });

        closeModalBtn.addEventListener("click", () => {
            cloudModal.classList.add("hidden");
        });

        cloudModal.addEventListener("click", (e) => {
            if (e.target === cloudModal) cloudModal.classList.add("hidden");
        });

        // --- Functions ---

        // å–å¾— GitHub æª”æ¡ˆåˆ—è¡¨
        async function fetchGitHubFiles() {
            const repoOwner = 'happy690331';
            const repoName = 'teacher';
            const path = 'exam paper';
            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${encodeURIComponent(path)}`;

            fileListContainer.innerHTML = `<div class="flex justify-center py-8"><div class="loader border-indigo-500"></div></div>`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('ç„¡æ³•è®€å–é›²ç«¯åˆ—è¡¨');
                
                const data = await response.json();
                
                // éæ¿¾ PDF æª”æ¡ˆ
                const pdfFiles = data.filter(file => file.name.toLowerCase().endsWith('.pdf'));

                if (pdfFiles.length === 0) {
                    fileListContainer.innerHTML = '<div class="text-center py-4 text-gray-500">æ­¤è³‡æ–™å¤¾æ²’æœ‰ PDF æª”æ¡ˆ</div>';
                    return;
                }

                fileListContainer.innerHTML = '';
                pdfFiles.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'p-3 hover:bg-indigo-50 rounded-lg cursor-pointer transition flex items-center gap-3 border-b border-gray-50 last:border-0';
                    item.innerHTML = `
                        <span class="text-red-500 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/><path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.545-.094.145-.096.25-.04.361.01.022.02.036.026.044a.266.266 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.604zm1.649-1.055a22.95 22.95 0 0 1-.71 1.84c.356.33.691.431.97.431.282 0 .484-.131.606-.317.032-.049.042-.102.04-.151a.26.26 0 0 0-.018-.057c-.03-.092-.15-.22-.395-.348-.194-.102-.454-.175-.76-.233a10.02 10.02 0 0 1-.733-1.165zm.365-4.57c-.03.208-.046.387-.046.535.003.116.032.203.076.263.033.045.07.085.114.116.04.029.08.05.114.053.05.003.102-.012.144-.044.038-.029.055-.067.058-.093.003-.035-.005-.122-.047-.39-.033-.212-.086-.53-.16-.948a2.536 2.536 0 0 0-.253.508zm.296 2.37c.075-.24.135-.502.176-.777a12.715 12.715 0 0 0-.918-.035 15.65 15.65 0 0 1-.36 1.488c.325-.268.68-.498 1.102-.676z"/></svg>
                        </span>
                        <span class="text-sm font-medium text-gray-700 truncate w-full">${file.name}</span>
                    `;
                    item.onclick = () => {
                        cloudModal.classList.add("hidden");
                        loadPdf(file.download_url); // å‚³å…¥ URL
                    };
                    fileListContainer.appendChild(item);
                });

            } catch (err) {
                console.error(err);
                fileListContainer.innerHTML = `<div class="text-center py-4 text-red-400">ç„¡æ³•è¼‰å…¥åˆ—è¡¨<br/><span class="text-xs">${err.message}</span></div>`;
            }
        }

        // --- æ ¸å¿ƒè¼‰å…¥é‚è¼¯ (çµ±ä¸€å…¥å£) ---
        async function loadPdf(source) {
            // Reset UI & State
            pdfViewer.innerHTML = "";
            globalSpanMap = [];
            fullDocumentText = "";
            parsedQuestions = [];
            stopSpeaking();
            showLoading(true, "æ­£åœ¨ä¸‹è¼‰/è§£ææª”æ¡ˆ...");

            try {
                // PDF.js getDocument æ”¯æ´ ArrayBuffer æˆ– URL
                const loadingTask = pdfjsLib.getDocument(source);
                const pdfDoc = await loadingTask.promise;
                
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    showLoading(true, `æ­£åœ¨è™•ç†ç¬¬ ${i} / ${pdfDoc.numPages} é ...`);
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    await renderPageAndMapText(page, textContent, i);
                }

                // é–‹å§‹è§£æé¡Œç›®
                parseQuestionsFromFullText(fullDocumentText);
                
                if (parsedQuestions.length === 0) {
                    showError("æ‰¾ä¸åˆ°é¡Œç›®ã€‚è«‹ç¢ºèªæ ¼å¼ç‚ºã€Œæ•¸å­—.ã€æˆ–ã€Œæ•¸å­—ã€ã€é–‹é ­ã€‚");
                } else {
                    showLoading(false);
                    statusMsg.innerHTML = `<span class="text-green-400">âœ“ æº–å‚™å®Œæˆï¼Œå…±è§£æå‡º ${parsedQuestions.length} é¡Œ</span>`;
                    statusMsg.classList.remove("hidden");
                    setTimeout(() => statusMsg.classList.add("hidden"), 3000);
                    console.log("Parsed Questions:", parsedQuestions);
                }

            } catch (err) {
                console.error(err);
                showError("éŒ¯èª¤: " + err.message);
            }
        }

        async function renderPageAndMapText(page, textContent, pageNum) {
            const scale = 1.5;
            const viewport = page.getViewport({ scale: scale });

            const pageWrapper = document.createElement("div");
            pageWrapper.className = "pdf-page-wrapper";
            pageWrapper.style.width = `${viewport.width}px`;
            pageWrapper.style.height = `${viewport.height}px`;

            const canvas = document.createElement("canvas");
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.style.width = "100%";
            canvas.style.height = "100%";
            
            const textLayerDiv = document.createElement("div");
            textLayerDiv.className = "textLayer";
            textLayerDiv.style.width = `${viewport.width}px`;
            textLayerDiv.style.height = `${viewport.height}px`;
            textLayerDiv.style.setProperty("--scale-factor", scale);

            pageWrapper.appendChild(canvas);
            pageWrapper.appendChild(textLayerDiv);
            pdfViewer.appendChild(pageWrapper);

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            await pdfjsLib.renderTextLayer({
                textContentSource: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: []
            }).promise;

            const spanElements = textLayerDiv.querySelectorAll("span");
            spanElements.forEach((span) => {
                const text = span.textContent;
                const startIndex = fullDocumentText.length;
                fullDocumentText += text;
                const endIndex = fullDocumentText.length;

                globalSpanMap.push({
                    text: text,
                    startIndex: startIndex,
                    endIndex: endIndex,
                    element: span
                });
            });
            fullDocumentText += "\n"; 
        }

        function parseQuestionsFromFullText(text) {
            const regexStart = /(\d+[\.ã€ï¼])/g;
            const matches = [...text.matchAll(regexStart)];
            
            for (let i = 0; i < matches.length; i++) {
                const currentMatch = matches[i];
                const startIdx = currentMatch.index;
                const nextMatch = matches[i + 1];
                let limitIdx = text.length; 
                
                if (nextMatch) {
                    limitIdx = nextMatch.index;
                }

                parsedQuestions.push({
                    text: text.slice(startIdx, limitIdx),
                    startIndex: startIdx,
                    endIndex: limitIdx
                });
            }
        }

        document.addEventListener("click", (e) => {
            if (e.target.tagName === 'SPAN' && e.target.closest('.textLayer')) {
                handleSpanClick(e.target);
            }
        });

        function handleSpanClick(clickedSpan) {
            const spanData = globalSpanMap.find(item => item.element === clickedSpan);
            if (!spanData) return;

            const matchedQuestion = parsedQuestions.find(q => 
                spanData.startIndex >= q.startIndex && 
                spanData.startIndex < q.endIndex
            );

            if (matchedQuestion) {
                console.log("æœ—è®€é¡Œç›®ç¯„åœ:", matchedQuestion.text);
                
                let fullText = matchedQuestion.text.trim();
                let questionNumberText = "";
                let contentText = fullText;

                // 1. åˆ†é›¢é¡Œè™Ÿ (ä¾‹å¦‚ "1." -> "ç¬¬ä¸€é¡Œ")
                const numberMatch = fullText.match(/^(\d+)[\.ã€ï¼]/);
                
                if (numberMatch) {
                    const num = numberMatch[1];
                    questionNumberText = `ç¬¬${num}é¡Œï¼Œ`;
                    contentText = fullText.substring(numberMatch[0].length);
                }

                // 2. å…§å®¹ä¸­çš„é¸é …è™•ç† (â‘  -> \nä¸€)
                // é€™è£¡åœ¨æ•¸å­—å‰åŠ ä¸Š \nï¼Œåˆ©ç”¨ split é‚è¼¯å°‡å…¶åˆ‡åˆ†ç‚ºæ–°æ®µè½
                // é€™æ¨£å‰ä¸€æ®µçµæŸå¾Œå°±æœƒç”¢ç”Ÿ 1ç§’ çš„ postDelayï¼Œé”æˆã€Œå”¸æ•¸å­—å‰åœé “ã€çš„æ•ˆæœ
                contentText = contentText.replace(/â‘ |â‘´|\(1\)|ï¼ˆ1ï¼‰/g, `\nä¸€`);
                contentText = contentText.replace(/â‘¡|â‘µ|\(2\)|ï¼ˆ2ï¼‰/g, `\näºŒ`);
                contentText = contentText.replace(/â‘¢|â‘¶|\(3\)|ï¼ˆ3ï¼‰/g, `\nä¸‰`);
                contentText = contentText.replace(/â‘£|â‘·|\(4\)|ï¼ˆ4ï¼‰/g, `\nå››`);

                // 3. å»ºç«‹æ’­æ”¾åºåˆ—
                const speechQueue = [];
                
                // (A) å¦‚æœæœ‰æŠ“åˆ°é¡Œè™Ÿï¼ŒåŠ å…¥åºåˆ—
                if (questionNumberText) {
                    speechQueue.push({ text: questionNumberText, rate: 0.6, postDelay: 500 });
                }
                
                // (B) å¼·åˆ¶æ ¹æ“šã€Œä»»ä½•ç©ºç™½ã€æˆ–ã€Œæ›è¡Œã€åˆ‡å‰²
                const segments = contentText.split(/[\s\n\u3000]+/);
                
                segments.forEach(seg => {
                    const trimmedSeg = seg.trim();
                    if (trimmedSeg) {
                        speechQueue.push({ 
                            text: trimmedSeg, 
                            rate: 1.0,
                            postDelay: 1000 // æ¯ä¸€æ®µçµæŸå¼·åˆ¶åœé “1ç§’
                        });
                    }
                });

                // åŸ·è¡Œåºåˆ—æ’­æ”¾
                speakSequence(speechQueue);

                // é«˜äº®æ•´é¡Œ
                highlightRange(matchedQuestion.startIndex, matchedQuestion.endIndex);
            } else {
                // å¦‚æœé»æ“Šçš„åœ°æ–¹ä¸åœ¨è§£æçš„é¡Œç›®ç¯„åœå…§
                speakSequence([{ text: clickedSpan.textContent, rate: 1.0 }]);
                
                clickedSpan.classList.add("reading-highlight");
                setTimeout(() => clickedSpan.classList.remove("reading-highlight"), 500);
            }
        }

        function highlightRange(qStart, qEnd) {
            document.querySelectorAll(".reading-highlight").forEach(el => el.classList.remove("reading-highlight"));
            globalSpanMap.forEach(item => {
                const intersectionStart = Math.max(item.startIndex, qStart);
                const intersectionEnd = Math.min(item.endIndex, qEnd);
                if (intersectionStart < intersectionEnd) {
                    item.element.classList.add("reading-highlight");
                }
            });
        }

        // åºåˆ—æ’­æ”¾ (æ”¯æ´ postDelay åœé “ + Sequence ID é˜²è¡çª)
        function speakSequence(items) {
            stopSpeaking(); // é€™æœƒè®“ currentSequenceId éå¢
            
            if (!items || items.length === 0) return;

            const mySequenceId = currentSequenceId;
            let currentIndex = 0;

            function playNext() {
                if (mySequenceId !== currentSequenceId) return;

                if (currentIndex >= items.length) {
                    checkIfSpeakingStopped();
                    return;
                }

                const item = items[currentIndex];
                
                if (!item.text || !item.text.trim()) {
                    currentIndex++;
                    playNext();
                    return;
                }

                const u = new SpeechSynthesisUtterance(item.text);
                currentUtterance = u; 
                
                u.lang = "zh-TW";
                u.rate = item.rate || 1.0; 
                
                const voices = speechSynthesis.getVoices();
                const zhVoice = voices.find(v => v.lang === "zh-TW" || v.lang === "zh-HK" || v.lang.includes("zh"));
                if (zhVoice) u.voice = zhVoice;

                u.onstart = () => {
                    if (mySequenceId === currentSequenceId) {
                        stopBtn.classList.remove("hidden");
                    }
                };
                
                u.onend = () => {
                    if (mySequenceId !== currentSequenceId) return; 

                    if (item.postDelay) {
                        speakingTimeout = setTimeout(() => {
                            if (mySequenceId !== currentSequenceId) return; 
                            currentIndex++;
                            playNext();
                        }, item.postDelay);
                    } else {
                        currentIndex++;
                        playNext();
                    }
                };

                u.onerror = (e) => {
                    if (e.error === 'interrupted' || e.error === 'canceled') return;
                    console.warn("Speech skipped due to error:", e.error);
                    if (mySequenceId === currentSequenceId) {
                        currentIndex++;
                        playNext();
                    }
                };

                speechSynthesis.speak(u);
            }

            playNext();
        }

        function stopSpeaking() {
            currentSequenceId++;
            speechSynthesis.cancel();
            currentUtterance = null;
            if (speakingTimeout) {
                clearTimeout(speakingTimeout);
                speakingTimeout = null;
            }
            stopBtn.classList.add("hidden");
            document.querySelectorAll(".reading-highlight").forEach(el => el.classList.remove("reading-highlight"));
        }

        function checkIfSpeakingStopped() {
            if (!speechSynthesis.speaking) stopBtn.classList.add("hidden");
        }

        function showLoading(show, text = "") {
            statusMsg.classList.remove("hidden", "text-red-400");
            if (show) {
                statusMsg.innerHTML = `<div class="loader"></div> <span>${text}</span>`;
                statusMsg.classList.remove("hidden");
            } else {
                statusMsg.classList.add("hidden");
            }
        }

        function showError(msg) {
            statusMsg.innerHTML = `âš ï¸ ${msg}`;
            statusMsg.classList.remove("hidden");
            statusMsg.classList.add("text-red-400");
        }

        if (typeof speechSynthesis !== 'undefined') {
            speechSynthesis.onvoiceschanged = () => {};
        }
    </script>
</body>
</html>