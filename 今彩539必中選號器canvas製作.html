import React, { useState, useEffect, useMemo, useRef } from 'react';
import { Settings, Calculator, Trash2, Download, Upload, BarChart3, Ticket, AlertCircle, CheckCircle2 } from 'lucide-react';

/**
 * 今彩539 參數設定
 */
const TOTAL_NUMS = 39;
const PICK_NUMS = 5;

/**
 * 數學工具函式庫
 */
const MathUtils = {
  // 檢查是否包含 N 連號
  hasConsecutive: (arr, n) => {
    let count = 1;
    for (let i = 0; i < arr.length - 1; i++) {
      if (arr[i + 1] === arr[i] + 1) {
        count++;
        if (count >= n) return true;
      } else {
        count = 1;
      }
    }
    return false;
  },

  // 檢查是否為等差數列
  isArithmetic: (arr) => {
    if (arr.length < 2) return false;
    const diff = arr[1] - arr[0];
    for (let i = 2; i < arr.length; i++) {
      if (arr[i] - arr[i - 1] !== diff) return false;
    }
    return true;
  },

  // 檢查是否接近等差 (寬容度：容許由 4 個數字組成等差，或是差值的標準差極小)
  // 這裡採用簡單定義：若其中有 4 個數字構成等差數列，則視為「接近等差」
  isNearArithmetic: (arr) => {
    // 檢查任意 4 個數字的組合是否為等差
    // 5取4有5種組合
    const subsets = [
      [arr[0], arr[1], arr[2], arr[3]],
      [arr[0], arr[1], arr[2], arr[4]],
      [arr[0], arr[1], arr[3], arr[4]],
      [arr[0], arr[2], arr[3], arr[4]],
      [arr[1], arr[2], arr[3], arr[4]]
    ];
    return subsets.some(sub => MathUtils.isArithmetic(sub));
  },

  // 大小比 (小: 1-19, 大: 20-39)
  // 回傳 true 代表「過度集中」(即 5:0 或 0:5)
  isExtremeHighLow: (arr) => {
    const smallCount = arr.filter(n => n <= 19).length;
    return smallCount === 0 || smallCount === 5;
  },

  // 奇偶比 (Acceptable: 2:3 or 3:2)
  isValidOddEven: (arr) => {
    const oddCount = arr.filter(n => n % 2 !== 0).length;
    return oddCount === 2 || oddCount === 3;
  }
};

const App = () => {
  // --- State ---
  const [allCombinations, setAllCombinations] = useState([]);
  const [filteredCount, setFilteredCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [results, setResults] = useState([]);
  
  // Filters State
  const [filters, setFilters] = useState({
    avoidConsecutive3: true,
    avoidConsecutive4: true,
    avoidConsecutive5: true,
    avoidArithmetic: true,
    avoidNearArithmetic: false,
    avoidHistoryDuplicate: true,
    avoidExtremeHighLow: true,
    limitOddEven: true,
    avoidHotNumbers: false
  });

  // Data Inputs
  const [historyInput, setHistoryInput] = useState("");
  const [parsedHistory, setParsedHistory] = useState([]);
  const [hotNumbers, setHotNumbers] = useState([]);
  
  // Selection
  const [generateCount, setGenerateCount] = useState(5);

  const fileInputRef = useRef(null);

  // --- Initialization ---

  // 1. 生成所有組合 (只執行一次)
  useEffect(() => {
    const generateAll = () => {
      const combos = [];
      const f = (start, depth, current) => {
        if (depth === PICK_NUMS) {
          combos.push([...current]);
          return;
        }
        for (let i = start; i <= TOTAL_NUMS; i++) {
          current.push(i);
          f(i + 1, depth + 1, current);
          current.pop();
        }
      };
      f(1, 0, []);
      return combos;
    };

    setTimeout(() => {
      const all = generateAll();
      setAllCombinations(all);
      setFilteredCount(all.length);
      setIsLoading(false);
    }, 100);
  }, []);

  // 2. 解析歷史數據與計算熱號
  useEffect(() => {
    if (!historyInput.trim()) {
      setParsedHistory([]);
      setHotNumbers([]);
      return;
    }

    const lines = historyInput.split(/\n/);
    const validHistory = [];
    const frequency = Array(40).fill(0); // Index 1-39

    lines.forEach(line => {
      // 支援逗號、空格分隔
      const nums = line.trim().split(/[,，\s]+/).map(Number).filter(n => n >= 1 && n <= 39);
      if (nums.length === 5) {
        // 排序以方便比對
        nums.sort((a, b) => a - b);
        validHistory.push(nums);
        nums.forEach(n => frequency[n]++);
      }
    });

    setParsedHistory(validHistory);

    // 如果沒有有效歷史紀錄，就不計算熱號
    if (validHistory.length === 0) {
      setHotNumbers([]);
      return;
    }

    // 找出前 5 個熱門號碼
    const mappedFreq = frequency.map((count, num) => ({ num, count }));
    // 移除 index 0
    mappedFreq.shift(); 
    
    // 只取有出現過的號碼進行排序
    const activeNums = mappedFreq.filter(item => item.count > 0);
    activeNums.sort((a, b) => b.count - a.count);
    
    // 取前 5 名作為「熱號」定義
    const topHot = activeNums.slice(0, 5).map(o => o.num);
    setHotNumbers(topHot);

  }, [historyInput]);

  // --- Core Logic ---

  const calculateFilteredPool = useMemo(() => {
    if (allCombinations.length === 0) return [];

    // 歷史組合 Set (轉成字串比較快)
    const historySet = new Set(parsedHistory.map(h => h.join(',')));

    return allCombinations.filter(combo => {
      // 1. 連號過濾
      if (filters.avoidConsecutive3 && MathUtils.hasConsecutive(combo, 3)) return false;
      if (filters.avoidConsecutive4 && MathUtils.hasConsecutive(combo, 4)) return false;
      if (filters.avoidConsecutive5 && MathUtils.hasConsecutive(combo, 5)) return false;

      // 2. 等差過濾
      if (filters.avoidArithmetic && MathUtils.isArithmetic(combo)) return false;
      if (filters.avoidNearArithmetic && MathUtils.isNearArithmetic(combo)) return false;

      // 3. 歷史重複
      if (filters.avoidHistoryDuplicate && historySet.has(combo.join(','))) return false;

      // 4. 大小比 (避開全大或全小)
      if (filters.avoidExtremeHighLow && MathUtils.isExtremeHighLow(combo)) return false;

      // 5. 奇偶比 (限制 2:3 或 3:2)
      if (filters.limitOddEven && !MathUtils.isValidOddEven(combo)) return false;

      // 6. 避開熱號 (若組合中包含任何熱號則剔除？太嚴格。這裡設定：若包含超過 2 個熱號則剔除)
      if (filters.avoidHotNumbers) {
        const hotCount = combo.filter(n => hotNumbers.includes(n)).length;
        if (hotCount >= 2) return false; // 嚴格度可調整，這裡設為不能超過1個熱號
      }

      return true;
    });
  }, [allCombinations, filters, parsedHistory, hotNumbers]);

  useEffect(() => {
    setFilteredCount(calculateFilteredPool.length);
  }, [calculateFilteredPool]);


  // --- Handlers ---

  const handleGenerate = () => {
    if (calculateFilteredPool.length === 0) {
      alert("條件太嚴苛，沒有剩餘組合！");
      return;
    }
    
    const selected = [];
    const pool = [...calculateFilteredPool];
    
    // 隨機抽取 N 個
    for (let i = 0; i < generateCount; i++) {
      if (pool.length === 0) break;
      const randomIndex = Math.floor(Math.random() * pool.length);
      selected.push(pool[randomIndex]);
      // 避免重複選取同一組 (雖然機率低)
      pool.splice(randomIndex, 1);
    }
    setResults(selected);
  };

  const handleCSVUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      setHistoryInput(event.target.result);
    };
    reader.readAsText(file);
  };

  const handleToggleFilter = (key) => {
    setFilters(prev => ({ ...prev, [key]: !prev[key] }));
  };

  const loadDemoData = () => {
    // 模擬一些歷史數據
    const demo = "01,05,12,23,34\n02,08,15,22,30\n05,06,07,20,29\n10,12,14,35,38\n01,02,03,04,05";
    setHistoryInput(demo);
  };

  return (
    <div className="min-h-screen bg-slate-900 text-slate-100 font-sans selection:bg-yellow-500 selection:text-slate-900">
      
      {/* Header */}
      <header className="bg-slate-800 border-b border-slate-700 p-6 sticky top-0 z-10 shadow-lg">
        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-3">
            <div className="bg-yellow-500 p-2 rounded-lg text-slate-900">
              <Calculator size={28} strokeWidth={2.5} />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-yellow-500 tracking-wider">今彩539 必中神算</h1>
              <p className="text-xs text-slate-400">機率優化與歷史數據分析系統</p>
            </div>
          </div>
          
          <div className="flex items-center gap-4 text-sm font-mono">
            <div className="bg-slate-900 px-4 py-2 rounded border border-slate-700">
              總組合: <span className="text-slate-400">575,757</span>
            </div>
            <div className="bg-slate-900 px-4 py-2 rounded border border-yellow-500/30 text-yellow-400">
              符合條件: {isLoading ? "計算中..." : filteredCount.toLocaleString()}
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* Left Column: Filters */}
        <div className="lg:col-span-5 space-y-6">
          <div className="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
            <div className="flex items-center gap-2 mb-4 text-yellow-400">
              <Settings size={20} />
              <h2 className="font-bold text-lg">過濾條件設定</h2>
            </div>
            
            {/* 改為兩欄 Grid 排版 - 強制兩欄 */}
            <div className="grid grid-cols-2 gap-3">
              {[
                { key: 'avoidConsecutive3', label: '避開 3 連號', note: '如 1,2,3' },
                { key: 'avoidConsecutive4', label: '避開 4 連號', note: '' },
                { key: 'avoidConsecutive5', label: '避開 5 連號', note: '' },
                { key: 'avoidArithmetic', label: '避開等差數列', note: '如 2,4,6,8,10' },
                { key: 'avoidNearArithmetic', label: '避開接近等差', note: '任意4碼成等差' },
                { key: 'avoidHistoryDuplicate', label: '避開歷史重複', note: '需輸入歷史資料' },
                { key: 'avoidExtremeHighLow', label: '避開極端大小', note: '排除全大/小' },
                { key: 'limitOddEven', label: '奇偶比例限制', note: '2:3 或 3:2' },
                { key: 'avoidHotNumbers', label: '避開高頻熱號', note: '排除>2個熱號' },
              ].map(item => (
                <div 
                  key={item.key}
                  onClick={() => handleToggleFilter(item.key)}
                  className={`
                    flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all border h-full
                    ${filters[item.key] 
                      ? 'bg-blue-600/20 border-blue-500/50 hover:bg-blue-600/30' 
                      : 'bg-slate-700/30 border-slate-700 hover:bg-slate-700/50'}
                  `}
                >
                  <div className="flex flex-col overflow-hidden">
                    <span className={`font-medium truncate ${filters[item.key] ? 'text-blue-300' : 'text-slate-400'}`}>
                      {item.label}
                    </span>
                    {item.note && <span className="text-[10px] text-slate-500 truncate">{item.note}</span>}
                  </div>
                  {filters[item.key] && <CheckCircle2 size={16} className="text-blue-400 shrink-0 ml-1" />}
                </div>
              ))}
            </div>
          </div>

          <div className="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
             <div className="flex items-center gap-2 mb-4 text-orange-400">
              <BarChart3 size={20} />
              <h2 className="font-bold text-lg">熱號分析 (Top 5)</h2>
            </div>
            {hotNumbers.length > 0 ? (
              <div className="flex flex-wrap gap-2">
                {hotNumbers.map(num => (
                  <span key={num} className="w-8 h-8 flex items-center justify-center bg-orange-500/20 text-orange-400 border border-orange-500/50 rounded-full font-bold text-sm">
                    {num.toString().padStart(2, '0')}
                  </span>
                ))}
              </div>
            ) : (
              <p className="text-sm text-slate-500">請輸入或匯入歷史資料以分析熱門號碼。</p>
            )}
          </div>
        </div>

        {/* Middle & Right Column */}
        <div className="lg:col-span-7 space-y-6">
          
          {/* Data Input Section */}
          <div className="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
            <div className="flex flex-wrap items-center justify-between mb-4 gap-4">
              <div className="flex items-center gap-2 text-emerald-400">
                <Upload size={20} />
                <h2 className="font-bold text-lg">歷史資料匯入</h2>
              </div>
              <div className="flex gap-2">
                 <button 
                  onClick={loadDemoData}
                  className="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition-colors"
                >
                  載入範例
                </button>
                <button 
                  onClick={() => fileInputRef.current.click()}
                  className="px-3 py-1.5 text-xs bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 border border-emerald-500/30 rounded transition-colors flex items-center gap-1"
                >
                  <Upload size={14} /> 匯入 CSV
                </button>
                <input 
                  type="file" 
                  accept=".csv,.txt" 
                  ref={fileInputRef} 
                  onChange={handleCSVUpload} 
                  className="hidden" 
                />
              </div>
            </div>

            <textarea
              value={historyInput}
              onChange={(e) => setHistoryInput(e.target.value)}
              placeholder={`請輸入歷史號碼，格式範例：\n01, 05, 12, 23, 34\n02 08 15 22 30`}
              className="w-full h-32 bg-slate-900 border border-slate-700 rounded-lg p-3 font-mono text-sm focus:outline-none focus:border-yellow-500 text-slate-300"
            />
            <div className="mt-2 text-right text-xs text-slate-500">
              已辨識 {parsedHistory.length} 筆有效歷史紀錄
            </div>
          </div>

          {/* Action & Results Section */}
          <div className="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700 min-h-[400px]">
            <div className="flex flex-col md:flex-row items-center justify-between gap-6 mb-8 border-b border-slate-700 pb-6">
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2">
                   <label className="text-sm text-slate-400">產生組數:</label>
                   <select 
                    value={generateCount} 
                    onChange={(e) => setGenerateCount(Number(e.target.value))}
                    className="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white focus:outline-none focus:border-yellow-500 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900"
                    style={{ maxHeight: '200px' }}
                   >
                     {/* 產生 1-20 的選項 */}
                     {Array.from({ length: 20 }, (_, i) => i + 1).map(n => (
                       <option key={n} value={n}>{n} 組</option>
                     ))}
                   </select>
                </div>
                <button 
                  onClick={() => { setResults([]); }}
                  className="flex items-center gap-1 text-slate-400 hover:text-white transition-colors text-sm"
                >
                  <Trash2 size={16} /> 清除
                </button>
              </div>

              <button
                onClick={handleGenerate}
                disabled={isLoading}
                className="w-full md:w-auto bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-400 hover:to-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full shadow-lg shadow-yellow-500/20 transform active:scale-95 transition-all flex items-center justify-center gap-2"
              >
                <Ticket size={24} />
                {isLoading ? "系統初始化中..." : "抽出最有機會中獎組合"}
              </button>
            </div>

            {/* Results Grid */}
            <div className="space-y-4">
              {results.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                  {results.map((combo, idx) => (
                    <div key={idx} className="bg-slate-900 p-4 rounded-lg border border-slate-700 flex items-center justify-between group hover:border-yellow-500/50 transition-colors">
                      <div className="flex items-center gap-3 font-mono text-xl text-yellow-400 font-bold tracking-wider">
                         <span className="text-slate-600 text-sm w-6">#{idx + 1}</span>
                         {combo.map(n => n.toString().padStart(2, '0')).join('  ')}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="h-64 flex flex-col items-center justify-center text-slate-600 gap-4">
                  <div className="w-16 h-16 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                    <Ticket size={32} />
                  </div>
                  <p>設定條件並點擊按鈕開始選號</p>
                </div>
              )}
            </div>

             {results.length > 0 && (
                <div className="mt-8 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded text-xs text-yellow-200/70 flex items-start gap-2">
                  <AlertCircle size={16} className="shrink-0 mt-0.5" />
                  <p>
                    免責聲明：本程式僅為數學與統計輔助工具，「必中」為功能目標名稱而非法律承諾。
                    彩券為機率遊戲，過濾條件能刪除歷史上低機率出現的怪異組合（如 1,2,3,4,5），
                    但無法保證特定號碼必定開出。請量力而為。
                  </p>
                </div>
             )}

          </div>
        </div>
      </main>
    </div>
  );
};

export default App;