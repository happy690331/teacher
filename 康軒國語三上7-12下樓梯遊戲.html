<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº·è»’åœ‹èªä¸‰ä¸Š7-12èª²å°æœ‹å‹ä¸‹æ¨“æ¢¯</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* ä»‹é¢å®¹å™¨ */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #ffffff;
            border: 8px solid #334155;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 15px;
            width: 100%;
            max-width: 480px;
            box-sizing: border-box;
            position: relative;
            margin-bottom: 50px;
        }

        h1 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 1.2rem;
            text-shadow: 1px 1px 0 #94a3b8;
            text-align: center;
            line-height: 1.4;
        }

        /* å…±ç”¨çš„ç£šç‰†æ¨£å¼ */
        .brick-bg {
            background-color: #8b4513;
            background-image: 
                linear-gradient(335deg, #a0522d 23px, transparent 23px),
                linear-gradient(155deg, #a0522d 23px, transparent 23px),
                linear-gradient(335deg, #a0522d 23px, transparent 23px),
                linear-gradient(155deg, #a0522d 23px, transparent 23px);
            background-size: 58px 58px;
            /* åˆå§‹èƒŒæ™¯ä½ç½®ï¼ŒJS æœƒå‹•æ…‹ä¿®æ”¹é€™å€‹å€¼ä¾†è£½é€ ç§»å‹•æ•ˆæœ */
            background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;
            border: 4px solid #1e293b;
            border-radius: 8px;
        }

        /* èª²ç¨‹é¸æ“‡ç•«é¢ */
        #setupView {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            box-sizing: border-box;
            color: white; /* åœ¨ç£šç‰†ä¸Šæ–‡å­—æ”¹ç‚ºç™½è‰² */
        }

        .lesson-grid {
            display: grid;
            grid-template-columns: 1fr; /* æ”¹ç‚ºå–®åˆ—ä»¥å®¹ç´é•·æ¨™é¡Œ */
            gap: 10px;
            width: 100%;
        }

        .lesson-item {
            background: rgba(255, 255, 255, 0.9); /* åŠé€æ˜ç™½åº•ï¼Œè®“æ–‡å­—æ¸…æ¥š */
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: #334155;
            font-size: 1rem;
        }

        .lesson-item:hover {
            border-color: #4f46e5;
            background: #ffffff;
        }

        /* éŠæˆ²ç•«é¢ */
        #gameView {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        #gameCanvas {
            margin: 5px 0;
            touch-action: none;
            width: 100%;
            max-width: 380px;
            height: 500px;
            /* background-image ç”± .brick-bg æä¾› */
        }

        .score-panel {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 5px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #334155;
            margin-bottom: 5px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        button {
            background-color: #4f46e5;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }

        button:active { transform: translateY(2px); }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }

        .btn-green { background-color: #10b981; }
        .btn-orange { background-color: #f59e0b; }

        /* å¹³æ¿å°ˆç”¨åº•éƒ¨æŒ‰éˆ• */
        .tablet-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .control-btn {
            width: 100px;
            height: 80px;
            background-color: #334155;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 6px #1e293b;
            user-select: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .control-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #1e293b;
            background-color: #1e293b;
        }

        /* è¨Šæ¯è¦†è“‹å±¤ */
        .message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 30;
            border-radius: 16px;
        }

        .message-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            width: 90%; /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´æ©«å‘æŒ‰éˆ• */
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* ä¿®æ”¹ï¼šé¸é …å®¹å™¨æ”¹ç‚ºæ©«å‘æ’åˆ— */
        #quizOptions {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 8px;
            width: 100%;
            margin-top: 15px;
        }

        /* ä¿®æ”¹ï¼šæŒ‰éˆ•æ¨£å¼èª¿æ•´ç‚ºé©åˆæ©«æ’ */
        .quiz-btn {
            background-color: #f1f5f9;
            color: #1e293b;
            padding: 8px 4px; /* æ¸›å°‘å…§é‚Šè· */
            border: 2px solid #cbd5e1;
            font-size: 0.95rem; /* å­—é«”ç¨å¾®èª¿å°ä»¥é©æ‡‰çª„å¯¬åº¦ */
            flex: 1; /* å¹³å‡åˆ†é…å¯¬åº¦ */
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50px; /* ç¢ºä¿é»æ“Šé«˜åº¦ */
            word-break: break-all; /* é˜²æ­¢é•·è©æ’ç ´ */
            line-height: 1.2;
        }
        
        .quiz-btn:hover { background-color: #e2e8f0; }

        .quiz-question-text {
            font-size: 1.1rem;
            color: #4f46e5;
            font-weight: 700;
            margin: 10px 0;
            line-height: 1.5;
            text-align: left;
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>åº·è»’åœ‹èªä¸‰ä¸Š7-12èª²å°æœ‹å‹ä¸‹æ¨“æ¢¯</h1>

        <!-- ç•«é¢ä¸€ï¼šè¨­å®š (å¥—ç”¨ç£šç‰†èƒŒæ™¯æ¨£å¼) -->
        <div id="setupView" class="brick-bg">
            <p style="color: #ffffff; font-weight: bold; text-shadow: 1px 1px 2px black;">è«‹å‹¾é¸ç·´ç¿’èª²æ¬¡ï¼š</p>
            <div class="lesson-grid">
                <label class="lesson-item"><input type="checkbox" value="7" checked> ç¬¬ä¸ƒèª² æ·¡æ°´å°é®</label>
                <label class="lesson-item"><input type="checkbox" value="8"> ç¬¬å…«èª² å®‰å¹³å¤å ¡åƒè§€è¨˜</label>
                <label class="lesson-item"><input type="checkbox" value="9"> ç¬¬ä¹èª² é¦¬å¤ªéçš„å·´æ‹‰å‘Š</label>
                <label class="lesson-item"><input type="checkbox" value="10"> ç¬¬åèª² ç‹ç‹¸çš„æ•…äº‹</label>
                <label class="lesson-item"><input type="checkbox" value="11"> ç¬¬åä¸€èª² å·¨äººçš„èŠ±åœ’</label>
                <label class="lesson-item"><input type="checkbox" value="12"> ç¬¬åäºŒèª² å¥‡ç‰¹çš„æœ‹å‹</label>
            </div>
            <button id="entryButton" class="btn-green" style="width: 100%; padding: 15px; font-size: 1.2rem; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">é€²å…¥éŠæˆ²</button>
        </div>

        <!-- ç•«é¢äºŒï¼šéŠæˆ² -->
        <div id="gameView">
            <div class="score-panel">
                <span>å¾—åˆ†: <span id="scoreDisplay">0</span></span>
                <span style="color: #ef4444;">â¤ï¸: <span id="livesDisplay">3</span></span>
                <span>æœ€é«˜: <span id="highScoreDisplay">0</span></span>
            </div>
            <!-- Canvas ä¹Ÿå¥—ç”¨ç£šç‰†æ¨£å¼ -->
            <canvas id="gameCanvas" class="brick-bg" width="380" height="500"></canvas>
            
            <div class="action-buttons">
                <button id="startButton">é–‹å§‹ / é‡æ–°</button>
                <button id="pauseButton" class="btn-orange" disabled>æš«åœ</button>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <button id="uploadButton" class="btn-green">è§’è‰²ç…§ç‰‡</button>
            </div>

            <!-- å¹³æ¿å°ˆç”¨åº•éƒ¨æŒ‰éˆ• -->
            <div class="tablet-controls">
                <div class="control-btn" id="leftBtn">â—€</div>
                <div class="control-btn" id="rightBtn">â–¶</div>
            </div>
        </div>

        <!-- è¨Šæ¯å½ˆçª— -->
        <div class="message-overlay" id="messageOverlay">
            <div class="message-box">
                <h2 id="messageTitle">æç¤º</h2>
                <p id="messageText"></p>
                <button id="closeMessageButton">ç¢ºå®š</button>
            </div>
        </div>

        <!-- é¸æ“‡é¡Œå½ˆçª— -->
        <div class="message-overlay" id="quizOverlay">
            <div class="message-box">
                <h3 style="margin:0;">è«‹æ ¹æ“šè§£é‡‹é¸å‡ºèªè©ï¼š</h3>
                <div id="quizQuestion" class="quiz-question-text"></div>
                <!-- é¸é …å®¹å™¨ -->
                <div id="quizOptions"></div>
                <div id="feedbackText" style="margin-top:10px; font-weight:bold;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- é¡Œåº« (åº·è»’ä¸‰ä¸Š 7-12èª²) ---
        const VOCAB_DATA = {
            7: [
                { word: "å‚³çµ±", def: "ä¸–ä»£ç›¸å‚³ï¼Œæœ‰å‚³æ‰¿å»¶çºŒæ€§è³ªçš„ç¤¾æœƒå› ç´ ï¼Œå¦‚é¢¨ä¿—ã€é“å¾·ã€ç¿’æ…£ã€ä¿¡ä»°ã€æ€æƒ³ç­‰ã€‚" },
                { word: "å•†è¡Œ", def: "è¦æ¨¡è¼ƒå¤§çš„å•†åº—ã€‚" },
                { word: "é˜¿å©†", def: "å°å¹´é•·å©¦äººçš„é€šç¨±ã€‚" },
                { word: "éµè›‹", def: "æ»·äº†å¾ˆä¹…è€Œè®Šå¾—åˆé»‘åˆç¡¬çš„è›‹ï¼Œå› ç‚ºå …ç¡¬è€Œè¢«ç¨±ç‚ºã€Œéµè›‹ã€ã€‚" },
                { word: "è’¼è€", def: "å½¢å®¹è²éŸ³æˆ–å¤–è²Œçš„è€æ…‹ã€‚" },
                { word: "å±±å¡", def: "å±±é ‚èˆ‡å¹³åœ°é–“çš„æ–œé¢åœ°å¸¶ã€‚" },
                { word: "å›æ†¶", def: "â‘´å›æƒ³å¾€äº‹ã€‚â‘µéå»çš„è¨˜æ†¶ã€‚" },
                { word: "å¤•é™½", def: "å‚æ™šæ™‚å°‡è¥¿ä¸‹çš„å¤ªé™½ã€‚" },
                { word: "æ–ç›ª", def: "æ–æ“ºæ™ƒç›ªã€‚" }
            ],
            8: [
                { word: "æ•™è‚²", def: "ä¸€ç¨®æœ‰é—œåŸ¹æ¤äººæ‰ï¼Œè¨“ç·´æŠ€èƒ½ï¼Œä»¥æ”¯æ‡‰åœ‹å®¶å»ºè¨­ã€ç¤¾æœƒç™¼å±•çš„äº‹æ¥­ã€‚" },
                { word: "åšç‰©é¤¨", def: "è’é›†ã€é™³åˆ—å„å¼å„æ¨£ç‰©å“ï¼Œè®“äººè§€è³ï¼Œä¸¦æ°¸ä¹…ä¿å­˜åŠæä¾›ç ”ç©¶çš„å ´æ‰€ã€‚" },
                { word: "å²æ–™", def: "æœ‰é—œæ­·å²çš„æ–‡ç»è³‡æ–™ã€‚" },
                { word: "æ¨¡å‹", def: "æ¨¡ä»¿å¯¦ç‰©çš„åŸå½¢ï¼Œç¸®å°è£½æˆçš„æ¨£å“ã€‚é€šå¸¸ç”¨æ–¼å±•ç¤ºæˆ–å¯¦é©—ã€‚" },
                { word: "è·è˜­", def: "åœ‹åã€‚å…¨å¢ƒåœ°å‹¢ä½å¹³ï¼Œæœ‰ç™¾åˆ†ä¹‹ä¸‰åå…«çš„åœ°å€ä½æ–¼æµ·å¹³é¢ï¼Œç‚ºè‘—åçš„ä½åœ°åœ‹ã€‚é¦–éƒ½é˜¿å§†æ–¯ç‰¹ä¸¹ï¼Œæ”¿åºœæ‰€åœ¨åœ°ç‚ºæµ·ç‰™ã€‚ä¸»è¦ä¿¡ä»°ç‚ºå¤©ä¸»æ•™ã€åŸºç£æ•™ã€‚" },
                { word: "é„­æˆåŠŸ", def: "äººåã€‚æ˜æœ«å—å®‰äººï¼Œçˆ¶è¦ªé„­èŠé¾é™æ¸…ï¼Œé„­æˆåŠŸå»ä¸»å¼µã€Œåæ¸…å¾©æ˜ã€ï¼Œå¾Œèˆ‡æ¸…å…µä½œæˆ°å¤±æ•—ï¼Œé€€æ“šè‡ºç£ï¼Œä»å¥‰æ˜æœå¹´è™Ÿã€‚" },
                { word: "æ‰“æ•—", def: "â‘´æˆ°å‹ã€‚â‘µæˆ°çˆ­æˆ–ç«¶çˆ­ä¸­å¤±æ•—ã€‚" },
                { word: "é§å®ˆ", def: "é§ç´®é˜²å®ˆã€‚" },
                { word: "å®ˆè­·", def: "å®ˆè¡›ä¿è­·ã€‚" },
                { word: "å‹‡æ•¢", def: "æœ‰å‹‡æ°£ï¼Œæ•¢æ–¼ä½œç‚ºã€‚" },
                { word: "å£«å…µ", def: "è»éšŠä¸­çš„åŸºå±¤æˆ°å£«ã€‚" },
                { word: "åœŸåœ°", def: "â‘´ç–†åŸŸã€‚â‘µç”°åœ°ï¼Œæœ‰åœŸå£¤çš„åœ°é¢ã€‚" },
                { word: "é™„è¿‘", def: "è·é›¢ä¸é çš„åœ°æ–¹ã€‚" },
                { word: "ç­æœ›è‡º", def: "ç”¨ä»¥çœºæœ›é æ–¹æ•µæƒ…æˆ–æ™¯ç‰©çš„é«˜è‡ºã€‚" },
                { word: "å±‹é ‚", def: "å»ºç¯‰ç‰©æœ€ä¸Šé¢è¦†è“‹çš„éƒ¨åˆ†ã€‚å…·æœ‰é˜²é¢¨ã€é›¨ã€é›ªåŠæŠµæ“‹é™½å…‰ç­‰åŠŸèƒ½ã€‚" },
                { word: "åœ°æ¨™", def: "â‘´åœ°å€æ™¯è§€ä¸Šçªå‡ºçš„ç‰¹å¾µã€‚â‘µç”¨ä¾†æ¨™ç¤ºç•Œç·šä½ç½®çš„ç›®æ¨™ç‰©ã€‚" }
            ],
            9: [
                { word: "é¦¬å¤ªé", def: "é¦¬å¤ªéæº¼åœ°ç”Ÿæ…‹åœ’å€ä½æ–¼èŠ±è“®ç¸£ å…‰å¾©é„‰é¦¬éŒ«å±±å±±è…³ä¸‹ï¼Œæ˜¯ä¸€è™•å¤©ç„¶çš„æ²¼æ¾¤æº¼åœ°ï¼Œåœ’å€å…§ç”Ÿæ…‹è±å¯Œã€‚é¦¬å¤ªéæº¼åœ°ç”Ÿæ…‹åœ’å€æ˜¯é˜¿ç¾æ—é¦¬å¤ªééƒ¨è½çš„å‚³çµ±ç”Ÿæ´»å€ï¼Œéå»é€™è£¡é•·æ»¿äº†æ¨¹è±†ï¼ˆvataanï¼‰ï¼Œå› æ­¤ï¼Œæ¨¹è±†çš„åç¨±å°±æˆäº†ã€Œé¦¬å¤ªéã€åœ°åçš„ç”±ä¾†ã€‚" },
                { word: "èŠ±è“®", def: "ç¸£åã€‚ä½æ–¼è‡ºç£æ±éƒ¨ï¼Œé¢ç©ç´„å››åƒå…­ç™¾é¤˜å¹³æ–¹å…¬é‡Œï¼Œç‚ºè‡ºç£é¢ç©æœ€å¤§çš„ç¸£ã€‚ç¸£è½„èŠ±è“®å¸‚æ˜¯æ±éƒ¨ç¸±è²«éµè·¯çš„èµ·é»ï¼Œè˜‡èŠ±å…¬è·¯åŠä¸­éƒ¨æ©«è²«å…¬è·¯çš„çµ‚é»ï¼Œç‚ºæ±éƒ¨å·¥ã€å•†æ¥­æ—…éŠä¸­å¿ƒã€‚èŠ±è“®æ¸¯æ¿±å¤ªå¹³æ´‹ï¼Œç‚ºè‡ºç£æ±éƒ¨æœ€å¤§å•†æ¸¯ã€‚å¢ƒå…§å±±åœ°èµ·ä¼ï¼Œé¢¨æ™¯ç§€éº—é›„å‰ã€‚" },
                { word: "æº¼åœ°", def: "ç¶“å¸¸è¢«æ°´æ·¹æ²’çš„åœ°å¸¶ã€‚å¦‚æ²¼æ¾¤ã€çªªåœ°ã€æ°´å¡˜ç­‰ã€‚é€šå¸¸æ˜¯æ²³å£æµåŸŸçš„é‚Šéš›åœ°å¸¶ï¼Œä¹Ÿæ˜¯ç•Œæ–¼æ²¿æµ·æ°´åŸŸå’Œé™¸åœ°é–“çš„éæ¸¡å¸¶ã€‚æº¼åœ°è˜Šè‚²è±å¯Œçš„ç‰©ç¨®ï¼Œæä¾›é©åˆé­šé¡ã€å…©æ£²é¡ã€é³¥é¡ã€çˆ¬èŸ²é¡ã€æ·¡é¹¹æ°´éæ¸¡æ¤ç‰©ç”Ÿé•·çš„ç’°å¢ƒã€‚" },
                { word: "é˜¿ç¾æ—", def: "è‡ºç£åŸä½æ°‘æ—ä¹‹ä¸€ã€‚ä¸»è¦åˆ†å¸ƒåœ¨èŠ±è“®ç¸£ã€è‡ºæ±ç¸£ã€å±æ±ç¸£ã€‚æ¯å¹´çš„ä¸»è¦ç¥­å…¸æœ‰ï¼šäº”ã€å…­æœˆé–“èˆ‰è¡Œçš„æ¼æ’ˆç¥­å’Œä¸ƒæœˆé–‹å§‹çš„è±å¹´ç¥­ã€‚" },
                { word: "ç‰¹åˆ¥", def: "èˆ‡çœ¾ä¸åŒã€‚" },
                { word: "æ•é­š", def: "æ•æ‰é­šé¡ã€‚" },
                { word: "æ–¹å¼", def: "åšäº‹æƒ…æ‰€æ¡å–çš„é †åºã€å½¢å¼ã€‚" },
                { word: "æ‰“é€ ", def: "ä»¥æ‰‹å·¥è£½é€ ã€‚" },
                { word: "ç«¹å­", def: "å¤šå¹´ç”Ÿå¸¸ç¶ æ¤ç‰©ã€‚è–ç´°é•·ï¼Œå‘ˆç®¡ç‹€ä¸­ç©ºï¼Œç¶ è‰²ï¼Œæœ‰ç¯€ã€‚è‘‰ç‰‡ç‹¹é•·ï¼Œä¸€ç«¯å°–ä¸€ç«¯åœ“ã€‚ç«¹è–å …éŸŒï¼Œå¯ä»¥ä½œç‚ºå»ºç¯‰ææ–™ã€‚åœ°ä¸‹è–å¯å‘ä¸Šç”Ÿç­ï¼Œç«¹ç­å¯ä¾›é£Ÿç”¨ã€‚" },
                { word: "æ¤ç‰©", def: "ç™¾ç©€è‰æœ¨çš„ç¸½ç¨±ã€‚ç‚ºæœ‰æ©Ÿç”Ÿç‰©ä¹‹ä¸€ã€‚æ¤ç‰©ç´°èƒèˆ‡å‹•ç‰©ç´°èƒæœ€å¤§çš„ä¸åŒåœ¨æ–¼å…·æœ‰ç´°èƒå£ï¼Œä¸”å¤§éƒ¨åˆ†å…§å«è‘‰ç¶ ç´ ï¼Œå¯è¡Œå…‰åˆä½œç”¨ï¼Œæ”å–å…‰ã€æ°´ç­‰ç„¡æ©Ÿç‰©ï¼Œä¸¦è½‰åŒ–æˆé¤Šåˆ†ã€‚æ¤ç‰©é€šå¸¸å›ºå®šæ–¼ä¸€è™•ï¼Œç¨®å­å¯è—‰æ°´ã€é¢¨ã€äººç­‰å¤–åŠ›å¸¶è‡³å„åœ°ç¹æ®–ã€‚å…¶ç¨®é¡ç¹å¤šï¼Œç´„å¯åˆ†ç‚ºè‰æœ¬ã€æœ¨æœ¬ã€è—»é¡ã€è‹”è˜šã€èŒé¡ç­‰äº”å¤§é¡åˆ¥ã€‚" },
                { word: "é‡£é­š", def: "ç”¨é¤Œèª˜é­šä¸Šé‰¤ã€‚" },
                { word: "æ™ºæ…§", def: "è°æ˜æ‰æ™ºã€‚" },
                { word: "ç”Ÿæ…‹", def: "ç”Ÿç‰©åœˆå…§çš„ç”Ÿç‰©ï¼Œä¸è«–æ˜¯åŒç¨®æˆ–ç•°ç¨®ï¼Œå½¼æ­¤é–“éƒ½æœƒç›¸äº’å½±éŸ¿ï¼Œè€Œç”Ÿç‰©å’Œå…¶ç”Ÿå­˜çš„ç’°å¢ƒ ï¼Œä¹Ÿæœƒç™¼ç”Ÿç›¸äº’ä½œç”¨ï¼Œé€™äº›ç¾è±¡ç¨±ç‚ºã€Œç”Ÿæ…‹ã€ã€‚" }
            ],
            10: [
                { word: "ç‹ç‹¸", def: "â‘´æœ¬æŒ‡ç‹å’Œç‹¸å…©ç¨®å‹•ç‰©ï¼Œå¾Œå¤šå°ˆæŒ‡ç‹ã€‚â‘µç‹ç‹¸ç”Ÿæ€§ç‹¡çŒ¾å¤šç–‘ï¼Œæ•…å¤šç”¨ä¾†æ¯”å–»ç‹¡è©è€Œä½œæƒ¡å¤šç«¯çš„å£äººã€‚" },
                { word: "è¬é‡Œ", def: "å½¢å®¹æ¥µé ã€‚" },
                { word: "å…„å¼Ÿ", def: "â‘´ç”·å­åŒèƒå…ˆå‡ºç”Ÿçš„ç‚ºå…„ï¼Œå¾Œå‡ºç”Ÿçš„ç‚ºå¼Ÿã€‚â‘µæ³›æŒ‡æ„æ°£ç›¸æŠ•çš„ç”·æ€§ä¹‹é–“çš„æœ‹å‹ã€‚" },
                { word: "ç¥•å¯†", def: "â‘´éš±å¯†è€Œä¸è®“äººçŸ¥é“çš„äº‹ã€‚â‘µéš±å¯†çš„ã€‚" },
                { word: "æ”¾æ£„", def: "æ‹‹æ£„ã€‚" },
                { word: "çƒé´‰", def: "å‹•ç‰©åã€‚è„Šæ¤å‹•ç‰©é³¥ç¶±é›€å½¢ç›®é´‰ç§‘ã€‚é«”é•·å°ºé¤˜ï¼Œå˜´å¤§ä¸”ç›´ã€‚å…¨èº«é»‘è‰²ï¼Œå¸¶æœ‰ç¶ è‰²å…‰æ¾¤ã€‚è¶¾å…·é‰¤çˆªï¼Œè­¦è¦ºæ€§é«˜ï¼Œä»¥ç©€ç‰©ã€æœå¯¦ã€æ˜†èŸ²ã€å‹•ç‰©è…å±ç‚ºé£Ÿç‰©ã€‚å¤šæ£²æ¯æ–¼åŸå¸‚è¿‘éƒŠæˆ–å±±å€é«˜æ¨¹ã€‚" },
                { word: "å¦™è¨ˆ", def: "å·§å¦™çš„è¨ˆç­–ã€‚" },
                { word: "å¼·å£¯", def: "å¥å£¯æœ‰åŠ›ã€‚" }
            ],
            11: [
                { word: "æ„‰æ‚…", def: "å¿«æ¨‚ã€å–œæ‚…ã€‚" },
                { word: "æ‹œè¨ª", def: "æ‹œå€™ã€æ¢æœ›ã€‚" },
                { word: "å…å¾—", def: "ä»¥å…ã€é¿å…ã€‚" },
                { word: "é›¢é–‹", def: "èˆ‡äººã€ç‰©æˆ–åœ°æ–¹åˆ†é–‹ã€‚" },
                { word: "é¡¯å¾—", def: "æ¥µæ˜é¡¯æ¸…æ¥šçš„è¡¨éœ²å‡ºæŸä¸€æƒ…æ³ã€‚" },
                { word: "æ¼«é•·", def: "ç‰¹åˆ¥é•·ã€é•·å¾—çœ‹ä¸åˆ°ç›¡é ­ã€‚" },
                { word: "ä¹¾æ¯", def: "â‘´è‰æœ¨å› ç¼ºå°‘æ°´åˆ†æˆ–ç‡Ÿé¤Šè€Œæ¯é»ƒçš„æ¨£å­ã€‚â‘µæ°´ä¸€é»ä¹Ÿä¸å‰©ã€‚" },
                { word: "æç„¶å¤§æ‚Ÿ", def: "å¿ƒè£¡å¿½ç„¶æ˜ç™½ã€‚" },
                { word: "æ‹†é™¤", def: "æ‹†æ‰ã€å»é™¤ã€‚" },
                { word: "ç››é–‹", def: "èŠ±æœµé–‹å¾—èŒ‚ç››ã€‚" }
            ],
            12: [
                { word: "æ•…éšœ", def: "æ©Ÿæ¢°ç„¡æ³•é †åˆ©é‹ä½œã€‚" },
                { word: "æ²™æ¼ ", def: "åœ°é¢è¦†è“‹æ²™åœŸï¼Œä¹¾æ—±ç¼ºæ°´ï¼Œæ¤ç‰©ç¨€å°‘çš„åœŸåœ°ã€‚å¹³å‡å¹´é›¨é‡ä¸è¶³äºŒç™¾äº”åå…¬é‡ã€‚å¦‚æ’’å“ˆæ‹‰æ²™æ¼ ã€å¡”å…‹æ‹‰ç‘ªå¹²æ²™æ¼ ç­‰ã€‚" },
                { word: "ç¶¿ç¾Š", def: "å‹•ç‰©åã€‚å“ºä¹³ç¶±å¶è¹„ç›®ã€‚è§’è¼ƒå±±ç¾ŠçŸ­å°ï¼Œæ€§æº«é †ï¼Œæ¯›é•·è€Œè»Ÿï¼Œå¯ç¹”å‘¢çµ¨ï¼Œä¸¦å¯è£½è£˜ã€‚" },
                { word: "ä¸­å¤®", def: "â‘´ä¸­é–“æˆ–ä¸­å¿ƒåœ°æ–¹ã€‚â‘µåœ‹å®¶æˆ–åœ˜é«”çš„æœ€é«˜æŒ‡å°æ©Ÿé—œã€‚" },
                { word: "ç”·å­©", def: "å°ç”·ç”Ÿæˆ–æŒ‡å¹´è¼•æœªå©šçš„ç”·å­ã€‚" },
                { word: "é‡è¤‡", def: "äº‹ç‰©åè¦†ç›¸åŒã€‚" },
                { word: "ç–‘å•", def: "ä»¤äººè³ªç–‘çš„å•é¡Œã€‚" },
                { word: "æ‰“ç®—", def: "è€ƒæ…®ã€è¨ˆç•«ã€‚" },
                { word: "å¸½å­", def: "æˆ´åœ¨é ­ä¸Šï¼Œç”¨ä»¥é®é™½ã€é¿é›¨ã€ä¿æš–æˆ–è£é£¾çš„ç”¨å“ã€‚" },
                { word: "å¾Œé€€", def: "å‘å¾Œé€€ã€‚" },
                { word: "èŸ’è›‡", def: "å‹•ç‰©åã€‚èŸ’è›‡ç§‘èŸ’å±¬ã€‚ä¸€ç¨®ç„¡æ¯’ç‰™çš„å¤§è›‡ï¼Œé•·äºŒä¸ˆä»¥ä¸Šï¼Œæœ‰é±—ï¼Œé«”é»ƒè¤è‰²ï¼Œè…¹ç™½ã€‚å¤šç”¢æ–¼ç†±å¸¶åŠäºç†±å¸¶æ°´é‚Šï¼Œæ•é£Ÿç¸é¡ã€‚ä¿—ç¨±ç‚ºã€ŒèŸ’è›‡ã€ã€‚" },
                { word: "é©šè¨", def: "é©šå¥‡è¨ç•°ã€‚" }
            ]
        };

        const setupView = document.getElementById('setupView');
        const gameView = document.getElementById('gameView');
        const entryButton = document.getElementById('entryButton');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const livesDisplay = document.getElementById('livesDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const quizOverlay = document.getElementById('quizOverlay');
        const quizQuestion = document.getElementById('quizQuestion');
        const quizOptions = document.getElementById('quizOptions');
        const feedbackText = document.getElementById('feedbackText');

        const PLAYER_SIZE = 40;
        const PLAYER_SPEED = 6;
        const GRAVITY = 0.8;
        const STAIR_SPEED = 1.3; // é€Ÿåº¦æ¸›æ…¢

        let gameState = {
            isRunning: false,
            isPaused: false,
            isQuizActive: false,
            score: 0,
            highScore: 0,
            lives: 3,
            invincible: 0,
            player: { x: 170, y: 300, dx: 0, dy: 0 },
            obstacles: [],
            vocabPool: [],
            history: new Set(),
            playerImg: new Image(),
            imgLoaded: false,
            rowsHandled: new Set(),
            bgY: 0
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mandarin-stairs-g3-7-12';
        const fbCfg = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const authTok = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db, auth;

        if (fbCfg) {
            const app = initializeApp(fbCfg);
            db = getFirestore(app);
            auth = getAuth(app);
            const initA = async () => { if(authTok) await signInWithCustomToken(auth, authTok); else await signInAnonymously(auth); };
            initA();
            onAuthStateChanged(auth, (u) => {
                if(u) onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'scores', 'global'), (ds) => {
                    if(ds.exists()) { gameState.highScore = ds.data().score || 0; highScoreDisplay.textContent = gameState.highScore; }
                });
            });
        }

        entryButton.addEventListener('click', () => {
            const sels = Array.from(document.querySelectorAll('.lesson-grid input:checked')).map(i => i.value);
            if(sels.length === 0) {
                // ä½¿ç”¨è‡ªå®šç¾©å½ˆçª—å–ä»£ alert
                document.getElementById('messageTitle').textContent = "æç¤º";
                document.getElementById('messageText').textContent = "è«‹å‹¾é¸èª²æ¬¡ï¼";
                document.getElementById('messageOverlay').style.display = 'flex';
                return;
            }
            gameState.vocabPool = sels.flatMap(n => VOCAB_DATA[n]);
            setupView.style.display = 'none';
            gameView.style.display = 'flex';
        });

        function startGame() {
            gameState.score = 0;
            gameState.lives = 3;
            gameState.history.clear();
            gameState.obstacles = [];
            gameState.rowsHandled.clear();
            
            // --- åˆå§‹ç”Ÿæˆé‚è¼¯ï¼šç¢ºä¿ç¬¬ä¸€å±¤æ˜¯å®‰å…¨å¹³å°ä½†æœ‰ç¼ºå£ ---
            const startY = 380; // ç©å®¶è…³ä¸‹çš„åˆå§‹ä½ç½®
            
            // ç”¢ç”Ÿä¸€å€‹éš¨æ©Ÿç¼ºå£ï¼Œè®“ç©å®¶å¯ä»¥å¾€ä¸‹è·³
            const gapWidth = 90; 
            const gapX = Math.random() * (canvas.width - gapWidth);

            // å·¦å´åœ°æ¿
            if (gapX > 0) {
                gameState.obstacles.push({
                    x: 0, y: startY, w: gapX, h: 20, rid: 'start-L', node: null
                });
            }
            // å³å´åœ°æ¿
            if (gapX + gapWidth < canvas.width) {
                gameState.obstacles.push({
                    x: gapX + gapWidth, y: startY, w: canvas.width - (gapX + gapWidth), h: 20, rid: 'start-R', node: null
                });
            }
            
            // ç©å®¶åˆå§‹ä½ç½®ï¼šç«™åœ¨è¼ƒå¯¬çš„é‚£ä¸€å´å¹³å°ä¸Šï¼Œé¿å…ç›´æ¥æ‰ä¸‹å»
            if (gapX > (canvas.width - gapWidth) / 2) {
                // å·¦é‚Šè¼ƒå¯¬ï¼Œç«™å·¦é‚Š
                gameState.player.x = gapX / 2 - PLAYER_SIZE / 2;
            } else {
                // å³é‚Šè¼ƒå¯¬ï¼Œç«™å³é‚Š
                const segStart = gapX + gapWidth;
                const segWidth = canvas.width - segStart;
                gameState.player.x = segStart + segWidth / 2 - PLAYER_SIZE / 2;
            }
            gameState.player.y = startY - PLAYER_SIZE;
            gameState.player.dy = 0;
            
            // ç”Ÿæˆå…¶ä»–å¹³å°ï¼ˆä¸Šæ–¹å’Œä¸‹æ–¹ï¼‰
            // å‘ä¸Šç”Ÿæˆï¼ˆè¦–è¦ºä¸Šæ˜¯ä¸Šæ–¹ï¼ŒYå€¼è¼ƒå°ï¼‰
            for(let y = startY - 120; y > -50; y -= 120) createRow(y);
            // å‘ä¸‹ç”Ÿæˆï¼ˆè¦–è¦ºä¸Šæ˜¯ä¸‹æ–¹ï¼ŒYå€¼è¼ƒå¤§ï¼Œä½œç‚ºå¾ŒçºŒæ¨“å±¤ï¼‰
            createRow(startY + 120);

            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.isQuizActive = false;
            gameState.bgY = 0;
            scoreDisplay.textContent = '0';
            livesDisplay.textContent = '3';
            startButton.disabled = true;
            pauseButton.disabled = false;
            
            requestAnimationFrame(gameLoop);
        }

        function createRow(y) {
            const rid = crypto.randomUUID();
            const gaps = Math.floor(Math.random() * 2) + 1;
            const gw = 65;
            let segs = [{x: 0, w: canvas.width}];
            for(let i=0; i<gaps; i++) {
                let idx = segs.findIndex(s => s.w > gw + 40);
                if(idx === -1) break;
                let s = segs.splice(idx, 1)[0];
                let gx = s.x + 20 + Math.random() * (s.w - gw - 40);
                segs.push({x: s.x, w: gx - s.x}, {x: gx + gw, w: (s.x+s.w) - (gx+gw)});
            }
            segs.forEach(seg => {
                if(seg.w < 5) return;
                let o = { x: seg.x, y: y, w: seg.w, h: 18, rid: rid, node: null };
                let pool = gameState.vocabPool.filter(v => !gameState.history.has(v.word));
                if(pool.length > 0 && Math.random() < 0.25) {
                    let item = pool[Math.floor(Math.random()*pool.length)];
                    let nx;
                    if(seg.x === 0) nx = seg.w - 20; 
                    else if(seg.x + seg.w >= canvas.width) nx = seg.x + 20; 
                    else nx = seg.x + seg.w/2;
                    o.node = { x: nx, item: item };
                }
                gameState.obstacles.push(o);
            });
        }

        function triggerQuiz(node) {
            gameState.isPaused = true;
            gameState.isQuizActive = true;
            feedbackText.textContent = "";
            quizQuestion.textContent = node.item.def;
            let opts = [node.item];
            let others = gameState.vocabPool.filter(v => v.word !== node.item.word);
            while(opts.length < 4 && others.length > 0) {
                let r = Math.floor(Math.random()*others.length);
                let p = others.splice(r, 1)[0];
                if(!opts.find(o => o.word === p.word)) opts.push(p);
            }
            opts.sort(() => Math.random() - 0.5);
            quizOptions.innerHTML = '';
            opts.forEach(o => {
                let b = document.createElement('button');
                b.className = 'quiz-btn';
                b.textContent = o.word;
                b.onclick = () => {
                    if(o.word === node.item.word) {
                        gameState.score += 5;
                        feedbackText.style.color = "#10b981";
                        feedbackText.textContent = "æ­£ç¢ºï¼+5åˆ†";
                        gameState.history.add(node.item.word);
                    } else {
                        gameState.score -= 3;
                        feedbackText.style.color = "#ef4444";
                        feedbackText.textContent = `ç­”éŒ¯ï¼æ­£è§£æ˜¯ï¼š${node.item.word}ã€‚-3åˆ†`;
                    }
                    scoreDisplay.textContent = gameState.score;
                    setTimeout(() => {
                        gameState.isPaused = false;
                        gameState.isQuizActive = false;
                        quizOverlay.style.display = 'none';
                        requestAnimationFrame(gameLoop);
                    }, 1200);
                };
                quizOptions.appendChild(b);
            });
            quizOverlay.style.display = 'flex';
        }

        function update() {
            if(!gameState.isRunning || gameState.isPaused || gameState.isQuizActive) return;
            if(gameState.invincible > 0) gameState.invincible--;
            
            gameState.bgY -= STAIR_SPEED;
            canvas.style.backgroundPosition = `
                0px ${2 + gameState.bgY}px, 
                4px ${35 + gameState.bgY}px, 
                29px ${31 + gameState.bgY}px, 
                34px ${6 + gameState.bgY}px
            `;

            gameState.player.dy += GRAVITY;
            gameState.player.y += gameState.player.dy;
            gameState.player.x += gameState.player.dx;
            if(gameState.player.x < 0) gameState.player.x = 0;
            if(gameState.player.x + PLAYER_SIZE > canvas.width) gameState.player.x = canvas.width - PLAYER_SIZE;

            let onS = false;
            // æ‘”æ­»æª¢æŸ¥
            if(gameState.player.y > canvas.height) {
                if(gameState.invincible <= 0) {
                    gameState.lives--; livesDisplay.textContent = gameState.lives;
                    if(gameState.lives <= 0) endG(); 
                    else { 
                        gameState.player.y = 100; 
                        gameState.player.dy = 0; 
                        gameState.invincible = 100; 
                    }
                } else {
                    gameState.player.y = 100;
                    gameState.player.dy = 0;
                }
            }

            gameState.obstacles.forEach(o => {
                o.y -= STAIR_SPEED;
                if(gameState.player.dy >= 0 && gameState.player.x < o.x + o.w && gameState.player.x + PLAYER_SIZE > o.x && gameState.player.y + PLAYER_SIZE >= o.y && gameState.player.y + PLAYER_SIZE <= o.y + o.h) {
                    gameState.player.y = o.y - PLAYER_SIZE;
                    gameState.player.dy = 0;
                    onS = true;
                }
                if(o.node) {
                    let d = Math.sqrt(Math.pow((gameState.player.x + PLAYER_SIZE/2) - o.node.x, 2) + Math.pow((gameState.player.y + PLAYER_SIZE/2) - (o.y + 10), 2));
                    if(d < 35) { let it = o.node.item; o.node = null; triggerQuiz({item: it}); }
                }
            });

            gameState.obstacles.forEach(o => {
                if(o.y + 18 < gameState.player.y && !gameState.rowsHandled.has(o.rid)) {
                    gameState.score++; scoreDisplay.textContent = gameState.score; gameState.rowsHandled.add(o.rid);
                }
            });

            gameState.obstacles = gameState.obstacles.filter(o => o.y > -50);
            let low = gameState.obstacles.reduce((max, o) => Math.max(max, o.y), -Infinity);
            if(gameState.obstacles.length === 0 || canvas.height - low >= 115) createRow(canvas.height);

            if(gameState.player.y < 0) {
                if(gameState.invincible <= 0) {
                    gameState.lives--; livesDisplay.textContent = gameState.lives;
                    if(gameState.lives <= 0) endG(); else { gameState.player.y = canvas.height/2; gameState.player.dy = 0; gameState.invincible = 100; }
                }
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#2d3748';
            gameState.obstacles.forEach(o => {
                ctx.fillRect(o.x, o.y, o.w, o.h);
                if(o.node) {
                    ctx.beginPath(); ctx.arc(o.node.x, o.y + 9, 10, 0, Math.PI*2);
                    ctx.fillStyle = '#fbbf24'; ctx.fill();
                    ctx.fillStyle = '#000'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText('?', o.node.x, o.y + 13);
                }
            });
            if(gameState.invincible % 10 < 5) {
                if(gameState.imgLoaded) ctx.drawImage(gameState.playerImg, gameState.player.x, gameState.player.y, PLAYER_SIZE, PLAYER_SIZE);
                else { ctx.fillStyle = '#ef4444'; ctx.fillRect(gameState.player.x, gameState.player.y, PLAYER_SIZE, PLAYER_SIZE); ctx.font = '30px Arial'; ctx.textAlign = 'center'; ctx.fillText('ğŸƒ', gameState.player.x + PLAYER_SIZE/2, gameState.player.y + 30); }
            }
        }

        function gameLoop() { if(!gameState.isRunning) return; update(); draw(); if(!gameState.isPaused && !gameState.isQuizActive) requestAnimationFrame(gameLoop); }

        function endG() {
            gameState.isRunning = false; startButton.disabled = false; pauseButton.disabled = true;
            if(db && auth && auth.currentUser && gameState.score > gameState.highScore) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scores', 'global'), { score: gameState.score, ts: Date.now() }, {merge: true});
            document.getElementById('messageTitle').textContent = "éŠæˆ²çµæŸ";
            document.getElementById('messageText').textContent = "ç”Ÿå‘½è€—ç›¡ï¼å¾—åˆ†ï¼š" + gameState.score;
            document.getElementById('messageOverlay').style.display = 'flex';
        }

        startButton.onclick = startGame;
        pauseButton.onclick = () => { if(!gameState.isRunning) return; gameState.isPaused = !gameState.isPaused; pauseButton.textContent = gameState.isPaused ? "ç¹¼çºŒ" : "æš«åœ"; if(!gameState.isPaused) requestAnimationFrame(gameLoop); };
        document.getElementById('closeMessageButton').onclick = () => document.getElementById('messageOverlay').style.display = 'none';
        document.getElementById('uploadButton').onclick = () => document.getElementById('imageInput').click();
        document.getElementById('imageInput').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = (ev) => { gameState.playerImg.src = ev.target.result; gameState.playerImg.onload = () => { gameState.imgLoaded = true; draw(); }; };
                r.readAsDataURL(f);
            }
        };

        const setD = (d) => { if(!gameState.isRunning || gameState.isPaused || gameState.isQuizActive) return; gameState.player.dx = d * PLAYER_SPEED; };
        window.onkeydown = (e) => { if(e.key === 'ArrowLeft') setD(-1); if(e.key === 'ArrowRight') setD(1); };
        window.onkeyup = (e) => { if(e.key === 'ArrowLeft' || e.key === 'ArrowRight') setD(0); };
        const lB = document.getElementById('leftBtn'), rB = document.getElementById('rightBtn');
        const bind = (b, d) => {
            b.addEventListener('touchstart', (e) => { e.preventDefault(); setD(d); });
            b.addEventListener('touchend', (e) => { e.preventDefault(); setD(0); });
            b.addEventListener('mousedown', () => setD(d));
            b.addEventListener('mouseup', () => setD(0));
            b.addEventListener('mouseleave', () => setD(0));
        };
        bind(lB, -1); bind(rB, 1);
    </script>
</body>
</html>