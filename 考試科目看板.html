<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è€ƒè€ƒè©¦æé†’ - é»‘æ¿é¢¨æ ¼</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥å¯æ„›çš„åœ“é«”å­—å‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* å…¨å±€å­—å‹èˆ‡èƒŒæ™¯ */
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #111;
            margin: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* 16:9 å®¹å™¨ */
        .ratio-wrapper {
            width: 100%;
            max-width: 100%;
            aspect-ratio: 16 / 9;
            max-height: 100vh;
            display: flex;
            position: relative;
        }

        /* é»‘æ¿è³ªæ„ŸèƒŒæ™¯ */
        .blackboard {
            flex: 1;
            background-color: #1a472a;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.05) 0%, transparent 20%);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5), 0 0 20px rgba(0,0,0,0.3);
            border: 1.5vh solid #8B4513;
            border-radius: 10px;
            color: #eee;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 1.5vh;
            gap: 1.5vh;
        }

        /* ç²‰ç­†ç·šæ¢é‚Šæ¡† */
        .chalk-border {
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            background: rgba(255, 255, 255, 0.05);
            height: 100%; 
            box-sizing: border-box;
            min-width: 0; 
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .highlight-text {
            color: #ffeb3b;
            text-shadow: 0 0 8px rgba(255, 235, 59, 0.6);
        }

        /* è¨­å®šé é¢æ¨£å¼ */
        .setup-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: absolute;
            z-index: 50;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
        }

        /* è‡ªè¨‚é¸å–æ¡†æ¨£å¼ */
        .order-box {
            width: 2rem;
            height: 2rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.1rem;
            transition: all 0.2s;
            background-color: white;
            color: transparent;
        }
        
        .order-box.active {
            background-color: #15803d; /* green-700 */
            border-color: #15803d;
            color: white;
        }

        /* --- æ–°å¢ï¼šæ•¸å­—è¼¸å…¥æ¡†æ¨£å¼ --- */
        .digit-box {
            width: 3.5rem;
            height: 4.5rem;
            border: 3px solid #e5e7eb;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 900;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
        }
        
        .digit-box:hover {
            border-color: #15803d;
            background: #f0fdf4;
        }
        
        .digit-box.editing {
            border-color: #15803d;
            box-shadow: 0 0 0 4px rgba(21, 128, 61, 0.2);
            background: #fff;
        }

        /* æ•¸å­—éµç›¤ Modal */
        .numpad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.3);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .numpad-grid {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            width: 280px;
        }
        
        .numpad-btn {
            aspect-ratio: 1;
            font-size: 2rem;
            font-weight: bold;
            color: #374151;
            background: #f3f4f6;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            transition: all 0.1s;
        }
        
        .numpad-btn:active {
            transform: scale(0.95);
            background: #e5e7eb;
        }

        /* çƒé¾œå‹•ç•«å®¹å™¨ */
        .turtle-wrapper {
            position: absolute;
            bottom: -8px; 
            transform: translateX(-50%);
            transition: left 1s linear;
            width: 90px;
            height: 70px;
            z-index: 10;
        }
        
        .cheering svg {
            animation: bounce 0.6s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .hidden { display: none !important; }
        .flex { display: flex; }

        /* --- ä½ˆå±€ç³»çµ± (Rows) --- */
        .row-container {
            display: flex;
            width: 100%;
            gap: 1.5vh;
        }

        .row-top { height: 35%; }
        .area-a { width: 40%; }
        .area-b { width: 60%; }

        .row-middle { height: 47%; }
        .area-c { width: 55%; }
        .area-d { width: 45%; }

        .row-bottom { height: 18%; }
        .area-e { width: 100%; }

        /* Aå€: ä»Šæ—¥è€ƒç¨‹ */
        #schedule-single-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .current-subject {
            font-size: 10vh;
            font-weight: 900;
            line-height: 1.1;
            color: #ffeb3b;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        
        /* æ”¾å¤§è€ƒè©¦æ™‚é–“å­—é«” (5vh -> 7vh) */
        .current-time {
            font-size: 7vh;
            font-family: monospace;
            opacity: 0.9;
            margin-top: 1vh;
        }

        /* Bå€: ç¾åœ¨æ™‚é–“ */
        #digital-clock { 
            font-size: 14vh;
            line-height: 1;
        }
        
        /* Cå€: äººæ•¸ */
        .stat-group {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: center;
            align-items: center;
        }
        
        /* æ”¾å¤§çµ±è¨ˆæ•¸å­— (11vh -> 14vh) */
        .stat-number { 
            font-size: 14vh; 
            line-height: 1;
            order: 2;
        } 
        
        .stat-label { 
            font-size: 4.5vh; 
            font-weight: bold;
            opacity: 0.9;
            margin-bottom: 0.5vh;
            order: 1;
        }
        
        /* Då€: è€ƒç”Ÿæ³¨æ„ (æ”¾å¤§å­—é«” 6vh -> 7vh) */
        #reminder-text { 
            font-size: 7vh; 
            line-height: 1.3;
            white-space: pre-wrap;
            font-weight: 700;
        } 
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    </style>
</head>
<body>

    <!-- 16:9 å¤–æ¡†å®¹å™¨ -->
    <div class="ratio-wrapper">

        <!-- ç¬¬ä¸€é ï¼šè¨­å®šç•«é¢ -->
        <div id="setup-screen" class="setup-card p-8 text-gray-800">
            <h1 class="text-3xl font-bold text-center mb-6 text-green-700">ğŸ“ å¤§è€ƒç›£æ§è¨­å®š</h1>
            
            <form id="exam-form" class="space-y-4">
                <!-- 1. é¸æ“‡ç§‘ç›® -->
                <div>
                    <label class="block text-lg font-bold mb-2">1. é¸æ“‡è€ƒè©¦ç§‘ç›® (æ•¸å­—ä»£è¡¨è€ƒè©¦é †åº)</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded hover:bg-gray-50 select-none">
                            <input type="checkbox" name="subject" value="åœ‹èª" class="hidden">
                            <div class="order-box"></div>
                            <span class="text-xl">åœ‹èª</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded hover:bg-gray-50 select-none">
                            <input type="checkbox" name="subject" value="æ•¸å­¸" class="hidden">
                            <div class="order-box"></div>
                            <span class="text-xl">æ•¸å­¸</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded hover:bg-gray-50 select-none">
                            <input type="checkbox" name="subject" value="è‡ªç„¶" class="hidden">
                            <div class="order-box"></div>
                            <span class="text-xl">è‡ªç„¶</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded hover:bg-gray-50 select-none">
                            <input type="checkbox" name="subject" value="ç¤¾æœƒ" class="hidden">
                            <div class="order-box"></div>
                            <span class="text-xl">ç¤¾æœƒ</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded hover:bg-gray-50 select-none">
                            <input type="checkbox" name="subject" value="è‹±æ–‡" class="hidden">
                            <div class="order-box"></div>
                            <span class="text-xl">è‹±æ–‡</span>
                        </label>
                    </div>
                </div>

                <!-- 2. äººæ•¸è¨­å®š (æ”¹ç‚ºæ•¸ä½ç©ºæ ¼é»é¸) -->
                <div class="grid grid-cols-2 gap-8">
                    <!-- æ‡‰åˆ°äººæ•¸ -->
                    <div>
                        <label class="block text-lg font-bold mb-2 text-center">2. æ‡‰åˆ°äººæ•¸</label>
                        <div class="flex justify-center items-end gap-2">
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-400 mb-1">åä½</span>
                                <div class="digit-box" id="expected-tens" onclick="openNumpad('expected-tens')">0</div>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-400 mb-1">å€‹ä½</span>
                                <div class="digit-box" id="expected-units" onclick="openNumpad('expected-units')">0</div>
                            </div>
                            <span class="text-2xl font-bold ml-2 self-center">äºº</span>
                        </div>
                    </div>
                    
                    <!-- å¯¦åˆ°äººæ•¸ -->
                    <div>
                        <label class="block text-lg font-bold mb-2 text-center">3. å¯¦åˆ°äººæ•¸</label>
                        <div class="flex justify-center items-end gap-2">
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-400 mb-1">åä½</span>
                                <div class="digit-box" id="actual-tens" onclick="openNumpad('actual-tens')">0</div>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-400 mb-1">å€‹ä½</span>
                                <div class="digit-box" id="actual-units" onclick="openNumpad('actual-units')">0</div>
                            </div>
                            <span class="text-2xl font-bold ml-2 self-center">äºº</span>
                        </div>
                    </div>
                </div>

                <!-- é è¦½ç¼ºè€ƒ -->
                <div class="bg-gray-100 p-3 rounded text-center mt-4">
                    <span class="text-lg">ç¼ºè€ƒäººæ•¸å°‡è‡ªå‹•è¨ˆç®—ï¼š <span id="absent-preview" class="font-bold text-red-600">0</span> äºº</span>
                </div>

                <button type="submit" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg text-xl transition transform hover:scale-105">
                    é–‹å§‹è€ƒè©¦ç›£æ§ <i class="fas fa-play ml-2"></i>
                </button>
            </form>
        </div>

        <!-- æ•¸å­—éµç›¤ Modal (éš±è—) -->
        <div id="numpad-modal" class="numpad-overlay hidden" onclick="closeNumpad(event)">
            <div class="numpad-grid" onclick="event.stopPropagation()">
                <div class="col-span-3 text-center mb-2 font-bold text-gray-500">è«‹é¸æ“‡æ•¸å­—</div>
                <button type="button" class="numpad-btn" onclick="selectNumber(1)">1</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(2)">2</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(3)">3</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(4)">4</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(5)">5</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(6)">6</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(7)">7</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(8)">8</button>
                <button type="button" class="numpad-btn" onclick="selectNumber(9)">9</button>
                <button type="button" class="numpad-btn col-start-2" onclick="selectNumber(0)">0</button>
            </div>
        </div>

        <!-- ç¬¬äºŒé ï¼šé»‘æ¿å„€è¡¨æ¿ (åˆå§‹éš±è—) -->
        <div id="monitor-screen" class="blackboard hidden">
            <!-- A, B, C, D, E å€å¡Šèˆ‡ä¹‹å‰ç›¸åŒ -->
            <div class="row-container row-top">
                <div class="area-a chalk-border p-4">
                    <div id="schedule-single-container">
                        <div id="sched-subject" class="current-subject">æº–å‚™ä¸­</div>
                        <div id="sched-time" class="current-time">--:--</div>
                    </div>
                </div>
                <div class="area-b chalk-border p-2 items-center justify-center">
                    <div style="font-size: 2.5vh" class="mb-0 opacity-80">ç¾åœ¨æ™‚é–“</div>
                    <div id="digital-clock" class="font-bold tracking-widest highlight-text" style="font-family: monospace;">
                        00:00:00
                    </div>
                </div>
            </div>

            <div class="row-container row-middle">
                <div class="area-c chalk-border p-2 justify-center">
                    <h2 class="font-bold border-b-2 border-dashed border-white/30 pb-1 mb-2">
                        <i class="fas fa-users mr-2"></i>äººæ•¸çµ±è¨ˆ
                    </h2>
                    <div class="grid grid-cols-3 gap-2 text-center h-full items-center pb-2">
                        <div class="stat-group">
                            <span class="stat-label">æ‡‰åˆ°</span>
                            <span class="stat-number font-black text-white" id="disp-expected">?</span>
                        </div>
                        <div class="stat-group border-l border-r border-white/20">
                            <span class="stat-label">å¯¦åˆ°</span>
                            <span class="stat-number font-black text-yellow-300" id="disp-actual">?</span>
                        </div>
                        <div class="stat-group">
                            <span class="stat-label">ç¼ºè€ƒ</span>
                            <span class="stat-number font-black text-pink-400" id="disp-absent">?</span>
                        </div>
                    </div>
                </div>

                <div class="area-d chalk-border p-2 relative">
                    <h2 class="font-bold border-b-2 border-dashed border-white/30 pb-1 mb-2 text-pink-300">
                        <i class="fas fa-bullhorn mr-2"></i>è€ƒç”Ÿæ³¨æ„
                    </h2>
                    <div class="flex-1 flex items-center justify-center text-center px-4 w-full overflow-hidden">
                        <p id="reminder-text" class="font-bold transition-opacity duration-500 opacity-100 w-full break-words">
                            æº–å‚™è€ƒè©¦...
                        </p>
                    </div>
                </div>
            </div>

            <div class="row-container row-bottom">
                <div class="area-e chalk-border px-8 py-1 relative flex flex-col justify-center">
                    <div class="absolute top-1 left-4 text-white/70" style="font-size: 2vh;">
                        <i class="fas fa-stopwatch mr-2"></i>
                        <span id="current-exam-status" class="ml-2 text-yellow-300">ä¼‘æ¯æ™‚é–“</span>
                    </div>

                    <div class="relative w-full h-10 mt-4">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-white/50 flex flex-col items-center justify-end">
                            <span class="text-xs mb-[-18px]">Start</span>
                        </div>
                        <div class="absolute top-3/4 left-0 right-0 border-b-4 border-dashed border-white/40"></div>
                        <div class="absolute right-0 top-0 bottom-0 w-1 bg-white/50 flex flex-col items-center justify-end">
                            <i class="fas fa-flag text-red-500 text-2xl absolute -top-5 animate-pulse"></i>
                            <span class="text-xs mb-[-18px]">Finish</span>
                        </div>
                        <div id="turtle" class="turtle-wrapper" style="left: 0%;">
                            <svg viewBox="0 0 100 80" width="100%" height="100%" style="filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.4));">
                                <circle cx="30" cy="65" r="8" fill="#8BC34A" />
                                <circle cx="70" cy="65" r="8" fill="#8BC34A" />
                                <ellipse cx="50" cy="60" rx="35" ry="12" fill="#8BC34A" />
                                <path d="M15,55 Q5,60 15,65" fill="#8BC34A" stroke="#558B2F" stroke-width="2" />
                                <path d="M20,55 Q20,15 50,15 Q80,15 80,55 Z" fill="#66BB6A" stroke="#33691E" stroke-width="3"/>
                                <circle cx="50" cy="35" r="8" fill="#4CAF50" opacity="0.6"/>
                                <circle cx="35" cy="48" r="6" fill="#4CAF50" opacity="0.6"/>
                                <circle cx="65" cy="48" r="6" fill="#4CAF50" opacity="0.6"/>
                                <circle cx="88" cy="40" r="14" fill="#8BC34A" stroke="#33691E" stroke-width="2"/>
                                <ellipse cx="90" cy="36" rx="3" ry="4" fill="black"/>
                                <circle cx="91" cy="35" r="1" fill="white"/>
                                <circle cx="82" cy="42" r="2.5" fill="#F48FB1" opacity="0.6"/>
                                <path d="M92,45 Q88,48 84,44" fill="none" stroke="#33691E" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- è³‡æ–™èˆ‡ç‹€æ…‹ ---
        const setupScreen = document.getElementById('setup-screen');
        const monitorScreen = document.getElementById('monitor-screen');
        const form = document.getElementById('exam-form');
        const absentPrev = document.getElementById('absent-preview');
        
        // è€ƒç¨‹é¡¯ç¤ºå…ƒç´ 
        const schedSubjectEl = document.getElementById('sched-subject');
        const schedTimeEl = document.getElementById('sched-time');

        // å›ºå®šæ™‚æ®µ (æ ¼å¼: HH:mm)
        const TIME_SLOTS = [
            { start: "08:40", end: "09:20" }, 
            { start: "09:35", end: "10:15" }, 
            { start: "10:30", end: "11:10" }, 
            { start: "11:20", end: "12:00" }, 
            { start: "13:30", end: "14:10" }  
        ];

        // æé†’äº‹é …
        const REMINDERS = [
            "æ‹¿åˆ°è€ƒå·å…ˆå¯«åå­— âœï¸",
            "æ¡Œä¸Šåªæœ‰é‰›ç­†ã€æ©¡çš®æ“¦ã€è€ƒå· âœï¸",
            "ä¸æœƒçš„é¡Œç›®å…ˆè·³é ğŸ¤”",
            "å¯«å®Œä¸€å®šè¦å†æª¢æŸ¥ä¸€éçœ‹çœ‹æœ‰ç„¡æ²’å¯« ğŸ‘€",
            "æœ‰å•é¡Œè«‹èˆ‰æ‰‹ ğŸ™‹â€â™‚ï¸",
            "ä¸è¦çœ‹åˆ¥äººï¼Œä¸è¦å”±æ­Œå’Œè£½é€ è²éŸ³ ğŸ¤«"
        ];

        let examConfig = {
            subjects: [],
            schedule: [],
            expected: 0,
            actual: 0,
            absent: 0
        };

        // --- é¸æ“‡é †åºé‚è¼¯ ---
        let selectedSubjectsOrder = [];
        const subjectInputs = document.querySelectorAll('input[name="subject"]');
        subjectInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                const val = e.target.value;
                if(e.target.checked) {
                    selectedSubjectsOrder.push(val);
                } else {
                    selectedSubjectsOrder = selectedSubjectsOrder.filter(item => item !== val);
                }
                updateSubjectUI();
            });
        });

        function updateSubjectUI() {
            subjectInputs.forEach(input => {
                const val = input.value;
                const orderIndex = selectedSubjectsOrder.indexOf(val);
                const orderBox = input.nextElementSibling;
                
                if (orderIndex > -1) {
                    orderBox.textContent = orderIndex + 1;
                    orderBox.classList.add('active');
                    input.checked = true; 
                } else {
                    orderBox.textContent = '';
                    orderBox.classList.remove('active');
                    input.checked = false;
                }
            });
        }

        // --- æ•¸å­—éµç›¤é‚è¼¯ ---
        let currentTargetId = null;
        const numpadModal = document.getElementById('numpad-modal');

        function openNumpad(targetId) {
            currentTargetId = targetId;
            // æ¨™è¨˜æ­£åœ¨ç·¨è¼¯çš„æ ¼å­
            document.querySelectorAll('.digit-box').forEach(el => el.classList.remove('editing'));
            document.getElementById(targetId).classList.add('editing');
            
            numpadModal.classList.remove('hidden');
        }

        function closeNumpad(e) {
            if (e) e.stopPropagation();
            numpadModal.classList.add('hidden');
            document.querySelectorAll('.digit-box').forEach(el => el.classList.remove('editing'));
            currentTargetId = null;
        }

        function selectNumber(num) {
            if (currentTargetId) {
                const el = document.getElementById(currentTargetId);
                el.innerText = num;
                updateAbsent();
                closeNumpad();
            }
        }

        // --- äººæ•¸è¨ˆç®—é‚è¼¯ (ä¿®æ”¹å¾Œ) ---
        function getCountFromDigits(prefix) {
            const tens = parseInt(document.getElementById(prefix + '-tens').innerText) || 0;
            const units = parseInt(document.getElementById(prefix + '-units').innerText) || 0;
            return tens * 10 + units;
        }

        function updateAbsent() {
            let exp = getCountFromDigits('expected');
            let act = getCountFromDigits('actual');
            
            // é˜²å‘†ï¼šå¯¦åˆ°ä¸èƒ½å¤§æ–¼æ‡‰åˆ° (è‹¥å¤§æ–¼ï¼Œè‡ªå‹•ä¿®æ­£å¯¦åˆ°)
            // é€™è£¡ä¸åšå¼·åˆ¶ä¿®æ­£è¼¸å…¥æ¡†ï¼Œåªä¿®æ­£è¨ˆç®—çµæœï¼Œæˆ–è€…æç¤º
            // ç‚ºäº†é«”é©—é †æš¢ï¼Œé€™è£¡åƒ…åœ¨è¨ˆç®—çµæœå‘ˆç¾è² æ•¸æ™‚é¡¯ç¤º 0 æˆ–è­¦å‘Š
            // é¡Œç›®è¦æ±‚ï¼šè‡ªå‹•è¨ˆç®—æ‡‰åˆ°æ¸›å»å¯¦åˆ°
            
            let abs = exp - act;
            
            // è‹¥è² æ•¸ï¼Œé¡¯ç¤ºç´…å­—æˆ–è­¦å‘Šï¼Œé€™è£¡ç°¡å–®é¡¯ç¤º
            if (abs < 0) abs = 0; 
            
            absentPrev.innerText = abs;
            return { exp, act, abs };
        }

        // --- è¡¨å–®æäº¤ ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if (selectedSubjectsOrder.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è€ƒè©¦ç§‘ç›®ï¼");
                return;
            }

            // å†æ¬¡ç¢ºèªäººæ•¸é‚è¼¯
            const counts = updateAbsent();
            if (counts.act > counts.exp) {
                alert("å¯¦åˆ°äººæ•¸ä¸èƒ½å¤§æ–¼æ‡‰åˆ°äººæ•¸ï¼");
                return;
            }

            examConfig.subjects = [];
            examConfig.schedule = [];
            
            selectedSubjectsOrder.forEach((subjectName, index) => {
                if (index < TIME_SLOTS.length) {
                    examConfig.subjects.push(subjectName);
                    examConfig.schedule.push({
                        subject: subjectName,
                        start: TIME_SLOTS[index].start,
                        end: TIME_SLOTS[index].end
                    });
                }
            });

            examConfig.expected = counts.exp;
            examConfig.actual = counts.act;
            examConfig.absent = counts.abs;

            setupScreen.classList.add('hidden');
            monitorScreen.classList.remove('hidden');
            monitorScreen.classList.add('flex');

            startMonitor();
        });

        // åˆå§‹åŒ–
        updateAbsent();


        // --- å„€è¡¨æ¿é‚è¼¯ ---
        function startMonitor() {
            renderStaticInfo();
            updateClock(); 
            setInterval(updateClock, 1000);
            startReminderRotation();
            checkExamStatus();
            setInterval(checkExamStatus, 1000);
        }

        function renderStaticInfo() {
            document.getElementById('disp-expected').innerText = examConfig.expected;
            document.getElementById('disp-actual').innerText = examConfig.actual;
            document.getElementById('disp-absent').innerText = examConfig.absent;
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('digital-clock').innerText = timeStr;
        }

        let reminderIndex = 0;
        function startReminderRotation() {
            const textEl = document.getElementById('reminder-text');
            const showReminder = () => {
                textEl.style.opacity = 0;
                setTimeout(() => {
                    textEl.innerText = REMINDERS[reminderIndex];
                    reminderIndex = (reminderIndex + 1) % REMINDERS.length;
                    textEl.style.opacity = 1;
                }, 500);
            };
            showReminder();
            setInterval(showReminder, 20000);
        }

        function checkExamStatus() {
            const now = new Date();
            const currentTimeVal = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            let activeExamIndex = -1;
            let percent = 0;
            let statusMsg = "ä¼‘æ¯æ™‚é–“";
            
            let displaySubject = "";
            let displayTime = "";
            let foundDisplay = false;

            for(let i=0; i<examConfig.schedule.length; i++) {
                const slot = examConfig.schedule[i];
                const startParts = slot.start.split(':').map(Number);
                const endParts = slot.end.split(':').map(Number);
                const startSec = startParts[0] * 3600 + startParts[1] * 60;
                const endSec = endParts[0] * 3600 + endParts[1] * 60;

                if (currentTimeVal >= startSec && currentTimeVal <= endSec) {
                    activeExamIndex = i;
                    const duration = endSec - startSec;
                    const elapsed = currentTimeVal - startSec;
                    percent = (elapsed / duration) * 100;
                    statusMsg = `æ­£åœ¨è€ƒè©¦ï¼š${slot.subject}`;
                    
                    displaySubject = slot.subject;
                    displayTime = `${slot.start} - ${slot.end}`;
                    foundDisplay = true;
                    break;
                }
            }

            if (!foundDisplay) {
                for(let i=0; i<examConfig.schedule.length; i++) {
                    const slot = examConfig.schedule[i];
                    const startParts = slot.start.split(':').map(Number);
                    const startSec = startParts[0] * 3600 + startParts[1] * 60;
                    
                    if (currentTimeVal < startSec) {
                        displaySubject = slot.subject;
                        displayTime = `${slot.start} - ${slot.end}`;
                        statusMsg = `ä¸‹ç¯€è€ƒè©¦ï¼š${slot.subject}`;
                        foundDisplay = true;
                        break;
                    }
                }
            }

            if (!foundDisplay && examConfig.schedule.length > 0) {
                const nextSlot = examConfig.schedule[0];
                displaySubject = nextSlot.subject;
                displayTime = `${nextSlot.start} - ${nextSlot.end}`;
                statusMsg = `ä¸‹ç¯€è€ƒè©¦ï¼š${nextSlot.subject}`;
                foundDisplay = true;
            }

            schedSubjectEl.innerText = displaySubject;
            schedTimeEl.innerText = displayTime;
            document.getElementById('current-exam-status').innerText = statusMsg;

            const turtle = document.getElementById('turtle');
            
            if (activeExamIndex !== -1) {
                if(percent > 100) percent = 100;
                if(percent < 0) percent = 0;
                turtle.style.left = `${percent}%`;
                if (percent >= 99.5) {
                    turtle.classList.add('cheering');
                } else {
                    turtle.classList.remove('cheering');
                }
            } else {
                turtle.style.left = '0%';
                turtle.classList.remove('cheering');
            }
        }
    </script>
</body>
</html>