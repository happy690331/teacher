<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å®¶ä¾†æ‰¾ç¢´ - è¨˜æ†¶æŒ‘æˆ°è³½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-container {
            perspective: 1000px;
        }
        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            width: 100%;
            height: 100%;
        }
        .card-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
        }
        .card-back {
            background-color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            transform: rotateY(180deg);
        }
        .result-overlay {
            pointer-events: none;
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        /* Gallery Selection Styles */
        .gallery-item.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(0.95);
        }
        .gallery-item.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 4px;
            right: 4px;
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans">

<div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
    <!-- ç¬¬ä¸€é ï¼šä¸Šå‚³ä»‹é¢ -->
    <div id="upload-view" class="bg-white rounded-2xl shadow-xl p-8 relative transition-all duration-300">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex-1 text-center relative">
                <h1 class="text-3xl font-bold text-slate-800 mb-2">å¤§å®¶ä¾†æ‰¾ç¢´ï¼šåœ–ç‰‡æŒ‘æˆ°</h1>
                <p class="text-slate-500 text-sm">è¦å‰‡ï¼šæª”åå‰å…©å€‹å­—ç›¸åŒå³ç‚ºä¸€çµ„ï¼ˆæœ€å°‘ 2 çµ„å³å¯é–‹å§‹ï¼‰</p>
            </div>
            <!-- ä¸Šå‚³é é¢çš„é‡æ–°é¸æ“‡æŒ‰éˆ• -->
            <button id="reset-selection-btn" class="hidden absolute top-6 right-6 md:static text-sm bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg transition-colors font-medium flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                æ¸…ç©ºé‡é¸
            </button>
        </div>
        
        <!-- é¸æ“‡æ–¹å¼å€åŸŸ (å·¦å³ä¸¦æ’) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- æ–¹å¼ä¸€ï¼šæ‰‹å‹•ä¸Šå‚³ -->
            <div class="p-8 border-4 border-dashed border-slate-200 rounded-xl hover:border-blue-400 hover:bg-slate-50 transition-colors cursor-pointer text-center group flex flex-col justify-center items-center h-full min-h-[200px]" id="drop-zone">
                <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                <div class="space-y-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-slate-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <div>
                        <p class="text-lg text-slate-600 font-bold mb-1">æ–¹å¼ä¸€</p>
                        <p class="text-sm text-slate-500">é»æ“Šæˆ–æ‹–æ”¾æœ¬æ©Ÿåœ–ç‰‡</p>
                    </div>
                </div>
            </div>

            <!-- æ–¹å¼äºŒï¼šå…§å»ºåœ–åº« -->
            <div id="open-gallery-btn" class="p-8 border-4 border-dashed border-transparent bg-indigo-50 rounded-xl hover:bg-indigo-100 transition-colors cursor-pointer text-center group flex flex-col justify-center items-center h-full min-h-[200px]">
                <div class="space-y-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-indigo-400 group-hover:text-indigo-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <div>
                        <p class="text-lg text-indigo-700 font-bold mb-1">æ–¹å¼äºŒ</p>
                        <p class="text-sm text-indigo-600">å¾å…§å»ºåœ–åº«é¸æ“‡</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- é…å°çµæœé è¦½å€åŸŸ -->
        <div id="file-status" class="hidden space-y-4 border-t pt-6 animate-fade-in">
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-blue-800 font-bold" id="status-summary"></p>
                </div>
                <div id="pair-list" class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-blue-700 max-h-40 overflow-y-auto">
                    <!-- é…å°æ¸…å–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                </div>
            </div>
            
            <div id="error-list" class="text-sm text-red-500 italic"></div>

            <div class="text-center pt-4">
                <button id="start-game-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-12 py-4 rounded-full font-bold shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto">
                    é–‹å§‹éŠæˆ²
                </button>
            </div>
        </div>
    </div>

    <!-- åœ–åº«é¸æ“‡ Modal -->
    <div id="gallery-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">å…§å»ºåœ–åº«é¸æ“‡</h3>
                    <p class="text-sm text-slate-500">ä¾†æºè·¯å¾‘ï¼š./images/ (è«‹é¸æ“‡æˆå°åœ–ç‰‡)</p>
                </div>
                <button id="close-gallery-btn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 bg-slate-100">
                <div id="gallery-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- åœ–åº«åœ–ç‰‡æœƒç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>

            <div class="p-6 border-t bg-white rounded-b-2xl flex justify-between items-center">
                <div class="text-sm text-slate-600">
                    å·²é¸æ“‡ <span id="gallery-selected-count" class="font-bold text-blue-600">0</span> å¼µåœ–ç‰‡
                </div>
                <div class="space-x-2">
                    <button onclick="document.getElementById('gallery-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:text-slate-700">å–æ¶ˆ</button>
                    <button id="confirm-gallery-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded-lg font-bold shadow transition-colors">
                        ç¢ºå®šé¸å–
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒé ï¼šéŠæˆ²ä»‹é¢ -->
    <div id="game-view" class="hidden space-y-6">
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md">
            <div class="flex items-center">
                <span class="text-slate-500">é€²åº¦:</span>
                <span id="progress-text" class="text-xl font-bold text-blue-600 ml-2">1 / 4</span>
            </div>
            <h2 id="game-instruction" class="text-lg font-medium text-slate-700 text-center flex-1 mx-2">è«‹è¨˜ä½é€™äº›å¡ç‰‡...</h2>
            <div>
                <button id="reselect-btn" class="text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1.5 rounded-lg transition-colors font-medium flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    é‡æ–°é¸æ“‡
                </button>
            </div>
        </div>

        <div id="card-grid" class="grid gap-4 min-h-[400px]">
            <!-- å¡ç‰‡æœƒå‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
        </div>

        <div class="flex justify-center space-x-4">
            <button id="memorize-btn" class="bg-amber-500 hover:bg-amber-600 text-white px-10 py-4 rounded-xl font-bold shadow-lg transition-all">
                è¨˜ä½äº†ï¼
            </button>
            <button id="start-search-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-xl font-bold shadow-lg transition-all">
                é–‹å§‹æ‰¾
            </button>
            <button id="next-round-btn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-4 rounded-xl font-bold shadow-lg transition-all">
                æ›ä¸‹ä¸€é¡Œ
            </button>
        </div>
    </div>

    <!-- çµç®—é é¢ -->
    <div id="result-view" class="hidden bg-white rounded-2xl shadow-xl p-12 text-center">
        <h1 class="text-4xl font-bold text-slate-800 mb-4">æŒ‘æˆ°çµæŸï¼</h1>
        <p class="text-xl text-slate-600 mb-8">å¤ªæ£’äº†ï¼ä½ å·²ç¶“è¾¨è­˜å®Œæ‰€æœ‰æ›´æ›éçš„å¡ç‰‡ã€‚</p>
        <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-xl font-bold shadow-lg">
            é‡æ–°ç©
        </button>
    </div>
</div>

<script>
    // é è¨­çš„åœ–åº«æª”æ¡ˆæ¸…å–®
    const BUILT_IN_GALLERY_FILES = [
        "ç©å…·_1.jpg", "ç©å…·_2.jpg",
        "èŠ±æœµA.png", "èŠ±æœµB.png",
        "å°ç‹—-1.jpg", "å°ç‹—-2.jpg",
        "è²“å’ª_å·¦.jpg", "è²“å’ª_å³.jpg",
        "è˜‹æœ_ç´….jpg", "è˜‹æœ_ç¶ .jpg",
        "è»Šå­_èˆŠ.jpg", "è»Šå­_æ–°.jpg",
        "æˆ¿å­_æ—¥.jpg", "æˆ¿å­_å¤œ.jpg",
        "æ¨¹æœ¨_æ˜¥.jpg", "æ¨¹æœ¨_ç§‹.jpg"
    ];
    const GALLERY_PATH = "images/";

    const state = {
        allPairs: {}, 
        currentSet: [], 
        gridCards: [], 
        targetIndex: -1, 
        usedTargetIds: new Set(), 
        stage: 'upload', 
        round: 0,
        maxRounds: 0,
        selectedGalleryFiles: new Set() 
    };

    // DOM å…ƒç´ 
    const uploadView = document.getElementById('upload-view');
    const gameView = document.getElementById('game-view');
    const resultView = document.getElementById('result-view');
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const startBtn = document.getElementById('start-game-btn');
    const cardGrid = document.getElementById('card-grid');
    const memorizeBtn = document.getElementById('memorize-btn');
    const startSearchBtn = document.getElementById('start-search-btn');
    const nextBtn = document.getElementById('next-round-btn');
    const instruction = document.getElementById('game-instruction');
    const progressText = document.getElementById('progress-text');
    const pairListContainer = document.getElementById('pair-list');
    const errorListContainer = document.getElementById('error-list');
    const statusSummary = document.getElementById('status-summary');
    const reselectBtn = document.getElementById('reselect-btn');
    const resetSelectionBtn = document.getElementById('reset-selection-btn');
    
    // Gallery Elements
    const openGalleryBtn = document.getElementById('open-gallery-btn');
    const galleryModal = document.getElementById('gallery-modal');
    const closeGalleryBtn = document.getElementById('close-gallery-btn');
    const confirmGalleryBtn = document.getElementById('confirm-gallery-btn');
    const galleryGrid = document.getElementById('gallery-grid');
    const gallerySelectedCount = document.getElementById('gallery-selected-count');

    // --- Helper: Generate SVG Placeholder ---
    function getPlaceholder(text) {
        // ç”Ÿæˆä¸€å€‹å¸¶æœ‰æ–‡å­—çš„ SVG data URIï¼Œç¢ºä¿åœ–ç‰‡å¤±æ•ˆæ™‚æœ‰æ±è¥¿é¡¯ç¤º
        const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300">
            <rect width="100%" height="100%" fill="#f1f5f9"/>
            <rect width="100%" height="100%" fill="none" stroke="#cbd5e1" stroke-width="4"/>
            <text x="50%" y="40%" font-family="sans-serif" font-size="60" text-anchor="middle" dominant-baseline="middle" fill="#94a3b8">ğŸ–¼ï¸</text>
            <text x="50%" y="65%" font-family="sans-serif" font-size="30" font-weight="bold" text-anchor="middle" dominant-baseline="middle" fill="#475569">${text}</text>
            <text x="50%" y="80%" font-family="sans-serif" font-size="14" text-anchor="middle" fill="#94a3b8">(åœ–ç‰‡æœªæ‰¾åˆ°)</text>
        </svg>`.trim();
        return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
    }

    // --- Event Listeners ---
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(Array.from(e.target.files), 'upload');

    startBtn.onclick = () => {
        if (Object.keys(state.allPairs).length < 2) return;
        initGame();
        showView('game');
    };

    memorizeBtn.onclick = () => startHiding();
    startSearchBtn.onclick = () => startSearching();
    nextBtn.onclick = () => setupRound();
    reselectBtn.onclick = () => showView('upload');
    resetSelectionBtn.onclick = resetUploadState;

    openGalleryBtn.onclick = openGallery;
    closeGalleryBtn.onclick = () => galleryModal.classList.add('hidden');
    confirmGalleryBtn.onclick = handleGalleryConfirm;

    // --- Logic ---
    function resetUploadState() {
        state.allPairs = {};
        state.selectedGalleryFiles.clear();
        pairListContainer.innerHTML = '';
        errorListContainer.innerHTML = '';
        statusSummary.innerText = '';
        fileInput.value = '';
        
        document.getElementById('file-status').classList.add('hidden');
        resetSelectionBtn.classList.add('hidden');
    }

    function openGallery() {
        updateGalleryUI();
        renderGalleryGrid();
        galleryModal.classList.remove('hidden');
    }

    function renderGalleryGrid() {
        galleryGrid.innerHTML = '';
        BUILT_IN_GALLERY_FILES.forEach(filename => {
            const isSelected = state.selectedGalleryFiles.has(filename);
            const div = document.createElement('div');
            div.className = `gallery-item relative border-2 rounded-lg overflow-hidden cursor-pointer transition-all h-32 bg-gray-100 ${isSelected ? 'selected' : 'border-slate-200 hover:border-blue-300'}`;
            div.onclick = () => toggleGallerySelection(filename);

            const src = `${GALLERY_PATH}${filename}`;
            // ç¸®åœ–ä¹ŸåŠ ä¸Š placeholder æ©Ÿåˆ¶
            div.innerHTML = `
                <img src="${src}" 
                     alt="${filename}" 
                     class="w-full h-full object-cover"
                     onerror="this.onerror=null; this.src='${getPlaceholder(filename.split('.')[0])}'">
                <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs p-1 truncate text-center">
                    ${filename}
                </div>
            `;
            galleryGrid.appendChild(div);
        });
    }

    function toggleGallerySelection(filename) {
        if (state.selectedGalleryFiles.has(filename)) {
            state.selectedGalleryFiles.delete(filename);
        } else {
            state.selectedGalleryFiles.add(filename);
        }
        updateGalleryUI();
        renderGalleryGrid(); 
    }

    function updateGalleryUI() {
        gallerySelectedCount.innerText = state.selectedGalleryFiles.size;
    }

    function handleGalleryConfirm() {
        const selectedFiles = Array.from(state.selectedGalleryFiles);
        if (selectedFiles.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡åœ–ç‰‡ï¼");
            return;
        }

        const tempMap = {};
        const errors = [];

        selectedFiles.forEach(filename => {
            const baseName = filename.substring(0, 2); 
            if (!tempMap[baseName]) tempMap[baseName] = [];
            tempMap[baseName].push(filename);
        });

        const validPairs = {};
        let validCount = 0;

        for (const [key, files] of Object.entries(tempMap)) {
            if (files.length === 2) {
                validPairs[key] = files.map(f => `${GALLERY_PATH}${f}`);
                validCount++;
            } else {
                errors.push(`ã€Œ${key}ã€ç³»åˆ—é¸æ“‡äº† ${files.length} å¼µ (å¿…é ˆå‰›å¥½ 2 å¼µ)`);
            }
        }

        if (errors.length > 0) {
            alert(`ç„¡æ³•é–‹å§‹éŠæˆ²ï¼Œç™¼ç¾ä»¥ä¸‹éŒ¯èª¤ï¼š\n\n${errors.join('\n')}\n\nè«‹ç¢ºä¿æ¯ä¸€çµ„éƒ½å‰›å¥½é¸æ“‡äº† 2 å¼µåœ–ç‰‡ã€‚`);
            return;
        }

        if (validCount < 2) {
            alert("é…å°çµ„æ•¸ä¸è¶³ï¼æœ€å°‘éœ€è¦é¸æ“‡ 2 çµ„ (å…± 4 å¼µ) å®Œæ•´é…å°çš„åœ–ç‰‡æ‰èƒ½é–‹å§‹éŠæˆ²ã€‚");
            return;
        }

        state.allPairs = validPairs;
        updateFileStatusUI(validPairs, [], validCount);
        galleryModal.classList.add('hidden');
    }

    function handleFiles(files, type) {
        if (files.length === 0) return;
        const tempMap = {};
        files.forEach(file => {
            const baseName = file.name.substring(0, 2);
            if (!tempMap[baseName]) tempMap[baseName] = [];
            tempMap[baseName].push(URL.createObjectURL(file));
        });
        processPairs(tempMap);
    }

    function processPairs(tempMap) {
        const validPairs = {};
        const singles = [];
        let pairCount = 0;

        for (const word in tempMap) {
            if (tempMap[word].length >= 2) {
                validPairs[word] = [tempMap[word][0], tempMap[word][1]];
                pairCount++;
            } else {
                singles.push(word);
            }
        }
        state.allPairs = validPairs;
        updateFileStatusUI(validPairs, singles, pairCount);
    }

    function updateFileStatusUI(pairs, singles, count) {
        pairListContainer.innerHTML = '';
        errorListContainer.innerHTML = '';
        document.getElementById('file-status').classList.remove('hidden');
        resetSelectionBtn.classList.remove('hidden');

        for (const word in pairs) {
            const item = document.createElement('div');
            item.innerHTML = `âœ… ${word}... (2å¼µ)`;
            pairListContainer.appendChild(item);
        }

        if (singles.length > 0) {
            errorListContainer.innerText = `æ³¨æ„ï¼šä»¥ä¸‹é–‹é ­çš„æª”æ¡ˆåªæœ‰ 1 å¼µï¼Œç„¡æ³•æˆå°ï¼š${singles.join(', ')}`;
        }

        if (count >= 2) {
            statusSummary.innerText = `ç›®å‰å·²æº–å‚™å¥½ ${count} çµ„é…å°ï¼`;
            statusSummary.className = "text-green-600 font-bold mb-2";
            startBtn.disabled = false;
        } else {
            statusSummary.innerText = `ç›®å‰åƒ…æœ‰ ${count} çµ„é…å°ï¼Œé‚„å·® ${2 - count} çµ„æ‰èƒ½é–‹å§‹ã€‚`;
            statusSummary.className = "text-amber-600 font-bold mb-2";
            startBtn.disabled = true;
        }
    }

    function showView(viewName) {
        uploadView.classList.add('hidden');
        gameView.classList.add('hidden');
        resultView.classList.add('hidden');
        if (viewName === 'upload') uploadView.classList.remove('hidden');
        if (viewName === 'game') gameView.classList.remove('hidden');
        if (viewName === 'result') resultView.classList.remove('hidden');
    }

    function initGame() {
        const keys = Object.keys(state.allPairs);
        const shuffled = keys.sort(() => 0.5 - Math.random());
        const cardCount = Math.min(keys.length, 6);
        state.currentSet = shuffled.slice(0, cardCount);
        state.maxRounds = cardCount;
        state.usedTargetIds.clear();
        state.round = 0;
        
        cardGrid.className = "grid gap-4 min-h-[400px]";
        if (cardCount <= 4) {
            cardGrid.classList.add("grid-cols-2");
        } else {
            cardGrid.classList.add("grid-cols-3");
        }

        setupRound();
    }

    function setupRound() {
        state.round++;
        state.stage = 'memorizing';
        instruction.innerText = "è«‹è¨˜ä½é€™äº›å¡ç‰‡...";
        progressText.innerText = `${state.round} / ${state.maxRounds}`;
        
        memorizeBtn.classList.remove('hidden');
        startSearchBtn.classList.add('hidden');
        nextBtn.classList.add('hidden');

        const displayOrder = [...state.currentSet].sort(() => 0.5 - Math.random());
        
        state.gridCards = displayOrder.map(word => ({
            word: word,
            currentUrl: state.allPairs[word][0], 
            version: 0 
        }));

        renderGrid(false);
    }

    function renderGrid(isFlipped) {
        cardGrid.innerHTML = '';
        state.gridCards.forEach((card, index) => {
            const container = document.createElement('div');
            container.className = `card-container relative w-full h-64 cursor-pointer ${isFlipped ? 'card-flipped' : ''}`;
            container.onclick = () => handleCardClick(index);

            const cardInner = document.createElement('div');
            cardInner.className = 'card-inner w-full h-full shadow-lg rounded-xl';

            const cardFront = document.createElement('div');
            cardFront.className = 'card-front bg-white p-2 border border-slate-200 relative';
            
            const img = document.createElement('img');
            img.className = 'w-full h-full object-contain rounded-lg transition-opacity duration-300';
            img.alt = card.word;
            
            // é‡è¦ä¿®æ­£ï¼šå…ˆè¨­å®š onerrorï¼Œå†è¨­å®š srcï¼Œç¢ºä¿å¦‚æœæª”æ¡ˆæ‰¾ä¸åˆ°èƒ½é¦¬ä¸Šè§¸ç™¼æ›¿ä»£æ–¹æ¡ˆ
            img.onerror = function() {
                // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå°‡ src æ›æˆç”Ÿæˆçš„ SVG ä½”ä½åœ–
                this.onerror = null; // é¿å…ç„¡çª®è¿´åœˆ
                this.src = getPlaceholder(card.word);
            };
            img.onload = function() {
                // åœ–ç‰‡è¼‰å…¥æˆåŠŸ
                this.style.display = 'block';
            };
            
            // æœ€å¾Œæ‰è¨­å®š src
            img.src = card.currentUrl;

            cardFront.appendChild(img);

            const cardBack = document.createElement('div');
            cardBack.className = 'card-back border-4 border-white';
            cardBack.innerHTML = '<span class="text-4xl">?</span>';

            cardInner.appendChild(cardFront);
            cardInner.appendChild(cardBack);
            container.appendChild(cardInner);

            const feedback = document.createElement('div');
            feedback.id = `feedback-${index}`;
            feedback.className = 'result-overlay opacity-0 transition-opacity';
            
            container.appendChild(feedback);
            cardGrid.appendChild(container);
        });
    }

    function startHiding() {
        state.stage = 'hidden';
        instruction.innerText = "æ­£åœ¨è®Šæ›ä¸­...";
        memorizeBtn.classList.add('hidden');
        
        const containers = document.querySelectorAll('.card-container');
        containers.forEach(c => c.classList.add('card-flipped'));

        const availableIndices = [];
        state.gridCards.forEach((card, idx) => {
            if (!state.usedTargetIds.has(card.word)) {
                availableIndices.push(idx);
            }
        });

        const targetIdx = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        state.targetIndex = targetIdx;
        state.usedTargetIds.add(state.gridCards[targetIdx].word);

        setTimeout(() => {
            const targetCard = state.gridCards[targetIdx];
            targetCard.version = 1;
            targetCard.currentUrl = state.allPairs[targetCard.word][1];
            
            // æ›´æ–°åœ–ç‰‡
            const container = containers[targetIdx];
            const img = container.querySelector('img');
            
            // é‡æ–°ç¶å®šéŒ¯èª¤è™•ç†ï¼Œå› ç‚ºè·¯å¾‘æ”¹è®Šäº†ï¼Œå¯èƒ½æ–°è·¯å¾‘ä¹Ÿä¸å­˜åœ¨
            img.onerror = function() {
                this.onerror = null;
                this.src = getPlaceholder(targetCard.word);
            };
            
            img.src = targetCard.currentUrl;

            instruction.innerText = "è®Šæ›å®Œæˆï¼";
            startSearchBtn.classList.remove('hidden');
        }, 800);
    }

    function startSearching() {
        state.stage = 'searching';
        instruction.innerText = "å“ªä¸€å¼µå¡ç‰‡è¢«æ›éäº†ï¼Ÿ";
        startSearchBtn.classList.add('hidden');

        const containers = document.querySelectorAll('.card-container');
        containers.forEach(c => c.classList.remove('card-flipped'));
    }

    function handleCardClick(index) {
        if (state.stage !== 'searching') return;

        const feedback = document.getElementById(`feedback-${index}`);
        feedback.classList.remove('opacity-0');

        if (index === state.targetIndex) {
            feedback.innerHTML = `
                <svg viewBox="0 0 100 100" class="w-32 h-32 text-green-500 fill-current">
                    <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="8" fill="none" />
                </svg>
            `;
            instruction.innerText = "ç­”å°äº†ï¼å¤ªå²å®³äº†ï¼";
            state.stage = 'result';
            
            setTimeout(() => {
                if (state.usedTargetIds.size >= state.maxRounds) {
                    showView('result');
                } else {
                    nextBtn.classList.remove('hidden');
                }
            }, 600);
        } else {
            feedback.innerHTML = `
                <svg viewBox="0 0 100 100" class="w-32 h-32 text-red-500">
                    <line x1="20" y1="20" x2="80" y2="80" stroke="currentColor" stroke-width="12" stroke-linecap="round" />
                    <line x1="80" y1="20" x2="20" y2="80" stroke="currentColor" stroke-width="12" stroke-linecap="round" />
                </svg>
            `;
            instruction.innerText = "ç­”éŒ¯å›‰ï¼Œå†ä»”ç´°çœ‹çœ‹ï¼";
        }
    }
</script>
</body>
</html>