<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>數學小偵探：兩步驟併式挑戰</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation; 
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .correct-pulse { animation: success-pulse 0.5s ease-out; }
        @keyframes success-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #dcfce7; }
            100% { transform: scale(1); }
        }
        .wrong-shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        /* 避免長按選取文字 */
        .select-none {
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-sky-50 text-slate-800 select-none overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 內聯 SVG 圖示 (解決 Lucide 造成的崩潰問題) ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            Calculator: (props) => <IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            Star: (props) => <IconWrapper {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
            Home: (props) => <IconWrapper {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>,
            BookOpen: (props) => <IconWrapper {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>,
            ClipboardCheck: (props) => <IconWrapper {...props}><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></IconWrapper>,
            Gamepad2: (props) => <IconWrapper {...props}><line x1="6" x2="10" y1="12" y2="12"/><line x1="8" x2="8" y1="10" y2="14"/><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="17" cy="10" r="1"/><circle cx="15" cy="13" r="1"/></IconWrapper>,
            ArrowLeft: (props) => <IconWrapper {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>,
            Puzzle: (props) => <IconWrapper {...props}><path d="M20 7h-9.5c-1.93 0-3.5 1.57-3.5 3.5S8.57 14 10.5 14H20"/><path d="M4 17h9.5c1.93 0 3.5-1.57 3.5-3.5S15.43 10 13.5 10H4"/><path d="M15 22v-5"/><path d="M9 2v5"/></IconWrapper>,
            ChevronRight: (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            Lightbulb: (props) => <IconWrapper {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2.2 1.5 3.1.7.8 1.3 1.5 1.5 2.4"/><path d="M9 18h6"/><path d="M10 22h4"/></IconWrapper>,
            CheckCircle: (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>,
            Trophy: (props) => <IconWrapper {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconWrapper>,
            Timer: (props) => <IconWrapper {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconWrapper>,
            Rocket: (props) => <IconWrapper {...props}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4.5c1.62-1.62 5-2.5 5-2.5"/><path d="M12 15v5s3.03-.55 4.5-2c1.62-1.62 2.5-5 2.5-5"/></IconWrapper>
        };

        // --- 題目數據 ---
        const UNIT_DATA = [
            {
                id: 'unit1',
                title: '加減兩步驟',
                description: '學習如何把加法和減法合在一起算。',
                questions: [
                    { q: "小明有 100 元，買了 35 元的麵包和 20 元的飲料，還剩下多少元？", options: ["100 - 35 + 20 = 85", "100 - (35 + 20) = 45", "100 - 35 - 20 = 45", "後兩個算式都可以"], ans: 3 },
                    { q: "停車場原本有 50 輛車，開走了 12 輛，又開進來 8 輛，現在有幾輛？", options: ["50 - 12 + 8 = 46", "50 - (12 + 8) = 30", "50 + 12 - 8 = 54", "46 輛"], ans: 0 },
                    { q: "麵包店早上做了 80 個麵包，下午賣掉 45 個，晚上又做了 30 個，現在有幾個？", options: ["80 - 45 + 30 = 65", "80 + 45 - 30 = 95", "80 - (45 + 30) = 5", "65 個"], ans: 0 },
                    { q: "一箱蘋果有 24 個，爸爸拿走 8 個，媽媽也拿走 6 個，還剩幾個？", options: ["24 - 8 + 6 = 22", "24 - 8 - 6 = 10", "24 - (8 + 6) = 10", "後兩個算式都可以"], ans: 3 },
                    { q: "籃子裡有 15 個紅球和 12 個綠球，拿走 7 個球後，還剩幾個？", options: ["(15 + 12) - 7 = 20", "15 + 12 - 7 = 20", "15 - 7 + 12 = 20", "以上皆是"], ans: 3 },
                    { q: "書架上有 45 本書，借出 15 本，還回 5 本，書架上現在有幾本書？", options: ["45 - 15 - 5 = 25", "45 - (15 - 5) = 35", "45 - 15 + 5 = 35", "35 本"], ans: 2 }
                ]
            },
            {
                id: 'unit2',
                title: '乘除兩步驟',
                description: '挑戰連乘或連除的併式問題。',
                questions: [
                    { q: "一條繩子長 48 公尺，平分成 4 段，每段再平分成 2 小段，一小段長幾公尺？", options: ["48 ÷ 4 ÷ 2 = 6", "48 ÷ (4 × 2) = 6", "48 ÷ 4 × 2 = 24", "前兩個都對"], ans: 3 },
                    { q: "一包餅乾有 8 片，買 5 包裝成一盒，買 3 盒共有幾片餅乾？", options: ["8 × 5 × 3 = 120", "8 × (5 + 3) = 64", "8 + 5 + 3 = 16", "120 片"], ans: 0 },
                    { q: "40 個橘子，每 5 個裝一袋，每 2 袋裝一箱，可以裝成幾箱？", options: ["40 ÷ 5 ÷ 2 = 4", "40 ÷ 5 × 2 = 16", "40 ÷ (5 + 2) = 5.7", "4 箱"], ans: 0 },
                    { q: "一枝鉛筆 12 元，買一打（12 枝）裝成一盒。買 3 盒送給 3 個小朋友，每人分到幾元？", options: ["12 × 12 × 3 ÷ 3 = 144", "12 ÷ 3 × 12 = 48", "12 × 12 = 144", "144 元"], ans: 0 },
                    { q: "操場一圈 200 公尺，小強跑了 3 圈，小明跑的是小強的 2 倍，小明跑幾公尺？", options: ["200 × 3 × 2 = 1200", "200 × (3 + 2) = 1000", "200 ÷ 3 × 2 = 133", "1200 公尺"], ans: 0 },
                    { q: "有 72 顆巧克力，每 6 顆裝一包，每 3 包裝一盒，可以裝幾盒？", options: ["72 ÷ 6 ÷ 3 = 4", "72 ÷ (6 × 3) = 4", "72 ÷ 6 × 3 = 36", "前兩個都對"], ans: 3 }
                ]
            },
            {
                id: 'unit3',
                title: '括號與順序',
                description: '什麼時候要加括號？先乘除後加減！',
                questions: [
                    { q: "混合算式中如果沒有括號，應該先算什麼？", options: ["從左往右算", "先加減後乘除", "先乘除後加減", "看心情算"], ans: 2 },
                    { q: "計算 50 + 20 × 2 的正確結果是多少？", options: ["140 (先算加法)", "90 (先算乘法)", "70", "120"], ans: 1 },
                    { q: "如果要「先算加法 50+20」，正確的併式應該怎麼寫？", options: ["50 + 20 × 2", "(50 + 20) × 2", "50 + (20 × 2)", "不需要括號"], ans: 1 },
                    { q: "小芳有 200 元，買了 3 枝各 25 元的筆，還剩多少元？", options: ["(200 - 3) × 25", "200 - 3 × 25", "200 - 25 - 25 - 25", "後兩個都對"], ans: 3 },
                    { q: "一個麵包 15 元，一瓶牛奶 20 元，各買 4 個，總共幾元？", options: ["15 + 20 × 4", "(15 + 20) × 4", "15 × 4 + 20 × 4", "後兩個都對"], ans: 3 },
                    { q: "計算 100 - (60 ÷ 5) 的結果是多少？", options: ["8", "88", "40", "20"], ans: 1 }
                ]
            }
        ];

        // --- 主程式元件 ---
        const App = () => {
            const [view, setView] = useState('home'); 
            const [currentUnit, setCurrentUnit] = useState(null);
            const [score, setScore] = useState(0);

            return (
                <div className="min-h-screen flex flex-col max-w-md mx-auto bg-white shadow-2xl relative overflow-hidden">
                    {/* 頂部標題 */}
                    <header className="p-4 flex justify-between items-center bg-sky-600 text-white z-20 shadow-lg">
                        <div className="flex items-center gap-2" onClick={() => setView('home')}>
                            <div className="bg-white/20 p-1.5 rounded-lg cursor-pointer">
                                <Icons.Calculator size={20} />
                            </div>
                            <h1 className="font-bold text-lg tracking-tight cursor-pointer">兩步驟併式挑戰</h1>
                        </div>
                        <div className="flex items-center bg-sky-700/50 px-3 py-1 rounded-full border border-sky-400/30">
                            <Icons.Star size={16} className="text-yellow-300 mr-1.5 fill-yellow-300" />
                            <span className="font-bold text-sm">{score}</span>
                        </div>
                    </header>

                    {/* 內容區 */}
                    <main className="flex-1 overflow-y-auto p-4 pb-24 bg-sky-50/50">
                        {view === 'home' && <HomeView setView={setView} setCurrentUnit={setCurrentUnit} />}
                        {view === 'learn' && <LearnView onBack={() => setView('home')} />}
                        {view === 'practice' && <PracticeView unit={currentUnit} onBack={() => setView('home')} setScore={setScore} />}
                        {view === 'assessment' && <AssessmentView setScore={setScore} onBack={() => setView('home')} />}
                        {view === 'game' && <MathGame onBack={() => setView('home')} setScore={setScore} />}
                    </main>

                    {/* 底部導覽列 */}
                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-slate-100 p-2 pb-safe flex justify-around items-center z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                        <NavBtn active={view === 'home'} icon="Home" label="主頁" onClick={() => setView('home')} />
                        <NavBtn active={view === 'learn'} icon="BookOpen" label="學習" onClick={() => setView('learn')} />
                        <NavBtn active={view === 'assessment'} icon="ClipboardCheck" label="測驗" onClick={() => setView('assessment')} />
                        <NavBtn active={view === 'game'} icon="Gamepad2" label="遊戲" onClick={() => setView('game')} />
                    </nav>
                </div>
            );
        };

        const NavBtn = ({ active, icon, label, onClick }) => {
            const IconComp = Icons[icon];
            return (
                <button onClick={onClick} className={`flex flex-col items-center p-2 rounded-xl transition-all duration-300 ${active ? 'text-sky-600 scale-110' : 'text-slate-400'}`}>
                    <IconComp size={22} className={active ? "stroke-[3px]" : ""} />
                    <span className={`text-[10px] font-bold mt-1 ${active ? 'opacity-100' : 'opacity-60'}`}>{label}</span>
                </button>
            );
        };

        // --- 視圖: 主頁 ---
        const HomeView = ({ setView, setCurrentUnit }) => (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="bg-gradient-to-br from-sky-500 to-indigo-600 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                    <div className="relative z-10">
                        <h2 className="text-2xl font-black mb-2">你好，數學偵探！</h2>
                        <p className="text-sky-100 text-sm leading-relaxed opacity-90">準備好挑戰複雜的數學算式了嗎？先看教學影片，再開始練習吧！</p>
                        <button onClick={() => setView('learn')} className="mt-4 bg-white text-sky-600 px-6 py-2 rounded-full font-bold text-sm shadow-lg active:scale-95 transition-all">開始學習</button>
                    </div>
                    <Icons.Rocket size={100} className="absolute -right-4 -bottom-4 text-white/10 rotate-12" />
                </div>

                <div className="grid grid-cols-1 gap-4">
                    <h3 className="font-bold text-slate-700 flex items-center gap-2 ml-1">
                        <Icons.Puzzle size={18} className="text-sky-500" /> 練習單元 (每個單元 6 題)
                    </h3>
                    {UNIT_DATA.map((unit) => (
                        <div key={unit.id} onClick={() => { setCurrentUnit(unit); setView('practice'); }} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4 hover:border-sky-300 active:scale-[0.98] transition-all cursor-pointer group">
                            <div className="bg-sky-100 text-sky-600 p-3 rounded-xl group-hover:bg-sky-500 group-hover:text-white transition-colors">
                                <Icons.Puzzle size={24} />
                            </div>
                            <div className="flex-1">
                                <h4 className="font-bold text-slate-800">{unit.title}</h4>
                                <p className="text-xs text-slate-500">{unit.description}</p>
                            </div>
                            <Icons.ChevronRight size={20} className="text-slate-300" />
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- 視圖: 學習 ---
        const LearnView = ({ onBack }) => (
            <div className="space-y-6 animate-in fade-in duration-500">
                <div className="flex items-center gap-3">
                    <button onClick={onBack} className="p-2 bg-white rounded-xl shadow-sm"><Icons.ArrowLeft size={20} /></button>
                    <h2 className="text-xl font-bold text-slate-800">觀念小講堂</h2>
                </div>

                <div className="bg-black rounded-2xl overflow-hidden shadow-2xl ring-4 ring-sky-100">
                    <div className="aspect-video relative">
                        <iframe 
                            width="100%" 
                            height="100%" 
                            src="https://www.youtube.com/embed/nU6q3WcEovs" 
                            title="數學教學" 
                            frameBorder="0" 
                            allowFullScreen
                            className="absolute inset-0"
                        ></iframe>
                    </div>
                </div>

                <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 space-y-4">
                    <h3 className="font-bold text-lg text-sky-700 flex items-center gap-2">
                        <Icons.Lightbulb size={20} className="text-yellow-500" /> 併式重點筆記
                    </h3>
                    <ul className="space-y-3">
                        <li className="flex gap-3 items-start">
                            <div className="bg-sky-100 text-sky-600 px-2 py-0.5 rounded text-xs font-bold mt-1">1</div>
                            <p className="text-slate-600 text-sm underline decoration-sky-200 underline-offset-4">算式要從左往右算。</p>
                        </li>
                        <li className="flex gap-3 items-start">
                            <div className="bg-sky-100 text-sky-600 px-2 py-0.5 rounded text-xs font-bold mt-1">2</div>
                            <p className="text-slate-600 text-sm">遇到 <span className="font-bold text-red-500">括號 ( )</span> 裡面的內容，一定要<span className="font-bold text-sky-600">最先算</span>！</p>
                        </li>
                        <li className="flex gap-3 items-start">
                            <div className="bg-sky-100 text-sky-600 px-2 py-0.5 rounded text-xs font-bold mt-1">3</div>
                            <p className="text-slate-600 text-sm">混合算式中，要先算<span className="font-bold">乘除</span>，再算<span className="font-bold">加減</span>。</p>
                        </li>
                    </ul>
                </div>
            </div>
        );

        // --- 視圖: 練習單元 (已修復畫面空白問題) ---
        const PracticeView = ({ unit, onBack, setScore }) => {
            const [idx, setIdx] = useState(0);
            const [feedback, setFeedback] = useState(null); 
            const [showResult, setShowResult] = useState(false);

            const handleAnswer = (ansIdx) => {
                if (feedback) return;
                const isCorrect = ansIdx === unit.questions[idx].ans;
                setFeedback(isCorrect ? 'correct' : 'wrong');
                
                if (isCorrect) {
                    setScore(s => s + 10);
                }

                // 設定延遲，讓學生看清楚正確答案後再跳下一題
                setTimeout(() => {
                    if (idx < unit.questions.length - 1) {
                        setIdx(prev => prev + 1);
                        setFeedback(null);
                    } else {
                        setShowResult(true);
                    }
                }, 1200);
            };

            if (showResult) return (
                <div className="text-center py-10 space-y-6 animate-in zoom-in duration-300">
                    <div className="inline-block p-6 bg-yellow-100 rounded-full mb-4 shadow-xl"><Icons.Trophy size={80} className="text-yellow-600" /></div>
                    <h2 className="text-3xl font-black text-slate-800">挑戰完成！</h2>
                    <p className="text-slate-500">你已經掌握了 {unit.title} 的所有練習題。</p>
                    <button onClick={onBack} className="w-full bg-sky-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all">返回選單</button>
                </div>
            );

            const q = unit.questions[idx];

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <button onClick={onBack} className="p-2 bg-white rounded-xl shadow-sm"><Icons.ArrowLeft size={20} /></button>
                        <div className="text-xs font-bold text-slate-400 tracking-widest bg-white px-3 py-1 rounded-full shadow-sm">
                            第 {idx + 1} / {unit.questions.length} 題
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl p-6 shadow-md border-2 border-sky-100 min-h-[140px] flex items-center justify-center text-center">
                        <h3 className="text-lg font-bold text-slate-700 leading-relaxed">{q.q}</h3>
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                        {q.options.map((opt, i) => (
                            <button 
                                key={`opt-${idx}-${i}`} 
                                onClick={() => handleAnswer(i)}
                                disabled={!!feedback}
                                className={`w-full p-4 rounded-2xl text-left font-bold border-2 transition-all duration-200 flex items-center justify-between
                                    ${feedback === 'correct' && i === q.ans ? 'bg-green-100 border-green-500 text-green-700 correct-pulse' : 
                                      feedback === 'wrong' && i === q.ans && feedback ? 'bg-green-50 border-green-200 text-green-700 opacity-60' :
                                      feedback === 'wrong' && i !== q.ans && feedback ? 'bg-red-50 border-red-200 text-red-700 opacity-40' :
                                      'bg-white border-slate-100 hover:border-sky-300 text-slate-600 shadow-sm active:bg-sky-50'}`}
                            >
                                <span className="flex-1">{opt}</span>
                                {feedback === 'correct' && i === q.ans && <Icons.CheckCircle size={20} className="text-green-500 flex-shrink-0" />}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 視圖: 綜合測驗 ---
        const AssessmentView = ({ setScore, onBack }) => {
            const [step, setStep] = useState(0); 
            const [qIdx, setQIdx] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            
            const questions = useMemo(() => {
                // 從三個單元隨機各挑 2 題，總共 6 題
                return UNIT_DATA.flatMap(u => {
                    const shuffled = [...u.questions].sort(() => Math.random() - 0.5);
                    return shuffled.slice(0, 2);
                }).sort(() => Math.random() - 0.5);
            }, []);

            const handleAns = (idx) => {
                const newAnswers = [...userAnswers, idx];
                setUserAnswers(newAnswers);
                if (qIdx < questions.length - 1) {
                    setQIdx(qIdx + 1);
                } else {
                    const finalScore = newAnswers.reduce((acc, curr, i) => acc + (curr === questions[i].ans ? 1 : 0), 0);
                    setScore(s => s + finalScore * 10);
                    setStep(2);
                }
            };

            if (step === 0) return (
                <div className="text-center py-10 space-y-8 animate-in fade-in duration-500">
                    <div className="inline-block p-6 bg-sky-100 rounded-full text-sky-600"><Icons.ClipboardCheck size={60} /></div>
                    <div className="space-y-2">
                        <h2 className="text-2xl font-black text-slate-800">單元綜合測驗</h2>
                        <p className="text-slate-500">隨機抽取 6 題，考驗你的併式實力！</p>
                    </div>
                    <button onClick={() => setStep(1)} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-all">準備好了，開始！</button>
                </div>
            );

            if (step === 2) {
                const correctCount = userAnswers.reduce((acc, curr, i) => acc + (curr === questions[i].ans ? 1 : 0), 0);
                return (
                    <div className="text-center py-10 space-y-6">
                        <h2 className="text-3xl font-black">測驗結果</h2>
                        <div className="bg-white p-8 rounded-full border-8 border-sky-100 w-48 h-48 mx-auto flex flex-col items-center justify-center shadow-inner">
                            <span className="text-5xl font-black text-sky-600">{Math.round((correctCount/questions.length)*100)}</span>
                            <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Score</span>
                        </div>
                        <p className="text-slate-500 font-medium">答對 {correctCount} / {questions.length} 題</p>
                        <button onClick={onBack} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">返回主頁</button>
                    </div>
                );
            }

            const q = questions[qIdx];
            return (
                <div className="space-y-6">
                    <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                        <div className="bg-sky-500 h-full transition-all duration-300" style={{ width: `${(qIdx / questions.length) * 100}%` }}></div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-800 text-center px-4 leading-relaxed">{q.q}</h3>
                    <div className="grid grid-cols-1 gap-3">
                        {q.options.map((opt, i) => (
                            <button key={i} onClick={() => handleAns(i)} className="bg-white p-4 rounded-2xl border-2 border-slate-100 hover:border-indigo-400 font-bold text-slate-600 text-left transition-all active:scale-95">
                                {opt}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 視圖: 小遊戲 ---
        const MathGame = ({ onBack, setScore }) => {
            const [gameState, setGameState] = useState('start'); 
            const [num1, setNum1] = useState(0);
            const [num2, setNum2] = useState(0);
            const [operator, setOperator] = useState('+');
            const [target, setTarget] = useState(0);
            const [options, setOptions] = useState([]);
            const [timeLeft, setTimeLeft] = useState(30);
            const [streak, setStreak] = useState(0);

            const generateQuestion = () => {
                const op = Math.random() > 0.5 ? '+' : '-';
                const n1 = Math.floor(Math.random() * 50) + 10;
                const n2 = Math.floor(Math.random() * 10) + 1;
                
                const res = op === '+' ? (n1 + n2) : (n1 - n2);
                setNum1(n1);
                setNum2(n2);
                setOperator(op);
                setTarget(res);

                const opts = [res, res + 5, res - 5, res + 10].sort(() => Math.random() - 0.5);
                setOptions([...new Set(opts)]);
            };

            useEffect(() => {
                if (gameState === 'playing') {
                    generateQuestion();
                    const timer = setInterval(() => {
                        setTimeLeft(t => {
                            if (t <= 1) {
                                setGameState('end');
                                clearInterval(timer);
                                return 0;
                            }
                            return t - 1;
                        });
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [gameState]);

            const handleAns = (val) => {
                if (val === target) {
                    setStreak(s => s + 1);
                    setScore(s => s + 5);
                    generateQuestion();
                } else {
                    setStreak(0);
                    generateQuestion();
                }
            };

            if (gameState === 'start') return (
                <div className="text-center py-10 space-y-6">
                    <div className="text-7xl animate-bounce">⚡</div>
                    <h2 className="text-3xl font-black">極速併式王</h2>
                    <p className="text-slate-500">在 30 秒內答對越多題越好！</p>
                    <button onClick={() => setGameState('playing')} className="w-full bg-yellow-500 text-white py-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all">立即開戰！</button>
                    <button onClick={onBack} className="text-slate-400 font-bold block mx-auto py-2">返回</button>
                </div>
            );

            if (gameState === 'end') return (
                <div className="text-center py-10 space-y-6">
                    <h2 className="text-3xl font-black text-slate-800">時間到！</h2>
                    <div className="bg-white p-6 rounded-3xl shadow-lg">
                        <p className="text-sm text-slate-400">總連擊數</p>
                        <p className="text-6xl font-black text-yellow-500">{streak}</p>
                    </div>
                    <button onClick={() => { setGameState('playing'); setTimeLeft(30); setStreak(0); }} className="w-full bg-sky-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">再玩一次</button>
                    <button onClick={onBack} className="w-full border-2 border-slate-200 py-4 rounded-2xl font-bold text-slate-400">離開遊戲</button>
                </div>
            );

            return (
                <div className="space-y-8 py-4">
                    <div className="flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
                        <div className="flex items-center gap-2">
                            <Icons.Timer size={18} className="text-red-500" />
                            <span className="font-mono text-xl font-bold text-slate-700">{timeLeft}s</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-400 uppercase">Streak</span>
                            <span className="bg-yellow-100 text-yellow-700 px-3 py-0.5 rounded-full font-black">{streak}</span>
                        </div>
                    </div>

                    <div className="bg-white p-10 rounded-3xl shadow-xl text-center border-4 border-sky-500">
                        <div className="text-5xl font-black text-slate-800 tracking-wider">
                            {num1} {operator} {num2} = ?
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        {options.map((opt, i) => (
                            <button key={i} onClick={() => handleAns(opt)} className="bg-white py-8 rounded-3xl border-b-8 border-slate-200 active:border-b-0 active:translate-y-2 transition-all text-3xl font-black text-slate-700 hover:bg-sky-50">
                                {opt}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>