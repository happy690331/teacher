<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº·è»’åœ‹èªå…­ä¸Š7-12èª²å°æœ‹å‹ä¸‹æ¨“æ¢¯</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* ä»‹é¢å®¹å™¨ */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #ffffff;
            border: 8px solid #334155;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 15px;
            width: 100%;
            max-width: 480px;
            box-sizing: border-box;
            position: relative;
            margin-bottom: 50px;
        }

        h1 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 1.2rem;
            text-shadow: 1px 1px 0 #94a3b8;
            text-align: center;
            line-height: 1.4;
        }

        /* å…±ç”¨çš„ç£šç‰†æ¨£å¼ */
        .brick-bg {
            background-color: #8b4513;
            background-image: 
                linear-gradient(335deg, #a0522d 23px, transparent 23px),
                linear-gradient(155deg, #a0522d 23px, transparent 23px),
                linear-gradient(335deg, #a0522d 23px, transparent 23px),
                linear-gradient(155deg, #a0522d 23px, transparent 23px);
            background-size: 58px 58px;
            /* åˆå§‹èƒŒæ™¯ä½ç½®ï¼ŒJS æœƒå‹•æ…‹ä¿®æ”¹é€™å€‹å€¼ä¾†è£½é€ ç§»å‹•æ•ˆæœ */
            background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;
            border: 4px solid #1e293b;
            border-radius: 8px;
        }

        /* èª²ç¨‹é¸æ“‡ç•«é¢ */
        #setupView {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            box-sizing: border-box;
            color: white; /* åœ¨ç£šç‰†ä¸Šæ–‡å­—æ”¹ç‚ºç™½è‰² */
        }

        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
        }

        .lesson-item {
            background: rgba(255, 255, 255, 0.9); /* åŠé€æ˜ç™½åº•ï¼Œè®“æ–‡å­—æ¸…æ¥š */
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: #334155;
        }

        .lesson-item:hover {
            border-color: #4f46e5;
            background: #ffffff;
        }

        /* éŠæˆ²ç•«é¢ */
        #gameView {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        #gameCanvas {
            margin: 5px 0;
            touch-action: none;
            width: 100%;
            max-width: 380px;
            height: 500px;
            /* background-image ç”± .brick-bg æä¾› */
        }

        .score-panel {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 5px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #334155;
            margin-bottom: 5px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        button {
            background-color: #4f46e5;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }

        button:active { transform: translateY(2px); }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }

        .btn-green { background-color: #10b981; }
        .btn-orange { background-color: #f59e0b; }

        /* å¹³æ¿å°ˆç”¨åº•éƒ¨æŒ‰éˆ• */
        .tablet-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .control-btn {
            width: 100px;
            height: 80px;
            background-color: #334155;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 6px #1e293b;
            user-select: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .control-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #1e293b;
            background-color: #1e293b;
        }

        /* è¨Šæ¯è¦†è“‹å±¤ */
        .message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 30;
            border-radius: 16px;
        }

        .message-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            width: 90%; /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´æ©«å‘æŒ‰éˆ• */
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* ä¿®æ”¹ï¼šé¸é …å®¹å™¨æ”¹ç‚ºæ©«å‘æ’åˆ— */
        #quizOptions {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 8px;
            width: 100%;
            margin-top: 15px;
        }

        /* ä¿®æ”¹ï¼šæŒ‰éˆ•æ¨£å¼èª¿æ•´ç‚ºé©åˆæ©«æ’ */
        .quiz-btn {
            background-color: #f1f5f9;
            color: #1e293b;
            padding: 8px 4px; /* æ¸›å°‘å…§é‚Šè· */
            border: 2px solid #cbd5e1;
            font-size: 0.95rem; /* å­—é«”ç¨å¾®èª¿å°ä»¥é©æ‡‰çª„å¯¬åº¦ */
            flex: 1; /* å¹³å‡åˆ†é…å¯¬åº¦ */
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50px; /* ç¢ºä¿é»æ“Šé«˜åº¦ */
            word-break: break-all; /* é˜²æ­¢é•·è©æ’ç ´ */
            line-height: 1.2;
        }
        
        .quiz-btn:hover { background-color: #e2e8f0; }

        .quiz-question-text {
            font-size: 1.1rem;
            color: #4f46e5;
            font-weight: 700;
            margin: 10px 0;
            line-height: 1.5;
            text-align: left;
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>åº·è»’åœ‹èªå…­ä¸Š7-12èª²å°æœ‹å‹ä¸‹æ¨“æ¢¯</h1>

        <!-- ç•«é¢ä¸€ï¼šè¨­å®š (å¥—ç”¨ç£šç‰†èƒŒæ™¯æ¨£å¼) -->
        <div id="setupView" class="brick-bg">
            <p style="color: #ffffff; font-weight: bold; text-shadow: 1px 1px 2px black;">è«‹å‹¾é¸ç·´ç¿’èª²æ¬¡ï¼š</p>
            <div class="lesson-grid">
                <label class="lesson-item"><input type="checkbox" value="7" checked> ç¬¬ä¸ƒèª²</label>
                <label class="lesson-item"><input type="checkbox" value="8"> ç¬¬å…«èª²</label>
                <label class="lesson-item"><input type="checkbox" value="9"> ç¬¬ä¹èª²</label>
                <label class="lesson-item"><input type="checkbox" value="10"> ç¬¬åèª²</label>
                <label class="lesson-item"><input type="checkbox" value="11"> ç¬¬åä¸€èª²</label>
                <label class="lesson-item"><input type="checkbox" value="12"> ç¬¬åäºŒèª²</label>
            </div>
            <button id="entryButton" class="btn-green" style="width: 100%; padding: 15px; font-size: 1.2rem; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">é€²å…¥éŠæˆ²</button>
        </div>

        <!-- ç•«é¢äºŒï¼šéŠæˆ² -->
        <div id="gameView">
            <div class="score-panel">
                <span>å¾—åˆ†: <span id="scoreDisplay">0</span></span>
                <span style="color: #ef4444;">â¤ï¸: <span id="livesDisplay">3</span></span>
                <span>æœ€é«˜: <span id="highScoreDisplay">0</span></span>
            </div>
            <!-- Canvas ä¹Ÿå¥—ç”¨ç£šç‰†æ¨£å¼ -->
            <canvas id="gameCanvas" class="brick-bg" width="380" height="500"></canvas>
            
            <div class="action-buttons">
                <button id="startButton">é–‹å§‹ / é‡æ–°</button>
                <button id="pauseButton" class="btn-orange" disabled>æš«åœ</button>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <button id="uploadButton" class="btn-green">è§’è‰²ç…§ç‰‡</button>
            </div>

            <!-- å¹³æ¿å°ˆç”¨åº•éƒ¨æŒ‰éˆ• -->
            <div class="tablet-controls">
                <div class="control-btn" id="leftBtn">â—€</div>
                <div class="control-btn" id="rightBtn">â–¶</div>
            </div>
        </div>

        <!-- è¨Šæ¯å½ˆçª— -->
        <div class="message-overlay" id="messageOverlay">
            <div class="message-box">
                <h2 id="messageTitle">æç¤º</h2>
                <p id="messageText"></p>
                <button id="closeMessageButton">ç¢ºå®š</button>
            </div>
        </div>

        <!-- é¸æ“‡é¡Œå½ˆçª— -->
        <div class="message-overlay" id="quizOverlay">
            <div class="message-box">
                <h3 style="margin:0;">è«‹æ ¹æ“šè§£é‡‹é¸å‡ºèªè©ï¼š</h3>
                <div id="quizQuestion" class="quiz-question-text"></div>
                <!-- é¸é …å®¹å™¨ -->
                <div id="quizOptions"></div>
                <div id="feedbackText" style="margin-top:10px; font-weight:bold;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- é¡Œåº« ---
        const VOCAB_DATA = {
            7: [{ word: "ä»°å…‰", def: "åŸå¸‚åã€‚ä½æ–¼ä¼Šæ´›ç“¦åº•æ±Ÿä¸‰è§’æ´²æ±å´ã€‚ç‚ºç·¬ç”¸æœ€å¤§å’Œæœ€é‡è¦çš„å·¥å•†æ¥­åŸå¸‚ã€‚" }, { word: "ç·¬ç”¸", def: "åœ‹åã€‚ä½æ–¼äºæ´²æ±å—éƒ¨ã€‚" }, { word: "è…³è¸", def: "å°è…¿èˆ‡è…³æŒé–“ï¼Œè…³éª¨å…©æ—å‡¸èµ·çš„éƒ¨ä½ã€‚" }, { word: "å‘¢çµ¨", def: "ç”¨ç¸æ¯›æˆ–äººé€ æ¯›ç­‰è£½æˆçš„æ¯›ç¹”å“çš„çµ±ç¨±ã€‚" }, { word: "ä¸‹è¥¬", def: "ä¸Šè¡£ã€é•·è¢å’Œè£™å­ç­‰çš„ä¸‹ç·£éƒ¨åˆ†ã€‚" }, { word: "æ£æ„", def: "æ”¾ä»»è€Œä¸åŠ ä»¥ç´„æŸã€‚" }, { word: "æ‰¹åˆ¤", def: "è©•è«–åˆ¤æ–·ã€‚" }, { word: "è¡Œå¾‘", def: "è¡Œç‚ºã€èˆ‰å‹•ã€‚" }, { word: "è¬¹è¨˜", def: "æ­è¬¹ç‰¢è¨˜ã€‚æˆ–æ­æ•¬æ…é‡çš„å¯«ä¸‹ã€‚" }, { word: "æ°æ°", def: "æ°å·§ã€å‰›å¥½ã€‚" }, { word: "ä¹äººå•æ´¥", def: "æ²’æœ‰äººæ´½è©¢æˆ–æ¢å•ã€‚" }, { word: "æ”¾ä¹‹å››æµ·è€Œçš†æº–", def: "ç”¨åˆ°ä»»ä½•åœ°æ–¹ä»»ä½•æ–¹é¢éƒ½å¯ä½œç‚ºæº–å‰‡ã€‚" }, { word: "å—¤ä¹‹ä»¥é¼»", def: "å¾é¼»å­è£¡ç™¼å‡ºå†·ç¬‘ã€‚è¡¨ç¤ºä¸å±‘æˆ–é„™è¦–ã€‚" }],
            8: [{ word: "ç¸«éš™", def: "ç©ºéš™ã€‚" }, { word: "æ—¨æ„", def: "å¸ç‹çš„å‘½ä»¤ã€‚æˆ–ä¸»æ—¨ç›®çš„ã€‚" }, { word: "æ‚ é–’", def: "é–’é©è‡ªå¾—è€Œç„¡æ‰€ç‰½æ›ã€‚" }, { word: "å¯“è¨€", def: "ä»¥æ·ºè¿‘å‡è¨—çš„æ•…äº‹æˆ–è‡ªç„¶ç‰©çš„æ“¬äººæ‰‹æ³•ï¼Œè¡¨é”å“²ç†çš„æ–‡é«”ã€‚" }, { word: "é·¸èšŒç›¸çˆ­", def: "æ¯”å–»å…©ç›¸çˆ­åŸ·é€ æˆå…©æ•—ä¿±å‚·ï¼Œè®“ç¬¬ä¸‰è€…ç²åˆ©çš„å±€é¢ã€‚" }, { word: "ç‹¡å…”ä¸‰çªŸ", def: "æ¯”å–»äººæœ‰å¤šè™•è—èº«çš„åœ°æ–¹æˆ–å¤šç¨®é¿ç¦çš„æº–å‚™ã€‚" }, { word: "ç‹¡çŒ¾", def: "è©­è®Šå¤šè©ã€‚" }, { word: "æ‹›æ–æ’é¨™", def: "å‡å€Ÿä»–äººçš„åç¾©æˆ–è²å‹¢è€Œåˆ°è™•è©é¨™ã€‚" }, { word: "å½è£", def: "å‡è£ï¼Œæ”¹è£æ©é£¾çœŸæ­£çš„é¢ç›®æˆ–èº«åˆ†ã€‚" }, { word: "èª‡å¤§", def: "è¨€èªè¶…éåŸæœ‰çš„äº‹å¯¦ã€‚" }, { word: "åˆ†è¾¨", def: "è¾¨åˆ¥ã€‚" }, { word: "è¬Šè¨€", def: "ä¸å¯¦åœ¨çš„è©±ã€‚" }, { word: "è«·åˆº", def: "ä»¥éš±å¾®çš„æ–¹å¼å˜²è«·è­åˆºã€‚" }, { word: "è­¦æƒ•", def: "å°å¯èƒ½ç™¼ç”Ÿçš„æƒ…æ³ï¼Œå¿ƒç”Ÿè­¦è¦ºè€ŒåŠ ä»¥æˆ’å‚™ã€‚" }, { word: "è§€å¯Ÿ", def: "ä»”ç´°å¯Ÿçœ‹ã€‚" }, { word: "è’™è”½", def: "æ¬ºé¨™ã€éš±çäº‹å¯¦çš„çœŸç›¸ã€‚" }, { word: "è™›å¼µè²å‹¢", def: "èª‡å¤§è²å¨æ°£å‹¢ï¼Œç”¨ä»¥åš‡é˜»æˆ–æ¬ºé¨™ä»–äººã€‚" }],
            9: [{ word: "è¡—äº­", def: "ä¸‰åœ‹æ™‚æœŸè«¸è‘›äº®åŒ—ä¼çš„ä¸€å ´æˆ°äº‹åœ°é»ï¼Œä¹Ÿæ˜¯ä¸€å ´æ±ºå®šæ€§æˆ°å½¹ã€‚" }, { word: "èª˜æ•µ", def: "å¼•èª˜æ•µäººã€‚" }, { word: "æ——å¹Ÿ", def: "æ³›ç¨±æ—Œæ——ã€‚æˆ–æ¯”å–»åç¾©ã€è—‰å£ã€‚" }, { word: "å´—ä½", def: "è·è²¬ã€æœ¬åˆ†ã€‚æˆ–è»è­¦åŸ·å‹¤çš„è™•æ‰€ã€‚" }, { word: "ç™¾å§“", def: "æ³›æŒ‡ä¸€èˆ¬å¹³æ°‘ã€åœ‹æ°‘ã€‚" }, { word: "å€˜è‹¥", def: "è¡¨ç¤ºå‡è¨­èªæ°£çš„é€£æ¥è©ï¼Œå³å¦‚æœã€å‡ä½¿ã€‚" }, { word: "æ›¸åƒ®", def: "èˆŠæ™‚åœ¨å¯Œäººå®¶ä¸­ä¾å€™ä¸»äººæˆ–å…¶å¼Ÿå­è®€æ›¸çš„æœªæˆå¹´åƒ®åƒ•ã€‚" }, { word: "æ’¤é€€", def: "æ”¾æ£„é™£åœ°æˆ–é·é›¢å·²å é ˜çš„åœ°å€ã€‚" }, { word: "è¬¹æ…", def: "ä»”ç´°æ…é‡ã€‚" }, { word: "ä¸ç›¸", def: "å¤æ™‚è¼”ä½å¤©å­è™•ç†åœ‹äº‹çš„æœ€é«˜è¡Œæ”¿å®˜å“¡ã€‚" }],
            10: [{ word: "è€¶èª•ç¯€", def: "ç´€å¿µè€¶ç©Œèª•ç”Ÿçš„ç¯€æ—¥ï¼ŒåäºŒæœˆäºŒåäº”æ—¥ã€‚" }, { word: "éƒŠå¤–", def: "ç’°ç¹åŸå¸‚å¤–é¢çš„åœ°æ–¹ã€‚" }, { word: "æ…ˆç¥¥", def: "æ…ˆå–„ç¥¥å’Œã€‚" }, { word: "åŠˆå•ª", def: "ç‹€è²è©ã€‚å½¢å®¹ç‡ƒç‡’æ™‚çˆ†è£‚æˆ–æ’æ“Šæ‹æ‰“çš„è²éŸ³ã€‚" }, { word: "é›¶ç”¨éŒ¢", def: "é›¶ç¢èŠ±ç”¨çš„éŒ¢ã€‚" }, { word: "å­å€¦", def: "ä¸å†å–œæ­¡æˆ–æä¸èµ·èˆˆè¶£ã€‚" }, { word: "è¾¯è­·", def: "æå‡ºç†ç”±ä¾†åŠ ä»¥è¢’è­·ã€‚æˆ–æ³•å¾‹ä¸Šçš„é˜²ç¦¦è¾¯ç™½ã€‚" }, { word: "è‡ªç§è‡ªåˆ©", def: "åªåœ–è‡ªå·±çš„ç§åˆ©ï¼Œè€Œä¸é¡§åŠä¸€åˆ‡ã€‚" }, { word: "è²§çª®", def: "ç¼ºå°‘éŒ¢è²¡ï¼Œç”Ÿæ´»æ‹®æ®å›°ä¹ã€‚" }, { word: "é—œä¿‚", def: "å°ç›¸é—œäº‹ç‰©çš„å½±éŸ¿ã€ç‰½æ¶‰ã€‚æˆ–äººäº‹ç‰©é–“çš„é—œé€£æƒ…å½¢ã€‚" }, { word: "ç¨å¾®", def: "ç¨‹åº¦æˆ–åˆ†é‡ä¸Šæ¥µå°‘çš„ã€‚" }, { word: "æš–çƒ˜çƒ˜", def: "æº«æš–çš„æ¨£å­ã€‚" }, { word: "è¡·å¿ƒ", def: "å‡ºè‡ªå…§å¿ƒã€‚" }, { word: "é‹¼ç´", def: "æ¨‚å™¨åã€‚å±¬éµç›¤æ¨‚å™¨ã€‚" }],
            11: [{ word: "æ¢å¾©", def: "å›å¾©åˆ°åŸä¾†çš„æ¨£å­ã€‚æˆ–æ”¶å¾©å¤±å»çš„ã€‚" }, { word: "æ´»æ½‘", def: "ç”Ÿå‹•è€Œä¸å‘†æ¿ã€‚" }, { word: "è‰è“", def: "æ¤ç‰©åã€‚è‚‰è³ªå¤šæ±ï¼Œå‘³é“é…¸ç”œã€‚" }, { word: "å®¢å»³", def: "ç”¨ä¾†æ¥å¾…è³“å®¢çš„å ´æ‰€ã€‚" }, { word: "å‰é¡", def: "é¡é ­ã€‚" }, { word: "çŒé†‰", def: "å‹‰å¼·åˆ¥äººå–é…’ä»¥è‡´æ–¼é…’é†‰ã€‚" }, { word: "åŸè«’", def: "å¯¬æ•è«’è§£ã€‚" }, { word: "é›™è„£", def: "ä¸Šã€ä¸‹å˜´è„£ã€‚" }, { word: "ä¹æ±‚", def: "æ‡‡æ±‚ã€è«‹æ±‚ã€‚" }, { word: "ç¥é‡‡ç…¥ç™¼", def: "ç²¾ç¥å……è¶³ï¼Œå…‰é‡‡ç…§äººã€‚" }, { word: "é›ªæ©‡", def: "åˆ©ç”¨é•·æ¢å½¢å¹³æ»‘æ¿å¡Šåœ¨é›ªåœ°ä¸Šæ»‘è¡Œçš„ç„¡è¼ªäº¤é€šå·¥å…·ã€‚" }, { word: "è¿´ç›ª", def: "è¿´æ—‹é£„æµ®ã€‚" }],
            12: [{ word: "è¨ç•°", def: "è¦ºå¾—æ„å¤–ï¼Œé›£ä»¥ç›¸ä¿¡ã€‚" }, { word: "è‡‰é °", def: "è‡‰çš„å…©é‚Šã€‚" }, { word: "è“¬å‹ƒ", def: "èŒ‚ç››ç¹æ¦®çš„æ¨£å­ã€‚" }, { word: "å®¶åº­é†«å¸«", def: "ç…§é¡§å®¶åº­å„æˆå“¡å¥åº·çš„ç¬¬ä¸€ç·šé†«å¸«ã€‚" }, { word: "åš´è‚…", def: "æ…‹åº¦åš´æ­£èŠé‡ã€‚æˆ–åš´æ ¼ã€èªçœŸã€‚" }, { word: "è–”è–‡", def: "æ¤ç‰©åã€‚æå¹¹å¤šåˆºï¼ŒèŠ±æœµå¯Œæœ‰é¦™æ°£ã€‚" }, { word: "ç€°æ¼«", def: "éå¸ƒã€æ»¿å¸ƒã€‚" }, { word: "åŒ…æ‹¬", def: "åŒ…å«ã€æ¶µè“‹ã€‚" }, { word: "èèŸ»", def: "èŸ»ç§‘æ˜†èŸ²çš„ç¸½ç¨±ã€‚å–œæ–¼åœ°ä¸‹ç¯‰å·¢ç¾¤å±…ã€‚" }, { word: "å„˜ç®¡", def: "å³ä½¿ã€é›–ç„¶ã€‚æˆ–ä¸é¡§ç¯€åˆ¶éš¨æ„å»åšã€‚" }]
        };

        const setupView = document.getElementById('setupView');
        const gameView = document.getElementById('gameView');
        const entryButton = document.getElementById('entryButton');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const livesDisplay = document.getElementById('livesDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const quizOverlay = document.getElementById('quizOverlay');
        const quizQuestion = document.getElementById('quizQuestion');
        const quizOptions = document.getElementById('quizOptions');
        const feedbackText = document.getElementById('feedbackText');

        const PLAYER_SIZE = 40;
        const PLAYER_SPEED = 6;
        const GRAVITY = 0.8;
        const STAIR_SPEED = 1.3; // é€Ÿåº¦æ¸›æ…¢

        let gameState = {
            isRunning: false,
            isPaused: false,
            isQuizActive: false,
            score: 0,
            highScore: 0,
            lives: 3,
            invincible: 0,
            player: { x: 170, y: 300, dx: 0, dy: 0 },
            obstacles: [],
            vocabPool: [],
            history: new Set(),
            playerImg: new Image(),
            imgLoaded: false,
            rowsHandled: new Set(),
            bgY: 0
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mandarin-stairs-pro-v2';
        const fbCfg = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const authTok = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db, auth;

        if (fbCfg) {
            const app = initializeApp(fbCfg);
            db = getFirestore(app);
            auth = getAuth(app);
            const initA = async () => { if(authTok) await signInWithCustomToken(auth, authTok); else await signInAnonymously(auth); };
            initA();
            onAuthStateChanged(auth, (u) => {
                if(u) onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'scores', 'global'), (ds) => {
                    if(ds.exists()) { gameState.highScore = ds.data().score || 0; highScoreDisplay.textContent = gameState.highScore; }
                });
            });
        }

        entryButton.addEventListener('click', () => {
            const sels = Array.from(document.querySelectorAll('.lesson-grid input:checked')).map(i => i.value);
            if(sels.length === 0) {
                // ä½¿ç”¨è‡ªå®šç¾©å½ˆçª—å–ä»£ alert
                document.getElementById('messageTitle').textContent = "æç¤º";
                document.getElementById('messageText').textContent = "è«‹å‹¾é¸èª²æ¬¡ï¼";
                document.getElementById('messageOverlay').style.display = 'flex';
                return;
            }
            gameState.vocabPool = sels.flatMap(n => VOCAB_DATA[n]);
            setupView.style.display = 'none';
            gameView.style.display = 'flex';
        });

        function startGame() {
            gameState.score = 0;
            gameState.lives = 3;
            gameState.history.clear();
            gameState.obstacles = [];
            gameState.rowsHandled.clear();
            
            // --- åˆå§‹ç”Ÿæˆé‚è¼¯ï¼šç¢ºä¿ç¬¬ä¸€å±¤æ˜¯å®‰å…¨å¹³å°ä½†æœ‰ç¼ºå£ ---
            const startY = 380; // ç©å®¶è…³ä¸‹çš„åˆå§‹ä½ç½®
            
            // ç”¢ç”Ÿä¸€å€‹éš¨æ©Ÿç¼ºå£ï¼Œè®“ç©å®¶å¯ä»¥å¾€ä¸‹è·³
            const gapWidth = 90; 
            const gapX = Math.random() * (canvas.width - gapWidth);

            // å·¦å´åœ°æ¿
            if (gapX > 0) {
                gameState.obstacles.push({
                    x: 0, y: startY, w: gapX, h: 20, rid: 'start-L', node: null
                });
            }
            // å³å´åœ°æ¿
            if (gapX + gapWidth < canvas.width) {
                gameState.obstacles.push({
                    x: gapX + gapWidth, y: startY, w: canvas.width - (gapX + gapWidth), h: 20, rid: 'start-R', node: null
                });
            }
            
            // ç©å®¶åˆå§‹ä½ç½®ï¼šç«™åœ¨è¼ƒå¯¬çš„é‚£ä¸€å´å¹³å°ä¸Šï¼Œé¿å…ç›´æ¥æ‰ä¸‹å»
            if (gapX > (canvas.width - gapWidth) / 2) {
                // å·¦é‚Šè¼ƒå¯¬ï¼Œç«™å·¦é‚Š
                gameState.player.x = gapX / 2 - PLAYER_SIZE / 2;
            } else {
                // å³é‚Šè¼ƒå¯¬ï¼Œç«™å³é‚Š
                const segStart = gapX + gapWidth;
                const segWidth = canvas.width - segStart;
                gameState.player.x = segStart + segWidth / 2 - PLAYER_SIZE / 2;
            }
            gameState.player.y = startY - PLAYER_SIZE;
            gameState.player.dy = 0;
            
            // ç”Ÿæˆå…¶ä»–å¹³å°ï¼ˆä¸Šæ–¹å’Œä¸‹æ–¹ï¼‰
            // å‘ä¸Šç”Ÿæˆï¼ˆè¦–è¦ºä¸Šæ˜¯ä¸Šæ–¹ï¼ŒYå€¼è¼ƒå°ï¼‰
            for(let y = startY - 120; y > -50; y -= 120) createRow(y);
            // å‘ä¸‹ç”Ÿæˆï¼ˆè¦–è¦ºä¸Šæ˜¯ä¸‹æ–¹ï¼ŒYå€¼è¼ƒå¤§ï¼Œä½œç‚ºå¾ŒçºŒæ¨“å±¤ï¼‰
            createRow(startY + 120);

            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.isQuizActive = false;
            gameState.bgY = 0;
            scoreDisplay.textContent = '0';
            livesDisplay.textContent = '3';
            startButton.disabled = true;
            pauseButton.disabled = false;
            
            requestAnimationFrame(gameLoop);
        }

        function createRow(y) {
            const rid = crypto.randomUUID();
            const gaps = Math.floor(Math.random() * 2) + 1;
            const gw = 65;
            let segs = [{x: 0, w: canvas.width}];
            for(let i=0; i<gaps; i++) {
                let idx = segs.findIndex(s => s.w > gw + 40);
                if(idx === -1) break;
                let s = segs.splice(idx, 1)[0];
                let gx = s.x + 20 + Math.random() * (s.w - gw - 40);
                segs.push({x: s.x, w: gx - s.x}, {x: gx + gw, w: (s.x+s.w) - (gx+gw)});
            }
            segs.forEach(seg => {
                if(seg.w < 5) return;
                let o = { x: seg.x, y: y, w: seg.w, h: 18, rid: rid, node: null };
                let pool = gameState.vocabPool.filter(v => !gameState.history.has(v.word));
                if(pool.length > 0 && Math.random() < 0.25) {
                    let item = pool[Math.floor(Math.random()*pool.length)];
                    let nx;
                    if(seg.x === 0) nx = seg.w - 20; 
                    else if(seg.x + seg.w >= canvas.width) nx = seg.x + 20; 
                    else nx = seg.x + seg.w/2;
                    o.node = { x: nx, item: item };
                }
                gameState.obstacles.push(o);
            });
        }

        function triggerQuiz(node) {
            gameState.isPaused = true;
            gameState.isQuizActive = true;
            feedbackText.textContent = "";
            quizQuestion.textContent = node.item.def;
            let opts = [node.item];
            let others = gameState.vocabPool.filter(v => v.word !== node.item.word);
            while(opts.length < 4 && others.length > 0) {
                let r = Math.floor(Math.random()*others.length);
                let p = others.splice(r, 1)[0];
                if(!opts.find(o => o.word === p.word)) opts.push(p);
            }
            opts.sort(() => Math.random() - 0.5);
            quizOptions.innerHTML = '';
            opts.forEach(o => {
                let b = document.createElement('button');
                b.className = 'quiz-btn';
                b.textContent = o.word;
                b.onclick = () => {
                    if(o.word === node.item.word) {
                        gameState.score += 5;
                        feedbackText.style.color = "#10b981";
                        feedbackText.textContent = "æ­£ç¢ºï¼+5åˆ†";
                        gameState.history.add(node.item.word);
                    } else {
                        gameState.score -= 3;
                        feedbackText.style.color = "#ef4444";
                        feedbackText.textContent = `ç­”éŒ¯ï¼æ­£è§£æ˜¯ï¼š${node.item.word}ã€‚-3åˆ†`;
                    }
                    scoreDisplay.textContent = gameState.score;
                    setTimeout(() => {
                        gameState.isPaused = false;
                        gameState.isQuizActive = false;
                        quizOverlay.style.display = 'none';
                        requestAnimationFrame(gameLoop);
                    }, 1200);
                };
                quizOptions.appendChild(b);
            });
            quizOverlay.style.display = 'flex';
        }

        function update() {
            if(!gameState.isRunning || gameState.isPaused || gameState.isQuizActive) return;
            if(gameState.invincible > 0) gameState.invincible--;
            
            gameState.bgY -= STAIR_SPEED;
            canvas.style.backgroundPosition = `
                0px ${2 + gameState.bgY}px, 
                4px ${35 + gameState.bgY}px, 
                29px ${31 + gameState.bgY}px, 
                34px ${6 + gameState.bgY}px
            `;

            gameState.player.dy += GRAVITY;
            gameState.player.y += gameState.player.dy;
            gameState.player.x += gameState.player.dx;
            if(gameState.player.x < 0) gameState.player.x = 0;
            if(gameState.player.x + PLAYER_SIZE > canvas.width) gameState.player.x = canvas.width - PLAYER_SIZE;

            let onS = false;
            // æ‘”æ­»æª¢æŸ¥
            if(gameState.player.y > canvas.height) {
                if(gameState.invincible <= 0) {
                    gameState.lives--; livesDisplay.textContent = gameState.lives;
                    if(gameState.lives <= 0) endG(); 
                    else { 
                        gameState.player.y = 100; 
                        gameState.player.dy = 0; 
                        gameState.invincible = 100; 
                    }
                } else {
                    gameState.player.y = 100;
                    gameState.player.dy = 0;
                }
            }

            gameState.obstacles.forEach(o => {
                o.y -= STAIR_SPEED;
                if(gameState.player.dy >= 0 && gameState.player.x < o.x + o.w && gameState.player.x + PLAYER_SIZE > o.x && gameState.player.y + PLAYER_SIZE >= o.y && gameState.player.y + PLAYER_SIZE <= o.y + o.h) {
                    gameState.player.y = o.y - PLAYER_SIZE;
                    gameState.player.dy = 0;
                    onS = true;
                }
                if(o.node) {
                    let d = Math.sqrt(Math.pow((gameState.player.x + PLAYER_SIZE/2) - o.node.x, 2) + Math.pow((gameState.player.y + PLAYER_SIZE/2) - (o.y + 10), 2));
                    if(d < 35) { let it = o.node.item; o.node = null; triggerQuiz({item: it}); }
                }
            });

            gameState.obstacles.forEach(o => {
                if(o.y + 18 < gameState.player.y && !gameState.rowsHandled.has(o.rid)) {
                    gameState.score++; scoreDisplay.textContent = gameState.score; gameState.rowsHandled.add(o.rid);
                }
            });

            gameState.obstacles = gameState.obstacles.filter(o => o.y > -50);
            let low = gameState.obstacles.reduce((max, o) => Math.max(max, o.y), -Infinity);
            if(gameState.obstacles.length === 0 || canvas.height - low >= 115) createRow(canvas.height);

            if(gameState.player.y < 0) {
                if(gameState.invincible <= 0) {
                    gameState.lives--; livesDisplay.textContent = gameState.lives;
                    if(gameState.lives <= 0) endG(); else { gameState.player.y = canvas.height/2; gameState.player.dy = 0; gameState.invincible = 100; }
                }
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#2d3748';
            gameState.obstacles.forEach(o => {
                ctx.fillRect(o.x, o.y, o.w, o.h);
                if(o.node) {
                    ctx.beginPath(); ctx.arc(o.node.x, o.y + 9, 10, 0, Math.PI*2);
                    ctx.fillStyle = '#fbbf24'; ctx.fill();
                    ctx.fillStyle = '#000'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText('?', o.node.x, o.y + 13);
                }
            });
            if(gameState.invincible % 10 < 5) {
                if(gameState.imgLoaded) ctx.drawImage(gameState.playerImg, gameState.player.x, gameState.player.y, PLAYER_SIZE, PLAYER_SIZE);
                else { ctx.fillStyle = '#ef4444'; ctx.fillRect(gameState.player.x, gameState.player.y, PLAYER_SIZE, PLAYER_SIZE); ctx.font = '30px Arial'; ctx.textAlign = 'center'; ctx.fillText('ğŸƒ', gameState.player.x + PLAYER_SIZE/2, gameState.player.y + 30); }
            }
        }

        function gameLoop() { if(!gameState.isRunning) return; update(); draw(); if(!gameState.isPaused && !gameState.isQuizActive) requestAnimationFrame(gameLoop); }

        function endG() {
            gameState.isRunning = false; startButton.disabled = false; pauseButton.disabled = true;
            if(db && auth && auth.currentUser && gameState.score > gameState.highScore) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scores', 'global'), { score: gameState.score, ts: Date.now() }, {merge: true});
            document.getElementById('messageTitle').textContent = "éŠæˆ²çµæŸ";
            document.getElementById('messageText').textContent = "ç”Ÿå‘½è€—ç›¡ï¼å¾—åˆ†ï¼š" + gameState.score;
            document.getElementById('messageOverlay').style.display = 'flex';
        }

        startButton.onclick = startGame;
        pauseButton.onclick = () => { if(!gameState.isRunning) return; gameState.isPaused = !gameState.isPaused; pauseButton.textContent = gameState.isPaused ? "ç¹¼çºŒ" : "æš«åœ"; if(!gameState.isPaused) requestAnimationFrame(gameLoop); };
        document.getElementById('closeMessageButton').onclick = () => document.getElementById('messageOverlay').style.display = 'none';
        document.getElementById('uploadButton').onclick = () => document.getElementById('imageInput').click();
        document.getElementById('imageInput').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = (ev) => { gameState.playerImg.src = ev.target.result; gameState.playerImg.onload = () => { gameState.imgLoaded = true; draw(); }; };
                r.readAsDataURL(f);
            }
        };

        const setD = (d) => { if(!gameState.isRunning || gameState.isPaused || gameState.isQuizActive) return; gameState.player.dx = d * PLAYER_SPEED; };
        window.onkeydown = (e) => { if(e.key === 'ArrowLeft') setD(-1); if(e.key === 'ArrowRight') setD(1); };
        window.onkeyup = (e) => { if(e.key === 'ArrowLeft' || e.key === 'ArrowRight') setD(0); };
        const lB = document.getElementById('leftBtn'), rB = document.getElementById('rightBtn');
        const bind = (b, d) => {
            b.addEventListener('touchstart', (e) => { e.preventDefault(); setD(d); });
            b.addEventListener('touchend', (e) => { e.preventDefault(); setD(0); });
            b.addEventListener('mousedown', () => setD(d));
            b.addEventListener('mouseup', () => setD(0));
            b.addEventListener('mouseleave', () => setD(0));
        };
        bind(lB, -1); bind(rB, 1);
    </script>
</body>
</html>