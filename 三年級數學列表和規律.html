<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦å¾‹åµæ¢ï¼šåˆ—è¡¨èˆ‡è¦å¾‹ (å®Œæ•´ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { touch-action: manipulation; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        @keyframes bounce-small {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-small { animation: bounce-small 2s infinite; }
        /* Custom scrollbar for tables */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-indigo-50 text-slate-800 select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Search = (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconWrapper>;
        const Trees = (props) => <IconWrapper {...props}><path d="M10 10v.2A3 3 0 0 1 8.9 16v0H5v0h0a3 3 0 0 1-1.1-5.8V10a3 3 0 0 1 6.1 0z"/><path d="M7 16v6"/><path d="M13 19v3"/><path d="M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .9-1.7l-3.5-5a.5.5 0 0 0-.8 0l-3.5 5a1 1 0 0 0 .9 1.7h.2l-2.9 3.3a1 1 0 0 0 .7 1.7h.3l-2.1 3.3a1 1 0 0 0 .7 1.7H12z"/></IconWrapper>;
        const Play = (props) => <IconWrapper {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconWrapper>;
        const BookOpen = (props) => <IconWrapper {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>;
        const CheckCircle = (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>;
        const Trophy = (props) => <IconWrapper {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconWrapper>;
        const ArrowRight = (props) => <IconWrapper {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconWrapper>;
        const RotateCcw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;
        const Shapes = (props) => <IconWrapper {...props}><path d="M3 3h18v18H3zM12 8l-5 9h10z"/><circle cx="12" cy="12" r="5"/></IconWrapper>;
        const ClipboardList = (props) => <IconWrapper {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconWrapper>;
        const Coins = (props) => <IconWrapper {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="M16.71 13.88c.07-.38.12-.77.12-1.17a6 6 0 1 0-8.49 5.46"/></IconWrapper>;
        const Coffee = (props) => <IconWrapper {...props}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></IconWrapper>;
        const Train = (props) => <IconWrapper {...props}><rect x="4" y="3" width="16" height="16" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><circle cx="8" cy="15" r="2"/><circle cx="16" cy="15" r="2"/></IconWrapper>;

        // --- Helper Components ---
        const ShapeIcon = ({ type, color, size = 12 }) => {
            const sizeClass = `w-${size} h-${size}`;
            if (type === 'circle') return <div className={`${sizeClass} rounded-full ${color} border-2 border-white shadow-sm`}></div>;
            if (type === 'square') return <div className={`${sizeClass} rounded-md ${color} border-2 border-white shadow-sm`}></div>;
            if (type === 'triangle') return <div className={`${sizeClass} clip-triangle ${color} border-b-2 border-white shadow-sm`} style={{clipPath: 'polygon(50% 0%, 0% 100%, 100% 100%)'}}></div>;
            return null;
        };

        // --- Main App Component ---
        const PatternGame = () => {
          const [currentTab, setCurrentTab] = useState('learn');
          const [score, setScore] = useState(0);
          const [animateScore, setAnimateScore] = useState(false);

          useEffect(() => {
            if (score > 0) {
              setAnimateScore(true);
              const timer = setTimeout(() => setAnimateScore(false), 300);
              return () => clearTimeout(timer);
            }
          }, [score]);

          const renderTabContent = () => {
            switch (currentTab) {
              case 'learn': return <LearnSection onComplete={() => setCurrentTab('practice_1')} />;
              case 'practice_1': return <PatternCracker score={score} setScore={setScore} onComplete={() => setCurrentTab('practice_2')} />;
              case 'practice_2': return <IntervalMaster score={score} setScore={setScore} onComplete={() => setCurrentTab('practice_3')} />;
              case 'practice_3': return <TableMaster score={score} setScore={setScore} onComplete={() => setCurrentTab('quiz')} />;
              case 'quiz': return <QuizMode score={score} setScore={setScore} onRestart={() => { setScore(0); setCurrentTab('learn'); }} />;
              default: return <LearnSection />;
            }
          };

          return (
            <div className="h-screen flex flex-col bg-indigo-50 font-sans text-slate-800 overflow-hidden select-none">
              <header className="bg-white shadow-sm p-3 z-10 flex-none border-b border-indigo-100">
                <div className="max-w-2xl mx-auto flex justify-between items-center">
                  <div className="flex items-center space-x-2">
                    <div className="bg-indigo-500 p-2 rounded-xl text-white shadow-sm"><Search size={20} /></div>
                    <h1 className="text-lg font-bold text-indigo-700 tracking-wide">è¦å¾‹åµæ¢</h1>
                  </div>
                  <div className={`flex items-center bg-yellow-100 px-3 py-1.5 rounded-full border border-yellow-300 transition-transform duration-200 ${animateScore ? 'scale-110 ring-4 ring-yellow-200' : ''}`}>
                    <Trophy className={`text-yellow-600 mr-1.5 ${animateScore ? 'animate-spin' : ''}`} size={16} />
                    <span className="font-bold text-yellow-700">{score} åˆ†</span>
                  </div>
                </div>
              </header>

              <main className="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-24 scroll-smooth">
                <div className="max-w-2xl mx-auto bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/50 p-5 min-h-[400px] animate-in fade-in slide-in-from-bottom-4 duration-500">
                  {renderTabContent()}
                </div>
              </main>

              <nav className="bg-white border-t border-slate-200 pb-safe pt-2 px-1 fixed bottom-0 w-full z-20 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                <div className="max-w-2xl mx-auto flex justify-between items-end pb-2">
                  <NavButton active={currentTab === 'learn'} onClick={() => setCurrentTab('learn')} icon={<BookOpen size={20} />} label="å­¸ç¿’" />
                  <NavButton active={currentTab === 'practice_1'} onClick={() => setCurrentTab('practice_1')} icon={<Shapes size={20} />} label="æ‰¾è¦å¾‹" />
                  <NavButton active={currentTab === 'practice_2'} onClick={() => setCurrentTab('practice_2')} icon={<Trees size={20} />} label="ç¨®æ¨¹" />
                  <NavButton active={currentTab === 'practice_3'} onClick={() => setCurrentTab('practice_3')} icon={<ClipboardList size={20} />} label="æŸ¥è¡¨" />
                  <NavButton active={currentTab === 'quiz'} onClick={() => setCurrentTab('quiz')} icon={<CheckCircle size={20} />} label="æŒ‘æˆ°" />
                </div>
              </nav>
            </div>
          );
        };

        const NavButton = ({ active, onClick, icon, label }) => (
          <button onClick={onClick} className={`flex-1 flex flex-col items-center justify-center py-2 px-1 transition-all duration-300 rounded-xl active:scale-95 touch-manipulation ${active ? 'text-indigo-600 -translate-y-2' : 'text-slate-400 hover:text-slate-600'}`}>
            <div className={`p-1.5 rounded-full transition-all duration-300 ${active ? 'bg-indigo-100 shadow-sm' : ''}`}>{icon}</div>
            <span className={`text-[10px] font-medium mt-1 ${active ? 'opacity-100' : 'opacity-70'}`}>{label}</span>
            {active && <div className="w-1 h-1 bg-indigo-500 rounded-full mt-1"></div>}
          </button>
        );

        // --- 1. Learning Section ---
        const LearnSection = ({ onComplete }) => (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-xl font-bold text-slate-800 flex items-center"><Play className="mr-2 text-indigo-500" style={{fill: 'currentColor'}} size={24} /> è§€å¿µå­¸ç¿’</h2>
              <span className="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">CH9 åˆ—è¡¨èˆ‡è¦å¾‹</span>
            </div>
            
            <div className="aspect-video w-full bg-slate-900 rounded-2xl overflow-hidden shadow-lg ring-4 ring-indigo-50" style={{position:'relative', paddingBottom: '56.25%', height: 0}}>
              <iframe src="https://www.youtube.com/embed/trtFYP3RFOQ" title="åˆ—è¡¨èˆ‡è¦å¾‹æ•™å­¸" style={{position:'absolute', top:0, left:0, width:'100%', height:'100%'}} frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
            </div>

            <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-2xl border border-indigo-100 mt-4 shadow-sm">
              <h3 className="text-lg font-bold text-indigo-800 mb-3 flex items-center"><BookOpen className="w-5 h-5 mr-2" /> åµæ¢ç­†è¨˜</h3>
              <div className="space-y-3 text-base text-slate-700">
                <div className="flex bg-white p-3 rounded-xl shadow-sm border border-indigo-50 items-start">
                   <div className="bg-indigo-100 text-indigo-700 font-bold rounded-lg w-8 h-8 flex items-center justify-center mr-3 flex-shrink-0">1</div>
                   <div><strong className="text-indigo-700">æŸ¥è¡¨æŠ€å·§</strong>ï¼š<br/>çœ‹æ¸…æ¥šã€Œåˆ—ã€èˆ‡ã€Œè¡Œã€ã€‚<br/>ç«è»Šç¥¨åƒ¹è¡¨è¦æ‰¾ã€Œå‡ºç™¼ã€å’Œã€Œåˆ°é”ã€çš„äº¤å‰é»ã€‚</div>
                </div>
                <div className="flex bg-white p-3 rounded-xl shadow-sm border border-indigo-50 items-start">
                   <div className="bg-indigo-100 text-indigo-700 font-bold rounded-lg w-8 h-8 flex items-center justify-center mr-3 flex-shrink-0">2</div>
                   <div><strong className="text-indigo-700">åˆ—è¡¨è§£æ±ºå•é¡Œ</strong>ï¼š<br/>ç•«å‡ºè¡¨æ ¼ï¼Œæœ‰é †åºåœ°æŠŠæ‰€æœ‰å¯èƒ½éƒ½å¯«ä¸‹ä¾†ï¼Œå°±ä¸æœƒæ¼æ‰ç­”æ¡ˆå›‰ï¼</div>
                </div>
                <div className="flex bg-white p-3 rounded-xl shadow-sm border border-indigo-50 items-start">
                  <div className="bg-indigo-100 text-indigo-700 font-bold rounded-lg w-8 h-8 flex items-center justify-center mr-3 flex-shrink-0">3</div>
                  <div><strong className="text-indigo-700">è¦å¾‹</strong>ï¼š<br/>è§€å¯Ÿé‡è¤‡å‡ºç¾çš„å½¢ç‹€æˆ–æ•¸å­—ã€‚ä¾‹å¦‚ï¼šğŸğŸŒğŸğŸŒ...</div>
                </div>
              </div>
            </div>
            <button onClick={onComplete} className="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center shadow-lg shadow-indigo-500/20 active:scale-95 transition-all">æˆ‘æº–å‚™å¥½äº†ï¼ <ArrowRight className="ml-2" /></button>
          </div>
        );

        // --- 2. Pattern Cracker Game ---
        const PatternCracker = ({ score, setScore, onComplete }) => {
            const [level, setLevel] = useState(0);
            const [feedback, setFeedback] = useState('');
            
            const patterns = [
                {
                    seq: ['circle', 'square', 'circle', 'square', 'circle'],
                    colors: ['bg-red-500', 'bg-blue-500', 'bg-red-500', 'bg-blue-500', 'bg-red-500'],
                    nextType: 'square',
                    nextColor: 'bg-blue-500',
                    options: [
                        { type: 'square', color: 'bg-blue-500' },
                        { type: 'circle', color: 'bg-red-500' },
                        { type: 'triangle', color: 'bg-green-500' }
                    ]
                },
                {
                    seq: ['triangle', 'triangle', 'circle', 'triangle', 'triangle'],
                    colors: ['bg-green-500', 'bg-green-500', 'bg-yellow-400', 'bg-green-500', 'bg-green-500'],
                    nextType: 'circle',
                    nextColor: 'bg-yellow-400',
                    options: [
                        { type: 'triangle', color: 'bg-green-500' },
                        { type: 'circle', color: 'bg-yellow-400' },
                        { type: 'square', color: 'bg-blue-500' }
                    ]
                },
                {
                    seq: ['square', 'circle', 'triangle', 'square', 'circle'],
                    colors: ['bg-purple-500', 'bg-orange-500', 'bg-teal-500', 'bg-purple-500', 'bg-orange-500'],
                    nextType: 'triangle',
                    nextColor: 'bg-teal-500',
                    options: [
                        { type: 'square', color: 'bg-purple-500' },
                        { type: 'circle', color: 'bg-orange-500' },
                        { type: 'triangle', color: 'bg-teal-500' }
                    ]
                }
            ];

            const handleAnswer = (opt) => {
                if (feedback) return;
                const currentP = patterns[level];
                if (opt.type === currentP.nextType && opt.color === currentP.nextColor) {
                    setFeedback('correct');
                    setScore(s => s + 15);
                    setTimeout(() => {
                        if (level + 1 < patterns.length) {
                            setLevel(l => l + 1);
                            setFeedback('');
                        } else {
                            onComplete();
                        }
                    }, 1000);
                } else {
                    setFeedback('incorrect');
                    setTimeout(() => setFeedback(''), 1000);
                }
            };

            const currentP = patterns[level];

            return (
                <div className="text-center space-y-8">
                    <div className="flex justify-between items-center border-b border-indigo-100 pb-4">
                        <h2 className="text-lg font-bold text-slate-700 flex items-center"><span className="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center mr-2 text-sm">1</span>ç ´è§£è¦å¾‹</h2>
                        <div className="flex space-x-1">{patterns.map((_, i) => <div key={i} className={`w-2 h-2 rounded-full ${i <= level ? 'bg-indigo-500' : 'bg-slate-200'}`}></div>)}</div>
                    </div>

                    <div className="py-8 bg-indigo-50 rounded-2xl border-2 border-indigo-100 overflow-x-auto whitespace-nowrap px-4">
                        <div className="inline-flex items-center space-x-2 md:space-x-4">
                            {currentP.seq.map((type, i) => (
                                <div key={i} className="animate-in zoom-in duration-300" style={{animationDelay: `${i*100}ms`}}>
                                    <ShapeIcon type={type} color={currentP.colors[i]} size={12} />
                                </div>
                            ))}
                            <div className="w-12 h-12 rounded-lg border-2 border-dashed border-indigo-300 flex items-center justify-center bg-white/50 animate-pulse">
                                <span className="text-2xl font-bold text-indigo-300">?</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <p className="text-slate-500 mb-4 font-medium">ä¸‹ä¸€å€‹æ˜¯ä»€éº¼ï¼Ÿ</p>
                        <div className="flex justify-center space-x-6">
                            {currentP.options.map((opt, i) => (
                                <button key={i} onClick={() => handleAnswer(opt)} 
                                    className={`p-4 rounded-xl bg-white border-2 shadow-sm transition-all transform active:scale-90 hover:scale-105
                                    ${feedback === 'correct' && opt.type === currentP.nextType && opt.color === currentP.nextColor ? 'border-green-500 ring-2 ring-green-200' : 'border-slate-100 hover:border-indigo-300'}`}>
                                    <ShapeIcon type={opt.type} color={opt.color} size={16} />
                                </button>
                            ))}
                        </div>
                    </div>

                     <div className="h-8 flex justify-center items-center">
                        {feedback === 'correct' && <span className="text-green-600 font-bold flex items-center animate-bounce"><CheckCircle className="mr-2"/> ç­”å°äº†ï¼</span>}
                        {feedback === 'incorrect' && <span className="text-red-500 font-bold animate-shake">å†è§€å¯Ÿä¸€ä¸‹å–”ï¼</span>}
                    </div>
                </div>
            );
        };

        // --- 3. Interval Master (Planting Trees) ---
        const IntervalMaster = ({ score, setScore, onComplete }) => {
            const [trees, setTrees] = useState(2);
            const [showHint, setShowHint] = useState(false);
            const [feedback, setFeedback] = useState('');
            const [phase, setPhase] = useState('explore'); 

            // For the quiz part
            const [quizAns, setQuizAns] = useState(null);

            const intervals = trees - 1;
            const distancePerInterval = 5; 
            const totalDistance = intervals * distancePerInterval;

            const handleAddTree = () => {
                if (trees < 6) setTrees(t => t + 1);
            };

            const handleRemoveTree = () => {
                if (trees > 2) setTrees(t => t - 1);
            };

            const startQuiz = () => {
                setPhase('quiz');
            };

            const checkQuiz = (ans) => {
                if (ans === 5) { 
                     setFeedback('correct');
                     setScore(s => s + 20);
                } else {
                     setFeedback('incorrect');
                }
            };

            if (feedback === 'correct') {
                return (
                    <div className="text-center py-12 animate-in zoom-in">
                        <div className="inline-block p-4 bg-green-100 rounded-full mb-4 ring-8 ring-green-50"><Trees className="text-green-600" size={64} /></div>
                        <h2 className="text-2xl font-bold mb-2 text-slate-800">ç¨®æ¨¹é”äººï¼</h2>
                        <p className="text-slate-600 mb-8">ä½ å·²ç¶“æŒæ¡äº†é–“éš”çš„ç§˜å¯†</p>
                        <button onClick={onComplete} className="w-full bg-indigo-500 text-white py-4 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all">å‰å¾€ä¸‹ä¸€é—œï¼šæŸ¥è¡¨èˆ‡åˆ—è¡¨</button>
                    </div>
                );
            }

            return (
                <div className="text-center space-y-6">
                    <div className="flex justify-between items-center border-b border-indigo-100 pb-4">
                        <h2 className="text-lg font-bold text-slate-700 flex items-center"><span className="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center mr-2 text-sm">2</span>ç¨®æ¨¹å•é¡Œ</h2>
                    </div>

                    {phase === 'explore' ? (
                        <>
                            <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100 relative min-h-[160px] flex flex-col justify-end">
                                <div className="absolute top-4 left-4 text-left">
                                    <span className="bg-white px-2 py-1 rounded shadow-sm text-sm text-slate-500 font-bold">é€™æ¢è·¯é•· {totalDistance} å…¬å°º</span>
                                </div>
                                
                                <div className="relative h-16 w-full flex items-end justify-between px-4 border-b-4 border-slate-300">
                                    {[...Array(trees)].map((_, i) => (
                                        <div key={i} className="flex flex-col items-center animate-in slide-in-from-bottom duration-300">
                                            <Trees className="text-green-600 drop-shadow-md" size={32} />
                                            <div className="w-2 h-2 bg-slate-400 rounded-full -mb-1"></div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex justify-between px-6 -mt-3">
                                     {[...Array(intervals)].map((_, i) => (
                                        <div key={i} className="flex-1 text-center text-[10px] text-slate-400 border-t border-slate-300 pt-1">5m</div>
                                     ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                <div className="text-center">
                                    <p className="text-slate-500 text-sm">æ¨¹çš„æ•¸é‡</p>
                                    <p className="text-3xl font-black text-green-600">{trees}</p>
                                </div>
                                <div className="text-center">
                                    <p className="text-slate-500 text-sm">é–“éš”æ•¸é‡</p>
                                    <p className="text-3xl font-black text-blue-600">{intervals}</p>
                                </div>
                            </div>
                            
                            <p className="text-indigo-600 font-medium">ç™¼ç¾äº†å—ï¼Ÿæ¨¹æ¯”é–“éš”å¤š 1ï¼</p>

                            <div className="flex justify-center space-x-4">
                                <button onClick={handleRemoveTree} disabled={trees <= 2} className="w-12 h-12 rounded-full bg-slate-200 text-slate-600 font-bold text-xl disabled:opacity-50">-</button>
                                <button onClick={handleAddTree} disabled={trees >= 6} className="w-12 h-12 rounded-full bg-indigo-500 text-white font-bold text-xl disabled:opacity-50">+</button>
                            </div>

                            <button onClick={startQuiz} className="w-full py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl font-bold shadow-md mt-4">
                                æˆ‘æ‡‚äº†ï¼Œè€ƒè€ƒæˆ‘ï¼
                            </button>
                        </>
                    ) : (
                        <div className="animate-in slide-in-from-right">
                            <h3 className="text-xl font-bold text-slate-800 mb-6">å¦‚æœé€™æ¢è·¯ä¸Šç¨®äº† 6 æ£µæ¨¹ï¼Œè«‹å•æœƒæœ‰å¹¾å€‹é–“éš”ï¼Ÿ</h3>
                            <div className="grid grid-cols-1 gap-3">
                                {[5, 6, 7].map(ans => (
                                    <button key={ans} onClick={() => checkQuiz(ans)} 
                                        className={`p-4 rounded-xl border-2 text-xl font-bold transition-all ${feedback === 'incorrect' ? 'border-red-200 bg-red-50' : 'border-indigo-100 bg-white hover:border-indigo-300'}`}>
                                        {ans} å€‹é–“éš”
                                    </button>
                                ))}
                            </div>
                            {feedback === 'incorrect' && <p className="text-red-500 font-bold mt-4">æƒ³ä¸€æƒ³ï¼Œæ¨¹æ¯”é–“éš”å¤š 1 å–”ï¼</p>}
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW: Table & List Master (Reading & Making Tables) ---
        const TableMaster = ({ score, setScore, onComplete }) => {
            const [stage, setStage] = useState(0); // 0: Menu, 1: Train, 2: Coins
            const [feedback, setFeedback] = useState('');
            
            // --- Stage 0: Menu Logic ---
            const menuData = [
                { name: "æ¼¢å ¡", price: 45 },
                { name: "ä¸‰æ˜æ²»", price: 30 },
                { name: "è›‹é¤…", price: 25 },
                { name: "å¥¶èŒ¶", price: 15 }
            ];
            
            // --- Stage 1: Train Logic ---
            const stations = ["è˜‹æœç«™", "é¦™è•‰ç«™", "æ«»æ¡ƒç«™"];
            const fares = [
                ["-", 20, 50],
                [20, "-", 35],
                [50, 35, "-"]
            ];

            // --- Stage 2: Coins Logic ---
            const [coinLevel, setCoinLevel] = useState(0);
            const totalTarget = 40;
            const coinRows = [
                { tens: 4, fives: 0 },
                { tens: 3, fives: 2 },
                { tens: 2, fives: 4 },
                { tens: 1, fives: 6 },
                { tens: 0, fives: 8 }
            ];
            const coinLevels = [
                { q: "ç”¨ 3 å€‹ 10 å…ƒï¼Œéœ€è¦å¹¾å€‹ 5 å…ƒæ¹Šæˆ 40 å…ƒï¼Ÿ", highlightRow: 1, missingCol: 'fives', options: [1, 2, 3], ans: 2 },
                { q: "ç”¨ 6 å€‹ 5 å…ƒï¼Œæ˜¯ç”¨æ‰å¹¾å€‹ 10 å…ƒï¼Ÿ", highlightRow: 3, missingCol: 'tens', options: [1, 2, 0], ans: 1 },
                { q: "è«‹å•ä¸€å…±æœ‰å¹¾ç¨®æ¹Šæ³•ï¼Ÿ", highlightRow: -1, missingCol: 'none', options: [4, 5, 6], ans: 5 }
            ];

            const handleMenuAnswer = (ans) => {
                if (ans === 45) {
                    setFeedback('correct'); setScore(s => s + 10);
                    setTimeout(() => { setStage(1); setFeedback(''); }, 1500);
                } else {
                    setFeedback('incorrect'); setTimeout(() => setFeedback(''), 1000);
                }
            };

            const handleTrainAnswer = (ans) => {
                if (ans === 50) {
                    setFeedback('correct'); setScore(s => s + 15);
                    setTimeout(() => { setStage(2); setFeedback(''); }, 1500);
                } else {
                    setFeedback('incorrect'); setTimeout(() => setFeedback(''), 1000);
                }
            };

            const handleCoinAnswer = (val) => {
                if (feedback) return;
                const currLvl = coinLevels[coinLevel];
                if (val === currLvl.ans) {
                    setFeedback('correct'); setScore(s => s + 20);
                    setTimeout(() => {
                        if (coinLevel + 1 < coinLevels.length) {
                            setCoinLevel(l => l + 1); setFeedback('');
                        } else {
                            onComplete();
                        }
                    }, 1200);
                } else {
                    setFeedback('incorrect'); setTimeout(() => setFeedback(''), 1000);
                }
            };

            return (
                <div className="text-center space-y-6">
                    <div className="flex justify-between items-center border-b border-indigo-100 pb-4">
                        <h2 className="text-lg font-bold text-slate-700 flex items-center">
                            <span className="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center mr-2 text-sm">3</span>
                            æŸ¥è¡¨èˆ‡åˆ—è¡¨ ({stage === 0 ? "æ—©é¤åº—" : stage === 1 ? "ç«è»Šç«™" : "æ¹ŠéŒ¢"})
                        </h2>
                    </div>

                    {/* STAGE 0: MENU */}
                    {stage === 0 && (
                        <div className="animate-in slide-in-from-right">
                            <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-6">
                                <div className="flex items-center justify-center mb-4 text-orange-700 font-bold text-lg"><Coffee className="mr-2"/> å¿«æ¨‚æ—©é¤åº—</div>
                                <div className="grid grid-cols-4 gap-2 text-sm md:text-base">
                                    {menuData.map((item, i) => (
                                        <div key={i} className="bg-white p-2 rounded-lg shadow-sm border border-orange-100 flex flex-col items-center">
                                            <span className="text-slate-600 font-bold">{item.name}</span>
                                            <span className="text-orange-500 font-black">{item.price}å…ƒ</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-4">è«‹å•ä¸€å€‹æ¼¢å ¡å¤šå°‘éŒ¢ï¼Ÿ</h3>
                            <div className="flex justify-center gap-4">
                                {[25, 45, 15].map(opt => (
                                    <button key={opt} onClick={() => handleMenuAnswer(opt)} className="px-6 py-3 bg-white border-2 border-indigo-100 rounded-xl font-bold text-lg hover:border-indigo-400 shadow-sm">{opt} å…ƒ</button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* STAGE 1: TRAIN TABLE */}
                    {stage === 1 && (
                        <div className="animate-in slide-in-from-right">
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                                <div className="flex items-center justify-center mb-4 text-blue-700 font-bold text-lg"><Train className="mr-2"/> ç¥¨åƒ¹è¡¨ (å…ƒ)</div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm md:text-base bg-white rounded-lg shadow-sm">
                                        <thead>
                                            <tr className="bg-blue-100 text-blue-800">
                                                <th className="p-2 border-r border-blue-200">èµ·\è¿„</th>
                                                {stations.map(s => <th key={s} className="p-2">{s}</th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {stations.map((rowStation, rIdx) => (
                                                <tr key={rIdx} className="border-t border-slate-100">
                                                    <td className="p-2 font-bold text-blue-800 bg-blue-50 border-r border-blue-200">{rowStation}</td>
                                                    {fares[rIdx].map((fare, cIdx) => (
                                                        <td key={cIdx} className={`p-2 font-bold ${fare === '-' ? 'text-slate-300' : 'text-slate-700'}`}>
                                                            {rIdx === 0 && cIdx === 2 ? <span className="text-red-500 animate-pulse">{fare}</span> : fare}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-4">å¾ã€Œè˜‹æœç«™ã€åˆ°ã€Œæ«»æ¡ƒç«™ã€å¤šå°‘éŒ¢ï¼Ÿ</h3>
                            <div className="flex justify-center gap-4">
                                {[20, 35, 50].map(opt => (
                                    <button key={opt} onClick={() => handleTrainAnswer(opt)} className="px-6 py-3 bg-white border-2 border-indigo-100 rounded-xl font-bold text-lg hover:border-indigo-400 shadow-sm">{opt} å…ƒ</button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* STAGE 2: COINS (Original) */}
                    {stage === 2 && (
                        <div className="animate-in slide-in-from-right">
                             <div className="bg-green-50 p-4 rounded-xl border border-green-100 mb-6">
                                <div className="flex items-center justify-center mb-2 text-green-700 font-bold"><Coins className="mr-2" /> ç›®æ¨™ï¼šæ¹Šæˆ {totalTarget} å…ƒ</div>
                                <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="grid grid-cols-3 bg-slate-100 text-sm font-bold text-slate-600 py-2">
                                        <div>æ–¹æ³•</div><div>10å…ƒ</div><div>5å…ƒ</div>
                                    </div>
                                    {coinRows.map((row, idx) => {
                                        const currLvl = coinLevels[coinLevel];
                                        const isHighlight = idx === currLvl.highlightRow;
                                        const showTens = currLvl.missingCol === 'tens' && isHighlight ? '?' : row.tens;
                                        const showFives = currLvl.missingCol === 'fives' && isHighlight ? '?' : row.fives;
                                        return (
                                            <div key={idx} className={`grid grid-cols-3 py-2 border-t border-slate-100 text-lg ${isHighlight ? 'bg-yellow-100 text-indigo-700 font-bold' : 'text-slate-600'}`}>
                                                <div className="text-sm flex items-center justify-center text-slate-400">#{idx + 1}</div>
                                                <div>{showTens}</div><div>{showFives}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            <h3 className="text-lg font-bold text-slate-800 mb-4">{coinLevels[coinLevel].q}</h3>
                            <div className="flex justify-center gap-4">
                                {coinLevels[coinLevel].options.map((opt, i) => (
                                    <button key={i} onClick={() => handleCoinAnswer(opt)} 
                                        className={`w-20 h-14 rounded-xl border-2 text-xl font-bold shadow-sm transition-all active:scale-95
                                        ${feedback === 'correct' && opt === coinLevels[coinLevel].ans ? 'bg-green-500 text-white border-green-600' : 'bg-white border-indigo-100 text-indigo-600 hover:border-indigo-400'}`}>
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {feedback === 'correct' && <p className="text-green-600 font-bold text-lg animate-bounce mt-4">ç­”å°äº†ï¼</p>}
                    {feedback === 'incorrect' && <p className="text-red-500 font-bold text-lg mt-4 animate-shake">å†è©¦è©¦çœ‹ï¼</p>}
                </div>
            );
        };

        // --- 4. Quiz Mode ---
        const QuizMode = ({ score, setScore, onRestart }) => {
            const [idx, setIdx] = useState(0);
            const [finished, setFinished] = useState(false);
            const [feedback, setFeedback] = useState(null);
            
            const questions = [
                {
                    q: "è§€å¯Ÿè¦å¾‹ï¼š1, 3, 5, 1, 3, 5... ä¸‹ä¸€å€‹æ˜¯ï¼Ÿ",
                    options: ["1", "3", "5"],
                    ans: 0
                },
                {
                    q: "æŸ¥ç«è»Šç¥¨åƒ¹è¡¨æ™‚ï¼Œå¦‚æœæƒ³å¾Aç«™åˆ°Bç«™ï¼Œè¦æ€éº¼çœ‹ï¼Ÿ",
                    options: ["åªçœ‹ç¬¬ä¸€è¡Œ", "æ‰¾Aç«™é‚£ä¸€åˆ—å’ŒBç«™é‚£ä¸€è¡Œçš„äº¤å‰é»", "éš¨ä¾¿çŒœ"],
                    ans: 1
                },
                {
                    q: "ä¸‹é¢å“ªä¸€å€‹æ˜¯å¶æ•¸ï¼Ÿ",
                    options: ["103", "58", "21"],
                    ans: 1
                },
                {
                    q: "ç”¨åˆ—è¡¨è§£æ±ºå•é¡Œæœ€å¤§çš„å¥½è™•æ˜¯ä»€éº¼ï¼Ÿ",
                    options: ["å¯ä»¥ç•«ç•«", "ä¸æœƒæ¼æ‰ç­”æ¡ˆ", "ä¸ç”¨å‹•è…¦"],
                    ans: 1
                }
            ];

            const handleAnswer = (optIdx) => {
                if (feedback) return;
                if (optIdx === questions[idx].ans) {
                    setFeedback('correct');
                    setScore(s => s + 20);
                } else {
                    setFeedback('incorrect');
                }
                setTimeout(() => {
                    if (idx + 1 < questions.length) {
                        setIdx(i => i + 1);
                        setFeedback(null);
                    } else {
                        setFinished(true);
                    }
                }, 1500);
            };

            if (finished) return (
                <div className="text-center py-10 space-y-6 animate-in slide-in-from-bottom">
                    <div className="inline-block p-6 bg-yellow-100 rounded-full mb-4 shadow-inner"><Trophy size={80} className="text-yellow-600" /></div>
                    <h2 className="text-4xl font-bold text-slate-800">æ­å–œéé—œï¼</h2>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <p className="text-sm text-slate-400 uppercase tracking-widest mb-2">ç¸½å¾—åˆ†</p>
                        <p className="text-6xl font-black text-indigo-500 mb-4">{score}</p>
                        <p className="text-lg text-slate-600">ä½ æ˜¯è¦å¾‹åµæ¢å¤§å¸«ï¼</p>
                    </div>
                    <button onClick={onRestart} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold hover:bg-slate-700 flex items-center justify-center shadow-lg active:scale-95 transition-all"><RotateCcw className="mr-2" size={20} /> å†ç©ä¸€æ¬¡</button>
                </div>
            );

            return (
                <div className="py-2">
                    <div className="mb-6 flex justify-between items-center text-sm font-medium text-slate-400"><span className="bg-slate-100 px-3 py-1 rounded-full">ç¬¬ {idx + 1} / {questions.length} é¡Œ</span><span>åˆ†æ•¸: {score}</span></div>
                    <h3 className="text-xl font-bold text-slate-800 mb-6 leading-relaxed">{questions[idx].q}</h3>
                    <div className="space-y-3">
                        {questions[idx].options.map((opt, i) => (
                            <button key={i} onClick={() => handleAnswer(i)} disabled={!!feedback}
                             className={`w-full text-left p-4 rounded-xl text-lg font-medium border-2 transition-all active:scale-98 
                             ${feedback === 'correct' && i === questions[idx].ans ? 'bg-green-100 border-green-500 text-green-800' : 
                               feedback === 'incorrect' && i !== questions[idx].ans && feedback ? 'bg-red-50 border-red-200 text-red-800 opacity-50' : 
                               'bg-white border-slate-200 hover:border-indigo-400'}`}>
                                <div className="flex items-center">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-4 text-sm font-bold ${feedback === 'correct' && i === questions[idx].ans ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-500'}`}>{String.fromCharCode(65+i)}</div>
                                    {opt}
                                    {feedback === 'correct' && i === questions[idx].ans && <CheckCircle className="ml-auto text-green-600" />}
                                </div>
                            </button>
                        ))}
                    </div>
                    {feedback && <div className={`mt-6 text-center font-bold text-xl ${feedback === 'correct' ? 'text-green-500' : 'text-red-500'}`}>{feedback === 'correct' ? 'æ­£ç¢ºï¼' : 'ç­”éŒ¯å›‰...'}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PatternGame />);
    </script>
</body>
</html>